<!DOCTYPE html>



<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="alternate" href="/index.xml" type="application/rss+xml" title="Raytheon Pivotal Workshops">
		<link rel="icon" href="/favicon.ico">
		<title>Lab106 - Raytheon Pivotal Workshops</title>
		<link rel="stylesheet" href="/css/highlight.js.min.css">
		<link rel="stylesheet" href="/css/bootstrap.min.css">
		<link rel="stylesheet" href="/css/bootstrap-theme.css">
		<link rel="stylesheet" href="/css/pui-v2.0.0/pivotal-ui.css">
		<link rel="stylesheet" href="/css/theme.css">
		<link rel="stylesheet" href="/css/component.css">

<link rel="stylesheet"  href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/3.1.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="/css/bootie-docs.css">
		<script src="http://raytheon.cfapps.io/js/modernizr.custom.js"></script>

		
		<style type="text/css">
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
		</style>
	</head>

<body role="document">
	
	
	<nav class="navbar navbar-inverse navbar-fixed-top  ">
		<div class="container-fluid">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<div class="nav navbar-brand">
						
							<img class="nav pivotal-logo" src="/Pivotal_Teal.png"/>
						
				</div>
				<a class="navbar-brand navbar-txt" href="/">Raytheon Pivotal Workshops </a>
			</div>
			<div id="navbar" class="navbar-collapse collapse">
				<ul class="nav navbar-nav">
			
				
				
					
					<li ><a class="navbar-txt" href="/lab_requirements">Lab_requirements</a></li>
				
					
					<li ><a class="navbar-txt" href="/billerica_day1">Billerica_day1</a></li>
				
					
					<li ><a class="navbar-txt" href="/billerica_day2">Billerica_day2</a></li>
				
					
					<li ><a class="navbar-txt" href="/billerica_day3">Billerica_day3</a></li>
				
					
					<li ><a class="navbar-txt" href="/cloud_tig">Cloud_tig</a></li>
				
			
			
				<li class="dropdown">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Resources<span class="caret"></span></a>
					<ul class="dropdown-menu" role="menu">
					
                        <li><a target="_blank" href="https://www.youtube.com/playlist?list=PLAdzTan_eSPQ1fuLSBhyB4eEZF7JQM0Mx">All SpringOne Conference Videos</a></li>
                     
                        <li><a target="_blank" href="http://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry-dev/introduction">Try PCF on your Local Workstation with PCF Dev</a></li>
                     
                        <li><a target="_blank" href="http://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry/introduction">Try PCF on the Public Cloud</a></li>
                     
                        <li><a target="_blank" href="/CorporateOverview.pdf">Pivotal Overview</a></li>
                     
                        <li><a target="_blank" href="https://network.pivotal.io/products/pcfdev">PCF Dev</a></li>
                     
                        <li><a target="_blank" href="https://docs.pivotal.io/pivotalcf">PCF Documentation</a></li>
                     
                        <li><a target="_blank" href="https://docs.pivotal.io/pivotalcf/cf-cli/getting-started.html">CF CLI Documentation</a></li>
                     
                        <li><a target="_blank" href="https://www.git-scm.com">Git</a></li>
                     
                        <li><a target="_blank" href="https://try.github.io/levels/1/challenges/1">Git Lessons</a></li>
                     
                        <li><a target="_blank" href="http://platform.spring.io/platform/">Spring Platform</a></li>
                     
                        <li><a target="_blank" href="https://spring.io/docs">Spring Docs</a></li>
                     
                        <li><a target="_blank" href="http://start.spring.io/">Spring Initializer</a></li>
                     
                        <li><a target="_blank" href="https://spring.io/blog/2015/10/19/springone2gx-2015-replay-spring-cloud-at-netflix">Spring Cloud at Netflix</a></li>
                     
                        <li><a target="_blank" href="https://spring.io/blog/2015/07/14/microservices-with-spring">Microservices with Spring</a></li>
                     
                        <li><a target="_blank" href="https://spring.io/guides#tutorials">Spring Guides</a></li>
                     
                        <li><a target="_blank" href="https://network.pivotal.io/">Pivotal Network</a></li>
                     
                        <li><a target="_blank" href="http://docs.pivotal.io">Pivotal Documentation</a></li>
                     
					</ul>
				</li>
			
			
				<li class="dropdown">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Books<span class="caret"></span></a>
					<ul class="dropdown-menu" role="menu">
					
                        <li><a target="_blank" href="/books/Beyond_the_12-Factor_App_Pivotal.pdf">Beyond the 12-Factor App</a></li>
                     
                        <li><a target="_blank" href="/books/Migrating_to_Cloud-Native_App_Architectures_Pivotal.pdf">Migrating to Cloud Native Application Architectures</a></li>
                     
                        <li><a target="_blank" href="/books/Cloud_Foundry_The_Cloud_Native_Platform_Pivotal.pdf">Cloud Foundry The Cloud Native Platform</a></li>
                     
                        <li><a target="_blank" href="http://www.amazon.com/Cloud-Native-Java-Designing-Resilient/dp/1449374646">Cloud Native Java: Designing Resilient Systems with Spring Boot, Spring Cloud, and Cloud Foundry</a></li>
                     
					</ul>
				</li>
			
				
                        
				</ul>
			</div>
		</div>
	</nav>

<div class="container" style="width:95%; padding:5">
	<div class="row">

	    		
		<div class="doc-sidebar" style="width:30%; margin-top:0; float:right; padding:10px;">
			<div class="sidebar-module">
				
		    	<div class="tag-box bg-dark-11" style="padding:10px; margin:20px;">
		    	<h4 class="type-brand-3">Books</h4>
		    	<ul class="list-unstyled">
		    	
		    	<li><a target="_blank" href="/books/Beyond_the_12-Factor_App_Pivotal.pdf">Beyond the 12-Factor App</a><p></p></li>	
		    	
		    	<li><a target="_blank" href="/books/Migrating_to_Cloud-Native_App_Architectures_Pivotal.pdf">Migrating to Cloud Native Application Architectures</a><p></p></li>	
		    	
		    	<li><a target="_blank" href="/books/Cloud_Foundry_The_Cloud_Native_Platform_Pivotal.pdf">Cloud Foundry The Cloud Native Platform</a><p></p></li>	
		    	
		    	<li><a target="_blank" href="http://www.amazon.com/Cloud-Native-Java-Designing-Resilient/dp/1449374646">Cloud Native Java: Designing Resilient Systems with Spring Boot, Spring Cloud, and Cloud Foundry</a><p></p></li>	
		    	
		    	</ul>
		  	</div>
                        <div class="tag-box bg-dark-11" style="padding:10px; margin:20px;">
                        <h4 class="type-brand-3">Resources</h4>
                        <ul class="list-unstyled">
                        
                            <li><a target="_blank" href="https://www.youtube.com/playlist?list=PLAdzTan_eSPQ1fuLSBhyB4eEZF7JQM0Mx">All SpringOne Conference Videos</a><p></p></li>
                        
                            <li><a target="_blank" href="http://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry-dev/introduction">Try PCF on your Local Workstation with PCF Dev</a><p></p></li>
                        
                            <li><a target="_blank" href="http://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry/introduction">Try PCF on the Public Cloud</a><p></p></li>
                        
                            <li><a target="_blank" href="/CorporateOverview.pdf">Pivotal Overview</a><p></p></li>
                        
                            <li><a target="_blank" href="https://network.pivotal.io/products/pcfdev">PCF Dev</a><p></p></li>
                        
                            <li><a target="_blank" href="https://docs.pivotal.io/pivotalcf">PCF Documentation</a><p></p></li>
                        
                            <li><a target="_blank" href="https://docs.pivotal.io/pivotalcf/cf-cli/getting-started.html">CF CLI Documentation</a><p></p></li>
                        
                            <li><a target="_blank" href="https://www.git-scm.com">Git</a><p></p></li>
                        
                            <li><a target="_blank" href="https://try.github.io/levels/1/challenges/1">Git Lessons</a><p></p></li>
                        
                            <li><a target="_blank" href="http://platform.spring.io/platform/">Spring Platform</a><p></p></li>
                        
                            <li><a target="_blank" href="https://spring.io/docs">Spring Docs</a><p></p></li>
                        
                            <li><a target="_blank" href="http://start.spring.io/">Spring Initializer</a><p></p></li>
                        
                            <li><a target="_blank" href="https://spring.io/blog/2015/10/19/springone2gx-2015-replay-spring-cloud-at-netflix">Spring Cloud at Netflix</a><p></p></li>
                        
                            <li><a target="_blank" href="https://spring.io/blog/2015/07/14/microservices-with-spring">Microservices with Spring</a><p></p></li>
                        
                            <li><a target="_blank" href="https://spring.io/guides#tutorials">Spring Guides</a><p></p></li>
                        
                            <li><a target="_blank" href="https://network.pivotal.io/">Pivotal Network</a><p></p></li>
                        
                            <li><a target="_blank" href="http://docs.pivotal.io">Pivotal Documentation</a><p></p></li>
                        
                        </ul>
                        </div>
			</div>
		</div>
		


		<div class="col-sm-8 doc-main" style="width:70%; float:left; padding:30px;">
			<main role="main">
				<article>
					<a id="title"></a>
					<div class="doc-entry-meta">
					</div>
					<section>
						<div class="sect1">
<h2 id="_lab_9_configuration_and_steeltoe_config_server_client">Lab 9 - Configuration and Steeltoe Config Server Client</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_code_goal_code"><code>Goal</code></h2>
<div class="sectionbody">
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>The goals for this lab are to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Understand ASP.NET Core Configuration.</p>
</li>
<li>
<p>Understand ASP.NET Core Enironments</p>
</li>
<li>
<p>Understand ASP.NET Core Options services.</p>
</li>
<li>
<p>Use Environments to have seperate configuration for <code>Development</code> and <code>Production</code>.</p>
</li>
<li>
<p>Use Options to configure the <code>FortuneServiceClient</code> with the address of the <code>Fortune Teller Service</code></p>
</li>
<li>
<p>Use Spring Cloud Config Server to centralize configurations</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Approximate time: 1 hour</p>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The completed code for this lab can be found at <code>$COURSE_HOME/dotnet/lab07/</code>.
</td>
</tr>
</table>
</div>
<div class="quoteblock abstract">
<blockquote>
<div class="paragraph">
<p>In this lab we will continue to add functionality to the Fortune Teller application.
We will explore how to use the ASP.NET Core Configuration services and how to add the Spring Cloud Config Server as a source of configuration data using the Steeltoe Config Server provider.</p>
</div>
<div class="paragraph">
<p>If you started with the <em>FortuneTeller.sln</em>, and completed Lab06, the app in its current state is still not fully functional:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The <code>Fortune Teller Service</code> uses a backend in-memory datastore to hold Fortunes.</p>
</li>
<li>
<p>The <code>Fortune Teller Service</code> serves up random fortunes from the datastore.</p>
</li>
<li>
<p>The <code>Fortune Teller UI</code> uses a <code>FortuneServiceClient</code> but it doesn&#8217;t know how to communicate with the <code>Fortune Teller Service</code> yet.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For some background information on ASP.NET Core Configuration, have a look at this <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration">documentation</a>.</p>
</div>
<div class="paragraph">
<p>For some background information on ASP.NET Core Environments, have a look at this <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/environments">documentation</a>.</p>
</div>
<div class="paragraph">
<p>And finally, for some background information on ASP.NET Core Options, have a look at this <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration#options-config-objects">documentation</a>.</p>
</div>
</blockquote>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_open_visual_studio_solution">Open Visual Studio Solution</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start Visual Studio and open the solution/folder you wish to use:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><em>Workshop/Session-03/Lab07.sln</em> if you want to start with finished code.</p>
</li>
<li>
<p><em>Workshop/FortuneTeller/FortuneTeller.sln</em> if you are writing code from scratch.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_understanding_asp_net_core_configuration_environment_and_options">Understanding ASP.NET Core Configuration, Environment and Options</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Expand the <code>Fortune-Teller-UI</code> project</p>
</li>
<li>
<p>Open and examine <code>Startup.cs</code>, as this is where the configuration is built</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Examine <code>ConfigurationBuilder</code> and <code>SetBasePath</code></p>
</li>
<li>
<p>Examine <code>AddJsonFile()</code> methods.  These are adding Configuration sources to the <code>ConfigurationBuilder</code>.</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Notice the  <code>AddEnvironmentVariables()</code> as another provider added to builder.</p>
</li>
<li>
<p>Understand Environments (e.g. Development, Staging, etc) and <code>IHostingEnvironment.EnvironmentName</code></p>
</li>
<li>
<p>Understand setting Environments using <code>ASPNETCORE_ENVIRONMENT</code> and point out <code>launchSettings.json</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Examine the arguments to <code>AddJsonFile</code></p>
</li>
<li>
<p>Notice <code>appsettings-<a href="#EnvironmentName">[EnvironmentName]</a>.json</code> is not present.</p>
</li>
<li>
<p>Notice <code>Configuration = builder.Build()</code>. It actually builds the configuration at this point.</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Understand how one providers configuration values can override the others.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Open <code>appsettings.json</code>. Current contents is used to configuring logging.</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Notice <code>loggerFactory.AddConsole(&#8230;&#8203;)</code> in <code>Configure</code> method.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_use_different_configurations_for_development_and_production">Use different configurations for development and production.</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this exercise we will be creating a <code>appsettings-Development.json</code> file that will hold the configuration data for when we are running in <code>Development</code> mode.</p>
</div>
<div class="sect2">
<h3 id="_step_01_add_appsettings_development_json_configuration_source">Step 01 - Add appsettings-Development.json configuration source</h3>
<div class="paragraph">
<p>Here we add a JSON configuration file to each project which contains configuration parameters specific to when we are running in <code>Development</code> mode.
Basically, we are going to change all logging to <code>Debug</code> when running the app in <code>Development</code> mode.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Expand the <code>Fortune-Teller-UI</code> project</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Add new json file <code>appsettings-Development.json</code> if it doesn&#8217;t already exist.</p>
</li>
<li>
<p>Copy contents of <code>appsettings.json</code> to <code>appsetttings-Development.json</code>.</p>
</li>
<li>
<p>Modify all <code>LogLevels</code> to <code>Debug</code>.</p>
</li>
<li>
<p>Then also add <code>"Fortune_Teller_Service": "Debug"</code> and <code>"Fortune_Teller_UI": "Debug"</code> to end of the file.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Expand <code>Fortune-Teller-Service</code> project</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Do the same steps as above.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Save all files and when you&#8217;re done both projects <code>appsettings-Development.json</code> files should look like:</p>
<div class="listingblock">
<div class="content">
<pre>{
  "Logging": {
    "IncludeScopes": false,
    "LogLevel": {
      "Default": "Debug",
      "System": "Debug",
      "Microsoft": "Debug",
      "Fortune_Teller_Service": "Debug",
      "Fortune_Teller_UI": "Debug"
    }
  }
}</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_step_02_run_locally">Step 02 - Run Locally</h3>
<div class="paragraph">
<p>At this point you should be ready to run both Fortune-Tellers locally and test:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Using the skills you picked up from Lab05, run the apps from VS2017 and/or from the command line.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>CTRL-F5 or F5 in VS2017</p>
</li>
<li>
<p><code>dotnet run --server.urls <a href="http://*:5000" class="bare">http://*:5000</a></code> - Fortune-Teller-Service</p>
</li>
<li>
<p><code>dotnet run --server.urls <a href="http://*:5555" class="bare">http://*:5555</a></code> - Fortune-Teller-UI</p>
</li>
</ol>
</div>
</li>
<li>
<p>Modify <code>ASPNETCORE_ENVIRONMENT</code> in <code>launchsettings.json</code> for each project and verify you are getting the appropriate logging information when you run the application.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Hint: Amoung other places, look at the <code>FortunesController</code> action methods for logging calls.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Change the log levels in  <code>appsettings-Development.json</code> while <code>Fortune-Teller-Service</code> and <code>Fortune-Teller-UI</code> are running to see if changes are picked up.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_use_options_to_configure_the_fortuneserviceclient">Use Options to configure the FortuneServiceClient</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this exercise we will be using the ASP.NET Core Configuration and Options services to inject configuration data into the <code>FortuneServiceClient</code>.
The configuration data will be put in the Fortune-Teller-UIs <code>appsettings.json</code> file, as that&#8217;s what uses the <code>FortuneServiceClient</code>.
We will use the already existing <code>FortuneServiceConfig</code> class to hold the config data from <code>appsettings.json</code>.</p>
</div>
<div class="sect2">
<h3 id="_step_01_add_configuration_data_to_appsettings_json">Step 01 - Add configuration data to appsettings.json</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Expand the <code>Common\Services</code> folder and open <code>FortuneServiceConfig</code>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Notice the POCO has four properties for holding the configuration data:</p>
<div class="ulist">
<ul>
<li>
<p>Scheme</p>
</li>
<li>
<p>Address</p>
</li>
<li>
<p>RandomFortunePath</p>
</li>
<li>
<p>AllFortunesPath</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Expand the <code>Fortune-Teller-UI</code> project</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Open up <code>appsettings.json</code> and add the following to the file:</p>
<div class="listingblock">
<div class="content">
<pre>"fortuneService": {
    "scheme": "http",
    "address":"localhost:5000",
    "randomFortunePath": "api/fortunes/random",
    "allFortunesPath": "api/fortunes/all"
  }</pre>
</div>
</div>
<div class="paragraph">
<p><br>
Notice that we are adding a section named <code>fortuneService</code> and then adding sub-items with names that match the <code>FortuneServiceConfig</code> POCO properties.</p>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_step_02_add_fortuneserviceconfig_to_container">Step 02 - Add FortuneServiceConfig to Container</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Expand the <code>Fortune-Teller-UI</code> project</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Open <code>Startup</code> class and locate the <code>Configure()</code> method - the one that configures the container!</p>
</li>
<li>
<p>Add the call to <code>Configure&lt;FortuneServiceConfig&gt;(&#8230;&#8203;)</code></p>
<div class="listingblock">
<div class="content">
<pre>public void ConfigureServices(IServiceCollection services)
{
    services.AddSingleton&lt;IFortuneService, FortuneServiceClient&gt;();

    services.Configure&lt;FortuneServiceConfig&gt;(Configuration.GetSection("fortuneService"));

    // Add framework services.
    services.AddMvc();
}</pre>
</div>
</div>
<div class="paragraph">
<p><br>
The changes to this method actually cause several things to happen:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It uses the configuration we built in the <code>Startup</code> constructor and gets the <code>fortuneService</code> section from it.</p>
</li>
<li>
<p>It passes that configuration data into the <code>Configure&lt;FortuneServiceConfig&gt;</code> which binds the values from the configuration into the properties in <code>FortuneServiceConfig</code>.</p>
</li>
<li>
<p>And, finally it will make <code>FortuneServiceConfig</code> available for inject as a <code>IOptions&lt;FortuneServiceConfig&gt;</code> or <code>IOptionsSnapshot&lt;FortuneServiceConfig&gt;</code>.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_step_03_update_fortuneserviceclient_to_use_fortuneserviceconfig">Step 03 - Update FortuneServiceClient to use FortuneServiceConfig</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Expand the <code>Fortune-Teller-UI</code> project</p>
</li>
<li>
<p>Open <code>FortuneServiceClient</code> class and add the field and modify the constructor as follows:</p>
<div class="listingblock">
<div class="content">
<pre>IOptionsSnapshot&lt;FortuneServiceConfig&gt; _config;
public FortuneServiceClient(IOptionsSnapshot&lt;FortuneServiceConfig&gt; config, ILogger&lt;FortuneServiceClient&gt; logger)
{
    _logger = logger;
    _config = config;
}</pre>
</div>
</div>
</li>
<li>
<p>Modify <code>AllFortunesAsync()</code> and <code>RandomFortuneAsync()</code> to make the calls to the <code>Fortune Teller Service</code>:</p>
<div class="listingblock">
<div class="content">
<pre>public async Task&lt;List&lt;Fortune&gt;&gt; AllFortunesAsync()
{
    return await HandleRequest&lt;List&lt;Fortune&gt;&gt;(_config.Value.AllFortunesURL());
}

public async Task&lt;Fortune&gt; RandomFortuneAsync()
{
    return await HandleRequest&lt;Fortune&gt;(_config.Value.RandomFortuneURL());
}</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_step_04_run_locally">Step 04 - Run Locally</h3>
<div class="paragraph">
<p>At this point you should be ready to run both Fortune-Tellers locally and test.
The <code>Fortune-Teller-UI</code> should now be fetching Fortunes from the <code>Fortune-Teller-Service</code>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Using the skills you picked up from Lab05, run the apps from VS2017 and/or from the command line.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>CTRL-F5 or F5 in VS2017</p>
</li>
<li>
<p><code>dotnet run --server.urls <a href="http://*:5000" class="bare">http://*:5000</a></code> - Fortune-Teller-Service</p>
</li>
<li>
<p><code>dotnet run --server.urls <a href="http://*:5555" class="bare">http://*:5555</a></code> - Fortune-Teller-UI</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_use_spring_cloud_config_server_as_a_configuration_source">Use Spring Cloud Config Server as a Configuration source</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this exercise we will startup a Spring Cloud Config Server locally and move some of our configuration data to the locally running Config Server.
We also make the changes necessary to use the Config Server from our application. Specifically, we will use the Steeltoe Config Server client to pull config data from the Config Server.</p>
</div>
<div class="paragraph">
<p>For some background information on Spring Cloud Config Server, have a look at this <a href="http://cloud.spring.io/spring-cloud-static/Camden.SR4/#_spring_cloud_config">documentation</a>.
For some background information on Steeltoe Config Server client, have a look at this <a href="https://github.com/SteeltoeOSS/Configuration/tree/master/src/Steeltoe.Extensions.Configuration.ConfigServer">documentation</a>.
For other samples (ASP.NET Core and 4.x) that use the Steeltoe Config Server client, have a look <a href="https://github.com/SteeltoeOSS/Samples/tree/master/Configuration">here</a>.</p>
</div>
<div class="sect2">
<h3 id="_step_01_run_spring_cloud_config_server_locally">Step 01 - Run Spring Cloud Config Server Locally</h3>
<div class="paragraph">
<p>Here we do the steps to setup and run a Spring Cloud Config Server locally so its easier to develop and test with.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To run Config Server you will need Java JDK installed on your machine and the JAVA_HOME environment variable set to the JDK&#8217;s installed location:</p>
<div class="listingblock">
<div class="content">
<pre>e.g. JAVA_HOME=C:\Program Files\Java\jdk1.8.0_112 or equivalent on Linux/Mac</pre>
</div>
</div>
</li>
<li>
<p>Open a command window.</p>
</li>
<li>
<p>Change directory to <em>Workshop/ConfigServer</em></p>
<div class="listingblock">
<div class="content">
<pre>&gt; cd Workshop\ConfigServer</pre>
</div>
</div>
</li>
<li>
<p>Startup the config server</p>
<div class="listingblock">
<div class="content">
<pre>&gt; mvnw spring-boot:run</pre>
</div>
</div>
<div class="paragraph">
<p><br>
It will start up on port 8888 and serve configuration data from "file:./steeltoe/config-repo". This will be the directory <em>Workshop/ConfigServer/steeltoe/config-repo</em>.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_step_02_add_steeltoe_config_server_client_nuget">Step 02 - Add Steeltoe Config Server Client Nuget</h3>
<div class="paragraph">
<p>Here we add the appropriate Steeltoe Config Server client Nuget to each Fortune Teller application.
When targeting Spring Cloud Services on PCF, we use the Nuget: <code>Pivotal.Extensions.Configuration.ConfigServer</code>.
When targeting Spring Cloud Open Source, we can use Nuget: <code>Steeltoe.Extensions.Configuration.ConfigServer</code>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Expand the <code>Fortune-Teller-UI</code> and <code>Fortune-Teller-Service</code> projects.</p>
</li>
<li>
<p>Open <code>csproj</code> for EACH project and add the<code>PackageReference</code>:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Include="Pivotal.Extensions.Configuration.ConfigServer" Version="1.0.0"</p>
<div class="listingblock">
<div class="content">
<pre>  &lt;ItemGroup&gt;
   .......
    &lt;PackageReference Include="Microsoft.EntityFrameworkCore" Version="1.0.3" /&gt;
    &lt;PackageReference Include="Microsoft.EntityFrameworkCore.InMemory" Version="1.0.3" /&gt;
    &lt;PackageReference Include="Pivotal.Extensions.Configuration.ConfigServer" version="1.0.0" /&gt;
  &lt;/ItemGroup&gt;</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Save each <code>csproj</code> and ensure a dotnet restore is done.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_step_03_add_steeltoe_config_server_provider_to_configurationbuilder">Step 03 - Add Steeltoe Config Server provider to ConfigurationBuilder</h3>
<div class="paragraph">
<p>Here we need to use the Config Server client to retrieve the configuration from the Config Server.
We do this bby adding it as another provider to the Configuration Builder setup.
Notice that we add the provider after the <code>AddJsonFile()</code> calls for two reasons:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Config Server client will then be able to pickup its configuration from <code>appsettings.json</code> or <code>appsettings-Development.json</code>.</p>
</li>
<li>
<p>We want the ability for the config values retrieved from the Config Server to 'override' any values in the json files.</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Expand the <code>Fortune-Teller-UI</code> and <code>Fortune-Teller-Service</code> projects.</p>
</li>
<li>
<p>Open <code>Startup.cs</code> in each project and add the call <code>AddConfigServer(env)</code>to the <code>ConfigurationBuilder</code></p>
<div class="listingblock">
<div class="content">
<pre>    var builder = new ConfigurationBuilder()
        .SetBasePath(env.ContentRootPath)
        .AddJsonFile("appsettings.json", optional: true, reloadOnChange: true)
        .AddJsonFile($"appsettings.{env.EnvironmentName}.json", optional: true, reloadOnChange: true)
        .AddConfigServer(env)
        .AddEnvironmentVariables();

        Configuration = builder.Build();
    ......</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_step_04_configure_the_config_server_client">Step 04 - Configure the Config Server Client</h3>
<div class="paragraph">
<p>Once we have the Config Server client added to the <code>ConfigurationBuilder</code>, we next need to configure the client.
At a minimum we need to tell the client what URL to use to make request of the Config Server and what configuration data to request.
We do this by adding the following to the <code>appsettings.json</code> files in each project:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Modify the <code>Fortune-Teller-Services</code> <code>appsettings.json</code> file to include the following:</p>
<div class="listingblock">
<div class="content">
<pre>{
  "Logging": {
    "IncludeScopes": false,
    "LogLevel": {
      "Default": "Information",
      "System": "Information",
      "Microsoft": "Information"
    }
  },
 "spring": {
    "application": {
      "name": "fortuneService"
    },
    "cloud": {
      "config": {
        "uri": "http://localhost:8888"
      }
    }
  }
 }</pre>
</div>
</div>
</li>
<li>
<p>Also, modify the <code>Fortune-Teller-UI</code> <code>appsettings.json</code> file to include the following:</p>
<div class="listingblock">
<div class="content">
<pre>{
  "Logging": {
    "IncludeScopes": false,
    "LogLevel": {
      "Default": "Information",
      "System": "Information",
      "Microsoft": "Information"
    }
  },
 "fortuneService": {
   "scheme": "http",
   "address":"localhost:5000",
   "randomFortunePath": "api/fortunes/random",
   "allFortunesPath": "api/fortunes/all"
 },
  "spring": {
    "application": {
      "name": "fortuneui"
    },
    "cloud": {
      "config": {
        "uri": "http://localhost:8888"
      }
    }
  }
}</pre>
</div>
</div>
<div class="paragraph">
<p><br>
For more detail on what configuration parameters can be used with the Steeltoe Config Server Client, have a look at <a href="https://github.com/SteeltoeOSS/Configuration/blob/master/src/Steeltoe.Extensions.Configuration.ConfigServer/ConfigServerClientSettings.cs">this</a></p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Once complete, you should be ready to run both and they should both fetch any configuration data from the Config Server.
But, of course we haven&#8217;t put anything in the Config Servers directory <em>file:./steeltoe/config-repo</em> , the directory its using for its data.
That&#8217;s what we&#8217;ll do in the next step.</p>
</div>
</div>
<div class="sect2">
<h3 id="_step_05_centralize_configuration_data">Step 05 - Centralize configuration data</h3>
<div class="paragraph">
<p>In this step we move some of the configuration data from the <code>appsettings</code> files to files in the <em>file:./steeltoe/config-repo</em>; the directory the Config Server uses to serve configuration data.
Notice that in <code>appsettings.json</code> there are some configuration settings for logging that are common to both Fortune_Tellers.
Specifically the section on logging:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{
  "Logging": {
    "IncludeScopes": false,
    "LogLevel": {
      "Default": "Information",
      "System": "Information",
      "Microsoft": "Information"
    }
  },
  "spring": {
   .....
}</pre>
</div>
</div>
<div class="paragraph">
<p>So we will go ahead and centralize that in a YAML file <code>application.yml</code> in the <em>file:./steeltoe/config-repo</em> directory.
Use your favorite editor to create the file and put the following into it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Logging:
  IncludeScopes: false
  LogLevel:
    Default: Information
    System: Information
    Microsoft: Information</pre>
</div>
</div>
<div class="paragraph">
<p>Next, remove this section from <code>appsettings.json</code> in both projects.</p>
</div>
<div class="paragraph">
<p>Also notice that the contents of <code>appsettings-Development.json</code> is common for both Fortune_Tellers.
So we will also centralize that in a YAML file <code>application-Development.yml</code> in the <em>file:./steeltoe/config-repo</em> directory.
So again,  use your favorite editor to create the file and put the following into it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Logging:
  IncludeScopes: false
  LogLevel:
    Default: Debug
    System: Debug
    Microsoft: Debug
    Fortune_Teller_Service: Debug
    Fortune_Teller_UI: Debug</pre>
</div>
</div>
<div class="paragraph">
<p>Next, remove the contents from <code>appsettings-Development.json</code> in both projects.</p>
</div>
<div class="paragraph">
<p>Then finally, in the <code>appsettings.json</code> file for Fortune-Teller-UI there is the <code>fortuneService</code> section that we would certainly like to manage centrally.
So lets move that content to a YAML file named <code>fortuneui.yml</code> in the <em>file:./steeltoe/config-repo</em> directory.
Again use your favorite editor to create the file and put the following into it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>fortuneService:
  scheme: http
  address: localhost:5000
  randomFortunePath: api/fortunes/random
  allFortunesPath: api/fortunes/all</pre>
</div>
</div>
<div class="paragraph">
<p>Next, remove this section from <code>appsettings.json</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_step_06_run_locally">Step 06 - Run Locally</h3>
<div class="paragraph">
<p>At this point you should be ready to run both Fortune-Tellers locally and test.
Every thing should work as it did before, even though now much of the configuration is coming from the Config Server.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Using the skills you picked up from Lab05, run the apps from VS2017 and/or from the command line.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>CTRL-F5 or F5 in VS2017</p>
</li>
<li>
<p><code>dotnet run --server.urls <a href="http://*:5000" class="bare">http://*:5000</a></code> - Fortune-Teller-Service</p>
</li>
<li>
<p><code>dotnet run --server.urls <a href="http://*:5555" class="bare">http://*:5555</a></code> - Fortune-Teller-UI</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_to_cloud_foundry">Deploy to Cloud Foundry</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_step_01_setup_config_server">Step 01 - Setup Config Server</h3>
<div class="paragraph">
<p>You must first create an instance of the Config Server service in your org/space.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open a command window.</p>
</li>
<li>
<p>Change directory to your starting lab point:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>_Workshop/Session-03/Lab07 &#8230;&#8203;. if you started with finished code.</p>
</li>
<li>
<p>_Workshop/FortuneTeller/ &#8230;&#8203;. if you are writing code from scratch.</p>
<div class="listingblock">
<div class="content">
<pre>&gt; e.g cd Workshop\FortuneTeller</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Optional: Create your own github repo to hold the Config Server data</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Fork github repository <a href="https://github.com/SteeltoeOSS/workshop-config-repo" class="bare">https://github.com/SteeltoeOSS/workshop-config-repo</a></p>
</li>
<li>
<p>Open the <code>config-server.json</code> file in the Solution folder.</p>
</li>
<li>
<p>Modify it to point to the github repo you just forked.</p>
</li>
<li>
<p>Add the contents of <em>file:./steeltoe/config-repo</em> to the github repo you just created. Note you will have to modify the files</p>
</li>
</ol>
</div>
</li>
<li>
<p>Using the command window, create an instance of the config server and set its configuration up with a github repo referenced in the config-server.json file:</p>
<div class="listingblock">
<div class="content">
<pre>&gt; Windows: cf create-service p-config-server standard myConfigServer -c .\config-server.json

&gt; Mac/Linux: cf create-service p-config-server standard myConfigServer -c config-server.json</pre>
</div>
</div>
</li>
<li>
<p>Wait for the service to become available:</p>
<div class="listingblock">
<div class="content">
<pre>&gt; cf services</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_step_02_push_to_cloud_foundry">Step 02 - Push to Cloud Foundry</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Examine the <code>manfest.yml</code> files for both projects and notice <code>services</code> addition shown below.
You need to make this change in your <code>manifest.yml</code> before you push to Cloud Foundry.
Also, notice the <code>ASPNETCORE_ENVIRONMENT</code> setting.
Feel free to change that to <code>Development</code> if you want to turn on debug logging.</p>
<div class="listingblock">
<div class="content">
<pre>---
applications:
- name: fortuneService
  random-route: true
  env:
    ASPNETCORE_ENVIRONMENT: Production
  services:
   - myConfigServer

---
applications:
- name: fortuneui
  random-route: true
  env:
    ASPNETCORE_ENVIRONMENT: Production
  services:
   - myConfigServer</pre>
</div>
</div>
</li>
<li>
<p>Using the skills you picked up from Lab05, publish and push both components to a Linux cell on Cloud Foundry.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Pushing Fortune Teller Service - If you are using the finished lab code on Windows:</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p><code>cd Workshop/Session-02/Lab07/Fortune-Teller-Service</code></p>
</li>
<li>
<p><code>dotnet restore</code></p>
</li>
<li>
<p><code>dotnet build </code></p>
</li>
<li>
<p><code>dotnet publish -o %CD%\publish -f netcoreapp1.1 -r ubuntu.14.04-x64</code></p>
</li>
<li>
<p><code>cf push -f manifest.yml -p .\publish</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Pushing Fortune Teller Service - If you are using the finished lab code on Mac/Linux:</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p><code>cd Workshop/Session-02/Lab07/Fortune-Teller-Service</code></p>
</li>
<li>
<p><code>dotnet restore</code></p>
</li>
<li>
<p><code>dotnet build </code></p>
</li>
<li>
<p><code>dotnet publish -f netcoreapp1.1 -r ubuntu.14.04-x64 -o $PWD/publish</code></p>
</li>
<li>
<p><code>cf push -f manifest.yml -p publish</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Pushing Fortune Teller UI - If you are using the finished lab code on Windows:</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p><code>cd Workshop/Session-02/Lab07/Fortune-Teller-UI</code></p>
</li>
<li>
<p><code>dotnet restore</code></p>
</li>
<li>
<p><code>dotnet build </code></p>
</li>
<li>
<p><code>dotnet publish -o %CD%\publish -f netcoreapp1.1 -r ubuntu.14.04-x64</code></p>
</li>
<li>
<p><code>cf push -f manifest.yml -p .\publish</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Pushing Fortune Teller UI - If you are using the finished lab code on Mac/Linux:</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p><code>cd Workshop/Session-02/Lab07/Fortune-Teller-UI</code></p>
</li>
<li>
<p><code>dotnet restore</code></p>
</li>
<li>
<p><code>dotnet build </code></p>
</li>
<li>
<p><code>dotnet publish -f netcoreapp1.1 -r ubuntu.14.04-x64 -o $PWD/publish</code></p>
</li>
<li>
<p><code>cf push -f manifest.yml -p publish</code></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_step_03_configure_for_cloudfoundry">Step 03 - Configure for CloudFoundry</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Try hitting the <code>Fortune Teller UI</code> and notice that it fails to communicate with the <code>Fortune Teller Service</code>.
Why &#8594; Remember the <code>fortuneService</code> configuration is pointing to <code>localhost:5000</code>. In the next lab, we will fix this by making use of the Netflix Eureka Discovery service.</p>
</li>
<li>
<p>Optional: If you&#8217;re using your own github repo to hold Config Server data, modify the <code>fortuneService</code> configuration to make it work and restart the UI.
Some hints:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Check the application fortuneService URL in the Route tab within Pivotal Cloud Foundry apps manager</p>
</li>
<li>
<p>Update fortuneui.yml in your github repo and restart fortuneui application</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>

					</section>
				</article>
			</main>
		</div> 
	</div> 
</div>

		




<hr />
<div class="container">
	<div class="row">
		<div class="col-sm-8">
			<p class="doc-footer-em"><a href="#">Back to TOP</a></p>
		</div>
	</div>

</div> 
          
<footer class="doc-footer">
        <span>Last Updated on  2016-03-23 19:58:14 -0400 EDT  </span>
	
	<p>Copyright (c) 2015, Pivotal; All rights reserved.</p>
</footer>



<script src="/js/jquery-1.11.2.min.js"></script>
<script src="/js/bootstrap.min.js"></script>

<script src="/js/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script src="/js/ie10-viewport-bug-workaround.js"></script>
		<script>
			var $event = $.event,
			$special,
			resizeTimeout;
			$special = $event.special.debouncedresize = {
				setup: function() {
					$( this ).on( "resize", $special.handler );
				},
				teardown: function() {
					$( this ).off( "resize", $special.handler );
				},
				handler: function( event, execAsap ) {
					var context = this,
						args = arguments,
						dispatch = function() {
							event.type = "debouncedresize";
							$event.dispatch.apply( context, args );
						};
					if ( resizeTimeout ) {
						clearTimeout( resizeTimeout );
					}
					execAsap ?
						dispatch() :
						resizeTimeout = setTimeout( dispatch, $special.threshold );
				},
				threshold: 250
			};
			var BLANK = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
			$.fn.imagesLoaded = function( callback ) {
				var $this = this,
					deferred = $.isFunction($.Deferred) ? $.Deferred() : 0,
					hasNotify = $.isFunction(deferred.notify),
					$images = $this.find('img').add( $this.filter('img') ),
					loaded = [],
					proper = [],
					broken = [];
				if ($.isPlainObject(callback)) {
					$.each(callback, function (key, value) {
						if (key === 'callback') {
							callback = value;
						} else if (deferred) {
							deferred[key](value);
						}
					});
				}
				function doneLoading() {
					var $proper = $(proper),
						$broken = $(broken);
					if ( deferred ) {
						if ( broken.length ) {
							deferred.reject( $images, $proper, $broken );
						} else {
							deferred.resolve( $images );
						}
					}
					if ( $.isFunction( callback ) ) {
						callback.call( $this, $images, $proper, $broken );
					}
				}
				function imgLoaded( img, isBroken ) {
					if ( img.src === BLANK || $.inArray( img, loaded ) !== -1 ) {
						return;
					}
					loaded.push( img );
					if ( isBroken ) {
						broken.push( img );
					} else {
						proper.push( img );
					}
					$.data( img, 'imagesLoaded', { isBroken: isBroken, src: img.src } );
					if ( hasNotify ) {
						deferred.notifyWith( $(img), [ isBroken, $images, $(proper), $(broken) ] );
					}
					if ( $images.length === loaded.length ){
						setTimeout( doneLoading );
						$images.unbind( '.imagesLoaded' );
					}
				}
				if ( !$images.length ) {
					doneLoading();
				} else {
					$images.bind( 'load.imagesLoaded error.imagesLoaded', function( event ){
						imgLoaded( event.target, event.type === 'error' );
					}).each( function( i, el ) {
						var src = el.src;
						var cached = $.data( el, 'imagesLoaded' );
						if ( cached && cached.src === src ) {
							imgLoaded( el, cached.isBroken );
							return;
						}
						if ( el.complete && el.naturalWidth !== undefined ) {
							imgLoaded( el, el.naturalWidth === 0 || el.naturalHeight === 0 );
							return;
						}
						if ( el.readyState || el.complete ) {
							el.src = BLANK;
							el.src = src;
						}
					});
				}
				return deferred ? deferred.promise( $this ) : $this;
			};
			var Grid = (function() {
				var $grid = $( '#og-grid' ),
					$items = $grid.children( 'li' ),
					current = -1,
					previewPos = -1,
					scrollExtra = 0,
					marginExpanded = 10,
					$window = $( window ), winsize,
					$body = $( 'html, body' ),
					transEndEventNames = {
						'WebkitTransition' : 'webkitTransitionEnd',
						'MozTransition' : 'transitionend',
						'OTransition' : 'oTransitionEnd',
						'msTransition' : 'MSTransitionEnd',
						'transition' : 'transitionend'
					},
					transEndEventName = transEndEventNames[ Modernizr.prefixed( 'transition' ) ],
					support = Modernizr.csstransitions,
					settings = {
						minHeight : 500,
						speed : 350,
						easing : 'ease'
					};
				function init( config ) {
					
					settings = $.extend( true, {}, settings, config );
					$grid.imagesLoaded( function() {
						saveItemInfo( true );
						getWinSize();
						initEvents();
					} );
				}
				function addItems( $newitems ) {
					$items = $items.add( $newitems );
					$newitems.each( function() {
						var $item = $( this );
						$item.data( {
							offsetTop : $item.offset().top,
							height : $item.height()
						} );
					} );
					initItemsEvents( $newitems );
				}
				function saveItemInfo( saveheight ) {
					$items.each( function() {
						var $item = $( this );
						$item.data( 'offsetTop', $item.offset().top );
						if( saveheight ) {
							$item.data( 'height', $item.height() );
						}
					} );
				}
				function initEvents() {
					
					initItemsEvents( $items );
					
					$window.on( 'debouncedresize', function() {
						
						scrollExtra = 0;
						previewPos = -1;
						saveItemInfo();
						getWinSize();
						var preview = $.data( this, 'preview' );
						if( typeof preview != 'undefined' ) {
							hidePreview();
						}
					} );
				}
				function initItemsEvents( $items ) {
					$items.on( 'click', 'span.og-close', function() {
						hidePreview();
						return false;
					} ).children( 'a' ).on( 'click', function(e) {
						var $item = $( this ).parent();
						current === $item.index() ? hidePreview() : showPreview( $item );
						return false;
					} );
				}
				function getWinSize() {
					winsize = { width : $window.width(), height : $window.height() };
				}
				function showPreview( $item ) {
					var preview = $.data( this, 'preview' ),
						position = $item.data( 'offsetTop' );
					scrollExtra = 0;
					if( typeof preview != 'undefined' ) {
						if( previewPos !== position ) {
							if( position > previewPos ) {
								scrollExtra = preview.height;
							}
							hidePreview();
						}
						else {
							preview.update( $item );
							return false;
						}
						
					}
					previewPos = position;
					preview = $.data( this, 'preview', new Preview( $item ) );
					preview.open();
				}
				function hidePreview() {
					current = -1;
					var preview = $.data( this, 'preview' );
					preview.close();
					$.removeData( this, 'preview' );
				}
				function Preview( $item ) {
					this.$item = $item;
					this.expandedIdx = this.$item.index();
					this.create();
					this.update();
				}
				Preview.prototype = {
					create : function() {
						this.$title = $( '<h3></h3>' );
						this.$description = $( '<p></p>' );
						this.$href = $( '<a href="#"></a>' );
						this.$details = $( '<div class="og-details"></div>' ).append( this.$title, this.$description, this.$href );
						this.$loading = $( '<div class="og-loading"></div>' );
						this.$fullimage = $( '<div class="og-fullimg"></div>' ).append( this.$loading );
						this.$closePreview = $( '<span class="og-close"></span>' );
						this.$previewInner = $( '<div class="og-expander-inner"></div>' ).append( this.$closePreview, this.$fullimage, this.$details );
						this.$previewEl = $( '<div class="og-expander"></div>' ).append( this.$previewInner );
						this.$item.append( this.getEl() );
						if( support ) {
							this.setTransition();
						}
					},
					update : function( $item ) {
						if( $item ) {
							this.$item = $item;
						}
						
						if( current !== -1 ) {
							var $currentItem = $items.eq( current );
							$currentItem.removeClass( 'og-expanded' );
							this.$item.addClass( 'og-expanded' );
							this.positionPreview();
						}
						current = this.$item.index();
						var $itemEl = this.$item.children( 'a' ),
							eldata = {
								href : $itemEl.attr( 'href' ),
								largesrc : $itemEl.data( 'largesrc' ),
								title : $itemEl.data( 'title' ),
								description : $itemEl.data( 'description' )
							};
						this.$title.html( eldata.title );
						this.$description.html( eldata.description );
						this.$href.attr( 'href', eldata.href );
						var self = this;
						
						if( typeof self.$largeImg != 'undefined' ) {
							self.$largeImg.remove();
						}
						if( self.$fullimage.is( ':visible' ) ) {
							this.$loading.show();
							$( '<img/>' ).load( function() {
								var $img = $( this );
								if( $img.attr( 'src' ) === self.$item.children('a').data( 'largesrc' ) ) {
									self.$loading.hide();
									self.$fullimage.find( 'img' ).remove();
									self.$largeImg = $img.fadeIn( 350 );
									self.$fullimage.append( self.$largeImg );
								}
							} ).attr( 'src', eldata.largesrc );	
						}
					},
					open : function() {
						setTimeout( $.proxy( function() {	
							this.setHeights();
							this.positionPreview();
						}, this ), 25 );
					},
					close : function() {
						var self = this,
							onEndFn = function() {
								if( support ) {
									$( this ).off( transEndEventName );
								}
								self.$item.removeClass( 'og-expanded' );
								self.$previewEl.remove();
							};
						setTimeout( $.proxy( function() {
							if( typeof this.$largeImg !== 'undefined' ) {
								this.$largeImg.fadeOut( 'fast' );
							}
							this.$previewEl.css( 'height', 0 );
							var $expandedItem = $items.eq( this.expandedIdx );
							$expandedItem.css( 'height', $expandedItem.data( 'height' ) ).on( transEndEventName, onEndFn );
							if( !support ) {
								onEndFn.call();
							}
						}, this ), 25 );
						
						return false;
					},
					calcHeight : function() {
						var heightPreview = winsize.height - this.$item.data( 'height' ) - marginExpanded,
							itemHeight = winsize.height;
						if( heightPreview < settings.minHeight ) {
							heightPreview = settings.minHeight;
							itemHeight = settings.minHeight + this.$item.data( 'height' ) + marginExpanded;
						}
						this.height = heightPreview;
						this.itemHeight = itemHeight;
					},
					setHeights : function() {
						var self = this,
							onEndFn = function() {
								if( support ) {
									self.$item.off( transEndEventName );
								}
								self.$item.addClass( 'og-expanded' );
							};
						this.calcHeight();
						this.$previewEl.css( 'height', this.height );
						this.$item.css( 'height', this.itemHeight ).on( transEndEventName, onEndFn );
						if( !support ) {
							onEndFn.call();
						}
					},
					positionPreview : function() {
						var position = this.$item.data( 'offsetTop' ),
							previewOffsetT = this.$previewEl.offset().top - scrollExtra,
							scrollVal = this.height + this.$item.data( 'height' ) + marginExpanded <= winsize.height ? position : this.height < winsize.height ? previewOffsetT - ( winsize.height - this.height ) : previewOffsetT;
						
						$body.animate( { scrollTop : scrollVal }, settings.speed );
					},
					setTransition  : function() {
						this.$previewEl.css( 'transition', 'height ' + settings.speed + 'ms ' + settings.easing );
						this.$item.css( 'transition', 'height ' + settings.speed + 'ms ' + settings.easing );
					},
					getEl : function() {
						return this.$previewEl;
					}
				}
				return { 
					init : init,
					addItems : addItems
				};
			})();
		</script>
		<script>
			$(function() {
				Grid.init();
			});
		</script>
</body>
</html>

