<!DOCTYPE html>



<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="alternate" href="/index.xml" type="application/rss+xml" title="Raytheon Pivotal Workshops">
		<link rel="icon" href="/favicon.ico">
		<title>Lab106 - Raytheon Pivotal Workshops</title>
		<link rel="stylesheet" href="/css/highlight.js.min.css">
		<link rel="stylesheet" href="/css/bootstrap.min.css">
		<link rel="stylesheet" href="/css/bootstrap-theme.css">
		<link rel="stylesheet" href="/css/pui-v2.0.0/pivotal-ui.css">
		<link rel="stylesheet" href="/css/theme.css">
		<link rel="stylesheet" href="/css/component.css">

<link rel="stylesheet"  href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/3.1.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="/css/bootie-docs.css">
		<script src="http://raytheon.cfapps.io/js/modernizr.custom.js"></script>

		
		<style type="text/css">
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
		</style>
	</head>

<body role="document">
	
	
	<nav class="navbar navbar-inverse navbar-fixed-top  ">
		<div class="container-fluid">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<div class="nav navbar-brand">
						
							<img class="nav pivotal-logo" src="/Pivotal_Teal.png"/>
						
				</div>
				<a class="navbar-brand navbar-txt" href="/">Raytheon Pivotal Workshops </a>
			</div>
			<div id="navbar" class="navbar-collapse collapse">
				<ul class="nav navbar-nav">
			
				
				
					
					<li ><a class="navbar-txt" href="/lab_requirements">Lab_requirements</a></li>
				
					
					<li ><a class="navbar-txt" href="/billerica_day1">Billerica_day1</a></li>
				
					
					<li ><a class="navbar-txt" href="/billerica_day2">Billerica_day2</a></li>
				
					
					<li ><a class="navbar-txt" href="/billerica_day3">Billerica_day3</a></li>
				
					
					<li ><a class="navbar-txt" href="/cloud_tig">Cloud_tig</a></li>
				
			
			
				<li class="dropdown">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Resources<span class="caret"></span></a>
					<ul class="dropdown-menu" role="menu">
					
                        <li><a target="_blank" href="https://www.youtube.com/playlist?list=PLAdzTan_eSPQ1fuLSBhyB4eEZF7JQM0Mx">All SpringOne Conference Videos</a></li>
                     
                        <li><a target="_blank" href="http://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry-dev/introduction">Try PCF on your Local Workstation with PCF Dev</a></li>
                     
                        <li><a target="_blank" href="http://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry/introduction">Try PCF on the Public Cloud</a></li>
                     
                        <li><a target="_blank" href="/CorporateOverview.pdf">Pivotal Overview</a></li>
                     
                        <li><a target="_blank" href="https://network.pivotal.io/products/pcfdev">PCF Dev</a></li>
                     
                        <li><a target="_blank" href="https://docs.pivotal.io/pivotalcf">PCF Documentation</a></li>
                     
                        <li><a target="_blank" href="https://docs.pivotal.io/pivotalcf/cf-cli/getting-started.html">CF CLI Documentation</a></li>
                     
                        <li><a target="_blank" href="https://www.git-scm.com">Git</a></li>
                     
                        <li><a target="_blank" href="https://try.github.io/levels/1/challenges/1">Git Lessons</a></li>
                     
                        <li><a target="_blank" href="http://platform.spring.io/platform/">Spring Platform</a></li>
                     
                        <li><a target="_blank" href="https://spring.io/docs">Spring Docs</a></li>
                     
                        <li><a target="_blank" href="http://start.spring.io/">Spring Initializer</a></li>
                     
                        <li><a target="_blank" href="https://spring.io/blog/2015/10/19/springone2gx-2015-replay-spring-cloud-at-netflix">Spring Cloud at Netflix</a></li>
                     
                        <li><a target="_blank" href="https://spring.io/blog/2015/07/14/microservices-with-spring">Microservices with Spring</a></li>
                     
                        <li><a target="_blank" href="https://spring.io/guides#tutorials">Spring Guides</a></li>
                     
                        <li><a target="_blank" href="https://network.pivotal.io/">Pivotal Network</a></li>
                     
                        <li><a target="_blank" href="http://docs.pivotal.io">Pivotal Documentation</a></li>
                     
					</ul>
				</li>
			
			
				<li class="dropdown">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Books<span class="caret"></span></a>
					<ul class="dropdown-menu" role="menu">
					
                        <li><a target="_blank" href="/books/Beyond_the_12-Factor_App_Pivotal.pdf">Beyond the 12-Factor App</a></li>
                     
                        <li><a target="_blank" href="/books/Migrating_to_Cloud-Native_App_Architectures_Pivotal.pdf">Migrating to Cloud Native Application Architectures</a></li>
                     
                        <li><a target="_blank" href="/books/Cloud_Foundry_The_Cloud_Native_Platform_Pivotal.pdf">Cloud Foundry The Cloud Native Platform</a></li>
                     
                        <li><a target="_blank" href="http://www.amazon.com/Cloud-Native-Java-Designing-Resilient/dp/1449374646">Cloud Native Java: Designing Resilient Systems with Spring Boot, Spring Cloud, and Cloud Foundry</a></li>
                     
					</ul>
				</li>
			
				
                        
				</ul>
			</div>
		</div>
	</nav>

<div class="container" style="width:95%; padding:5">
	<div class="row">

	    		
		<div class="doc-sidebar" style="width:30%; margin-top:0; float:right; padding:10px;">
			<div class="sidebar-module">
				
		    	<div class="tag-box bg-dark-11" style="padding:10px; margin:20px;">
		    	<h4 class="type-brand-3">Books</h4>
		    	<ul class="list-unstyled">
		    	
		    	<li><a target="_blank" href="/books/Beyond_the_12-Factor_App_Pivotal.pdf">Beyond the 12-Factor App</a><p></p></li>	
		    	
		    	<li><a target="_blank" href="/books/Migrating_to_Cloud-Native_App_Architectures_Pivotal.pdf">Migrating to Cloud Native Application Architectures</a><p></p></li>	
		    	
		    	<li><a target="_blank" href="/books/Cloud_Foundry_The_Cloud_Native_Platform_Pivotal.pdf">Cloud Foundry The Cloud Native Platform</a><p></p></li>	
		    	
		    	<li><a target="_blank" href="http://www.amazon.com/Cloud-Native-Java-Designing-Resilient/dp/1449374646">Cloud Native Java: Designing Resilient Systems with Spring Boot, Spring Cloud, and Cloud Foundry</a><p></p></li>	
		    	
		    	</ul>
		  	</div>
                        <div class="tag-box bg-dark-11" style="padding:10px; margin:20px;">
                        <h4 class="type-brand-3">Resources</h4>
                        <ul class="list-unstyled">
                        
                            <li><a target="_blank" href="https://www.youtube.com/playlist?list=PLAdzTan_eSPQ1fuLSBhyB4eEZF7JQM0Mx">All SpringOne Conference Videos</a><p></p></li>
                        
                            <li><a target="_blank" href="http://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry-dev/introduction">Try PCF on your Local Workstation with PCF Dev</a><p></p></li>
                        
                            <li><a target="_blank" href="http://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry/introduction">Try PCF on the Public Cloud</a><p></p></li>
                        
                            <li><a target="_blank" href="/CorporateOverview.pdf">Pivotal Overview</a><p></p></li>
                        
                            <li><a target="_blank" href="https://network.pivotal.io/products/pcfdev">PCF Dev</a><p></p></li>
                        
                            <li><a target="_blank" href="https://docs.pivotal.io/pivotalcf">PCF Documentation</a><p></p></li>
                        
                            <li><a target="_blank" href="https://docs.pivotal.io/pivotalcf/cf-cli/getting-started.html">CF CLI Documentation</a><p></p></li>
                        
                            <li><a target="_blank" href="https://www.git-scm.com">Git</a><p></p></li>
                        
                            <li><a target="_blank" href="https://try.github.io/levels/1/challenges/1">Git Lessons</a><p></p></li>
                        
                            <li><a target="_blank" href="http://platform.spring.io/platform/">Spring Platform</a><p></p></li>
                        
                            <li><a target="_blank" href="https://spring.io/docs">Spring Docs</a><p></p></li>
                        
                            <li><a target="_blank" href="http://start.spring.io/">Spring Initializer</a><p></p></li>
                        
                            <li><a target="_blank" href="https://spring.io/blog/2015/10/19/springone2gx-2015-replay-spring-cloud-at-netflix">Spring Cloud at Netflix</a><p></p></li>
                        
                            <li><a target="_blank" href="https://spring.io/blog/2015/07/14/microservices-with-spring">Microservices with Spring</a><p></p></li>
                        
                            <li><a target="_blank" href="https://spring.io/guides#tutorials">Spring Guides</a><p></p></li>
                        
                            <li><a target="_blank" href="https://network.pivotal.io/">Pivotal Network</a><p></p></li>
                        
                            <li><a target="_blank" href="http://docs.pivotal.io">Pivotal Documentation</a><p></p></li>
                        
                        </ul>
                        </div>
			</div>
		</div>
		


		<div class="col-sm-8 doc-main" style="width:70%; float:left; padding:30px;">
			<main role="main">
				<article>
					<a id="title"></a>
					<div class="doc-entry-meta">
					</div>
					<section>
						<div class="sect1">
<h2 id="_lab_10_service_discovery_and_steeltoe_eureka_client">Lab 10 - Service Discovery and Steeltoe Eureka Client</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_code_goal_code"><code>Goal</code></h2>
<div class="sectionbody">
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>The goals for this lab are to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use Spring Cloud Eureka Server for Service Registration and Discovery</p>
</li>
<li>
<p>Use Steeltoe Discovery client to register and discover the <code>Fortune Teller Service</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Approximate time: 1 hour</p>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The completed code for this lab can be found at <code>$COURSE_HOME/dotnet/lab06/</code>.
</td>
</tr>
</table>
</div>
<div class="quoteblock abstract">
<blockquote>
<div class="paragraph">
<p>In this lab we will continue to add functionality to the Fortune Teller application.
We will explore how to use Netflix Eureka for service registration and discovery using the Steeltoe Discovery client.</p>
</div>
<div class="paragraph">
<p>If you started with the <em>FortuneTeller.sln</em>, and completed Lab 7, you have an app that is still not where we would like it to be:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The <code>Fortune Teller Service</code> uses a backend in-memory datastore to hold  Fortunes.</p>
</li>
<li>
<p>The <code>Fortune Teller UI</code> uses a configurable <code>FortuneServiceClient</code>  service to communicate with the <code>Fortune Teller Service</code>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>But we have to reconfigure the <code>Fortune Teller UI</code> every time we change the address of the <code>Fortune Teller Service</code></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</blockquote>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_open_visual_studio_solution">Open Visual Studio Solution</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start Visual Studio and open the solution/folder you wish to use:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><em>Workshop/Session-03/Lab08.sln</em> if you want to start with finished code.</p>
</li>
<li>
<p><em>Workshop/FortuneTeller/FortuneTeller.sln</em> if you are writing code from scratch.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_use_spring_cloud_eureka_server_as_a_discovery_server">Use Spring Cloud Eureka Server as a Discovery server</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_step_01_run_spring_cloud_eureka_server_locally">Step 01 - Run Spring Cloud Eureka Server Locally</h3>
<div class="paragraph">
<p>Here we need to make sure a Spring Cloud Eureka Server is running locally so its easier to develop and test with.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To run Eureka Server you will need Java JDK installed on your machine and the JAVA_HOME environment variable set to the JDK&#8217;s installed location:</p>
<div class="listingblock">
<div class="content">
<pre>e.g. JAVA_HOME=C:\Program Files\Java\jdk1.8.0_112 or equivalent on Linux/Mac</pre>
</div>
</div>
</li>
<li>
<p>Open a command window.</p>
</li>
<li>
<p>Change directory to <em>Workshop/EurekaServer</em></p>
<div class="listingblock">
<div class="content">
<pre>&gt; cd Workshop\EurekaServer</pre>
</div>
</div>
</li>
<li>
<p>Startup the eureka server</p>
<div class="listingblock">
<div class="content">
<pre>&gt; mvnw spring-boot:run</pre>
</div>
</div>
<div class="paragraph">
<p><br>
It will start up on port 8761 and serve the Eureka API from "/eureka".</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_step_02_run_spring_cloud_config_server_locally">Step 02 - Run Spring Cloud Config Server Locally</h3>
<div class="paragraph">
<p>We are still using the Config Server, so we make sure it is running locally so its easier to develop and test with.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To run Config Server you will need Java JDK installed on your machine and the JAVA_HOME environment variable set to the JDK&#8217;s installed location:</p>
<div class="listingblock">
<div class="content">
<pre>e.g. JAVA_HOME=C:\Program Files\Java\jdk1.8.0_112 or equivalent on Linux/Mac</pre>
</div>
</div>
</li>
<li>
<p>Open a command window.</p>
</li>
<li>
<p>Change directory to <em>Workshop/ConfigServer</em></p>
<div class="listingblock">
<div class="content">
<pre>&gt; cd Workshop\ConfigServer</pre>
</div>
</div>
</li>
<li>
<p>Startup the config server</p>
<div class="listingblock">
<div class="content">
<pre>&gt; mvnw spring-boot:run</pre>
</div>
</div>
<div class="paragraph">
<p><br>
It will start up on port 8888 and serve configuration data from "file:./steeltoe/config-repo". This will be the directory <em>Workshop/ConfigServer/steeltoe/config-repo</em>.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_step_03_add_steeltoe_discovery_client_nuget">Step 03 - Add Steeltoe Discovery Client Nuget</h3>
<div class="paragraph">
<p>Here we add the appropriate Spring Cloud Eureka Server client Nuget to each Fortune Teller application.
When targeting Spring Cloud Services on PCF, we use the Nuget: <code>Pivotal.Discovery.Client</code>.
When targeting Spring Cloud Open Source, we can use Nuget: <code>Steeltoe.Discovery.Client</code>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Expand the <code>Fortune-Teller-UI</code> and <code>Fortune-Teller-Service</code> projects.</p>
</li>
<li>
<p>Open <code>.csproj</code> for EACH project and add the<code>PackageReference</code>:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Include="Pivotal.Discovery.Client" Version="1.0.0"</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>  &lt;ItemGroup&gt;
   .......
    &lt;PackageReference Include="Microsoft.EntityFrameworkCore" Version="1.0.3" /&gt;
    &lt;PackageReference Include="Microsoft.EntityFrameworkCore.InMemory" Version="1.0.3" /&gt;
    &lt;PackageReference Include="Pivotal.Extensions.Configuration.ConfigServer" version="1.0.0" /&gt;
    &lt;PackageReference Include="Pivotal.Discovery.Client" version="1.0.0" /&gt;
  &lt;/ItemGroup&gt;</pre>
</div>
</div>
</li>
<li>
<p>Save each <code>csproj</code> and make sure that a <code>dotnet restore</code> is done.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_step_04_add_steeltoe_discovery_client_to_container">Step 04 - Add Steeltoe Discovery Client to Container</h3>
<div class="paragraph">
<p>In this step we need to add the Steeltoe Discovery Client to the service container and the start it up, running in the background, fetching Service information.
We do this by adding it as another service to the <code>IServiceCollection</code> in <code>ConfigureServices</code>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Expand the <code>Fortune-Teller-UI</code> and <code>Fortune-Teller-Service</code> projects.</p>
</li>
<li>
<p>Open <code>Startup.cs</code> in each project and modify the <code>ConfigureServices</code> method to include a call to <code>AddDiscoveryClient(Configuration)</code>:</p>
<div class="listingblock">
<div class="content">
<pre> public void ConfigureServices(IServiceCollection services)
{
.....
        services.AddSingleton&lt;IFortuneRepository, FortuneRepository&gt;();

        services.AddDiscoveryClient(Configuration);

        // Add framework services.
        services.AddMvc();
......
}</pre>
</div>
</div>
</li>
<li>
<p>Then we also need to start the Discovery client running in the background.
To do this we add a <code>UseDiscoveryClient()</code> method call in  <code>Configure()</code> method.</p>
<div class="listingblock">
<div class="content">
<pre>public void Configure(IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory)
{
.....
    app.UseMvc();

    app.UseDiscoveryClient();
.....
}</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_step_04_configure_the_discovery_client">Step 04 - Configure the Discovery Client</h3>
<div class="paragraph">
<p>Once we have the Discovery client added to the service container we next need to configure the client.
We have two sets of Discovery client configuration data to provide, one for the <code>Fortune Teller Service</code> and the other for <code>Fortune Teller UI</code>.
For the <code>Fortune Teller Service</code> we want it to register itself with the Eureka Server, but we don&#8217;t need it to fetch any services as it doesn&#8217;t make any external service requests.
For the <code>Fortune Teller UI</code> we want it to fetch registered services, but we don&#8217;t need to register, as it has no external REST endpoints it needs to expose.
And finally, for both, we need to configure the URL endpoint of the Eureka Server, so that both know how to contact the server.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Modify the <code>application.yml</code> file in <em>file:./steeltoe/config-repo</em> to contain:</p>
<div class="listingblock">
<div class="content">
<pre>Logging:
  IncludeScopes: false
  LogLevel:
    Default: Information
    System: Information
    Microsoft: Information
eureka:
  client:
    serviceUrl: http://localhost:8761/eureka/</pre>
</div>
</div>
<div class="paragraph">
<p><br>
So in the above, we configure the usage of the <code>eureka client</code> and we configure the endpoint (<code>serviceUrl</code> of the Eureka server.
Since this data is contained in <code>application.yml</code> it will be returned for ALL (e.g. fortuneService and fortuneui) applications which fetch data from this server.</p>
</div>
</li>
<li>
<p>Modify the <code>fortuneService.yml</code> file in <em>file:./steeltoe/config-repo</em> to contain:</p>
<div class="listingblock">
<div class="content">
<pre>eureka:
  client:
    shouldFetchRegistry: false
  instance:
    port: 5000
    hostName: localhost</pre>
</div>
</div>
<div class="paragraph">
<p><br>
Since the above information is contained in <code>fortuneService.yml</code>, it applies to all apps with the <code>spring:name</code> == <code>fortuneService</code>.
Here we tell the client to not fetch any service registry information (<code>shouldFetchRegistry: false</code>).
Then we tell it to register itself as an <code>instance</code>, listening at the address <code>localhost:5000</code>.
Note that the name for <code>Fortune Teller Service</code> comes from <code>appsettings.json</code>. (<code>spring:name</code> = <code>fortuneService</code>).
All of this should work fine when running locally and we will override some of it with the Eureka service binding when we push it to Cloud Foundry.</p>
</div>
</li>
<li>
<p>Modify the <code>fortuneui.yml</code> file in <em>file:./steeltoe/config-repo</em> to contain:</p>
<div class="listingblock">
<div class="content">
<pre>eureka:
  client:
    shouldRegisterWithEureka: false

fortuneService:
  scheme: http
  address: fortuneService
  randomFortunePath: api/fortunes/random
  allFortunesPath: api/fortunes/all</pre>
</div>
</div>
<div class="paragraph">
<p><br>
Since the above information is contained in <code>fortuneui.yml</code>, it applies to all apps with the <code>spring:name</code> == <code>fortuneui</code>.
Here we tell the client to go ahead and fetch any service registry information; the default is (<code>shouldFetchRegistry: true</code>).
Then we tell it NOT register itself (<code>shouldRegisterWithEureka: false</code>) and so we don&#8217;t provide any <code>instance</code> configuration data.
Note that the name for <code>Fortune Teller UI</code> comes from <code>appsettings.json</code>. (<code>spring:name</code> = <code>fortuneui</code>).
Also notice that we changed <code>address</code> in the <code>fortuneService</code>. Instead of using <code>localhost:5000</code> like before, we use the name of the <code>Fortune Teller Service</code> registered with Eureka.
All of this should work fine when running locally and we will override some of it with the Eureka service binding when we push it to Cloud Foundry.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_step_05_discover_services_discoveryhttpclienthandler">Step 05 - Discover Services - DiscoveryHttpClientHandler</h3>
<div class="paragraph">
<p>Last code change we have to make to get the Discovery service fully implemented and used is to change the <code>FortuneServiceClient</code> to use the <code>IDiscoveryClient</code>.
The <code>AddDiscoveryClient(Configuration)</code> that we added to the container in the <code>ConfigureServices()</code> method adds <code>IDiscoveryClient</code> to the service container.
To to get access to this in the <code>FortuneServiceClient</code>,  we will need to add <code>IDiscoveryClient</code> to its constructor.</p>
</div>
<div class="paragraph">
<p>Once this is done, we could go ahead and use <code>IDiscoveryClient</code> directly to lookup services, but instead what we will do is use another Steeltoe component <code>DiscoveryHttpClientHandler</code> to make our life easier.
The <code>DiscoveryHttpClientHandler</code> is an <code>HttpClientHandler</code> that can be used with an <code>HttpClient</code> to intercept any client requests and evaluate the request URL to see if the address portion of the URL can be resolved from the service registry.
In this case we will use it to resolve the "fortuneService" name into an actual host:port before allowing the request to continue.
If the name can&#8217;t be resolved the handler will still allow the request to continue, but of course the request will fail.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Expand the Common/Services folder.</p>
</li>
<li>
<p>Open <code>FortuneServiceClient</code> and modify the constructor as follows:</p>
<div class="listingblock">
<div class="content">
<pre>DiscoveryHttpClientHandler _handler;
public FortuneServiceClient(IDiscoveryClient client, IOptionsSnapshot&lt;FortuneServiceConfig&gt; config, ILogger&lt;FortuneServiceClient&gt; logger)
{
    _handler = new DiscoveryHttpClientHandler(client);
    _logger = logger;
    _config = config;
}</pre>
</div>
</div>
</li>
<li>
<p>Next, locate the <code>GetClient()</code> method and modify it to use the handler:</p>
<div class="listingblock">
<div class="content">
<pre>private HttpClient GetClient()
{
    var client = new HttpClient(_handler, false);
    return client;
}</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_step_06_run_locally">Step 06 - Run Locally</h3>
<div class="paragraph">
<p>At this point you should be ready to run both Fortune-Tellers locally and test.
Every thing should work as it did before, but now we are using Eureka for service registration and discovery.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Using the skills you picked up from Lab05, run the apps from VS2017 and/or from the command line.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>CTRL-F5 or F5 on VS2017</p>
</li>
<li>
<p><code>dotnet run --server.urls <a href="http://*:5000" class="bare">http://*:5000</a></code> - Fortune-Teller-Service</p>
</li>
<li>
<p><code>dotnet run --server.urls <a href="http://*:5555" class="bare">http://*:5555</a></code> - Fortune-Teller-UI</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_to_cloud_foundry">Deploy to Cloud Foundry</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_step_01_setup_eureka_server">Step 01 - Setup Eureka Server</h3>
<div class="paragraph">
<p>You must first create an instance of the Eureka Server service in your org/space if you haven&#8217;t already done so.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open a command window.</p>
</li>
<li>
<p>Using the command window, create an instance of the Eureka server:</p>
<div class="listingblock">
<div class="content">
<pre>&gt; cf create-service p-service-registry standard myDiscoveryService</pre>
</div>
</div>
</li>
<li>
<p>Wait for the service to become available:</p>
<div class="listingblock">
<div class="content">
<pre>&gt; cf services</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_step_02_setup_config_server">Step 02 - Setup Config Server</h3>
<div class="paragraph">
<p>Make sure you still have an instance of the Config Server service in your org/space. If you don&#8217;t:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open a command window.</p>
</li>
<li>
<p>Change directory to your starting lab point:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>_Workshop/Session-03/Lab09 &#8230;&#8203;. if you started with finished code.</p>
</li>
<li>
<p>_Workshop/FortuneTeller/ &#8230;&#8203;. if you are writing code from scratch.</p>
<div class="listingblock">
<div class="content">
<pre>&gt; e.g cd Workshop\FortuneTeller</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Optional: Create your own github repo to hold the Config Server data</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Optional: Fork github repository <a href="https://github.com/SteeltoeOSS/workshop-config-repo" class="bare">https://github.com/SteeltoeOSS/workshop-config-repo</a></p>
</li>
<li>
<p>Optional: Open the <code>config-server.json</code> file in the Solution Items folder.</p>
</li>
<li>
<p>Optional: Modify it to point to the github repo you just created.</p>
</li>
<li>
<p>Optional: Add the contents of <em>file:./steeltoe/config-repo</em> to the github repo you just created</p>
</li>
</ol>
</div>
</li>
<li>
<p>Using the command window, create an instance of the config server and set its configuration up with a github repo referenced in the config-server.json file:</p>
<div class="listingblock">
<div class="content">
<pre>&gt; Windows: cf create-service p-config-server standard myConfigServer -c .\config-server.json

&gt; Mac/Linux: cf create-service p-config-server standard myConfigServer -c config-server.json</pre>
</div>
</div>
</li>
<li>
<p>Wait for the service to become available:</p>
<div class="listingblock">
<div class="content">
<pre>&gt; cf services</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_step_03_push_to_cloud_foundry">Step 03 - Push to Cloud Foundry</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Examine the <code>manfest.yml</code> files for both projects and notice <code>services</code> addition shown below.
You need to make this change in your <code>manifest.yml</code> before you push to Cloud Foundry.
Also, notice the <code>ASPNETCORE_ENVIRONMENT</code> setting.
Feel free to change that to <code>Development</code> if you want to turn on debug logging.</p>
<div class="listingblock">
<div class="content">
<pre>---
applications:
- name: fortuneService
  random-route: true
  env:
    ASPNETCORE_ENVIRONMENT: Production
  services:
   - myConfigServer
   - myDiscoveryService

---
applications:
- name: fortuneui
  random-route: true
  env:
    ASPNETCORE_ENVIRONMENT: Production
  services:
   - myConfigServer
   - myDiscoveryService</pre>
</div>
</div>
</li>
<li>
<p>Using the skills you picked from Lab05, publish and push the components to a Linux cell on Cloud Foundry.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Pushing Fortune Teller Service - If you are using the finished lab code on Windows:</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p><code>cd Workshop/Session-03/Lab08/Fortune-Teller-Service</code></p>
</li>
<li>
<p><code>dotnet restore</code></p>
</li>
<li>
<p><code>dotnet build </code></p>
</li>
<li>
<p><code>dotnet publish -o %CD%\publish -f netcoreapp1.1 -r ubuntu.14.04-x64</code></p>
</li>
<li>
<p><code>cf push -f manifest.yml -p .\publish</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Pushing Fortune Teller Service - If you are using the finished lab code on Mac/Linux:</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p><code>cd Workshop/Session-03/Lab08/Fortune-Teller-Service</code></p>
</li>
<li>
<p><code>dotnet restore</code></p>
</li>
<li>
<p><code>dotnet build </code></p>
</li>
<li>
<p><code>dotnet publish -f netcoreapp1.1 -r ubuntu.14.04-x64 -o $PWD/publish</code></p>
</li>
<li>
<p><code>cf push -f manifest.yml -p publish</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Pushing Fortune Teller UI - If you are using the finished lab code on Windows:</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p><code>cd Workshop/Session-03/Lab08/Fortune-Teller-UI</code></p>
</li>
<li>
<p><code>dotnet restore</code></p>
</li>
<li>
<p><code>dotnet build </code></p>
</li>
<li>
<p><code>dotnet publish -o %CD%\publish -f netcoreapp1.1 -r ubuntu.14.04-x64</code></p>
</li>
<li>
<p><code>cf push -f manifest.yml -p .\publish</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Pushing Fortune Teller UI - If you are using the finished lab code on Mac/Linux:</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p><code>cd Workshop/Session-03/Lab08/Fortune-Teller-UI</code></p>
</li>
<li>
<p><code>dotnet restore</code></p>
</li>
<li>
<p><code>dotnet build </code></p>
</li>
<li>
<p><code>dotnet publish -f netcoreapp1.1 -r ubuntu.14.04-x64 -o $PWD/publish</code></p>
</li>
<li>
<p><code>cf push -f manifest.yml -p publish</code></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Try hitting the <code>Fortune Teller UI</code> and if it fails to communicate with the <code>Fortune Teller Service</code>.
make sure fortuneui.yml file us updated as follows "address: fortuneService".</p>
</div>
</div>
</div>
</div>
</div>

					</section>
				</article>
			</main>
		</div> 
	</div> 
</div>

		




<hr />
<div class="container">
	<div class="row">
		<div class="col-sm-8">
			<p class="doc-footer-em"><a href="#">Back to TOP</a></p>
		</div>
	</div>

</div> 
          
<footer class="doc-footer">
        <span>Last Updated on  2016-03-23 19:58:14 -0400 EDT  </span>
	
	<p>Copyright (c) 2015, Pivotal; All rights reserved.</p>
</footer>



<script src="/js/jquery-1.11.2.min.js"></script>
<script src="/js/bootstrap.min.js"></script>

<script src="/js/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script src="/js/ie10-viewport-bug-workaround.js"></script>
		<script>
			var $event = $.event,
			$special,
			resizeTimeout;
			$special = $event.special.debouncedresize = {
				setup: function() {
					$( this ).on( "resize", $special.handler );
				},
				teardown: function() {
					$( this ).off( "resize", $special.handler );
				},
				handler: function( event, execAsap ) {
					var context = this,
						args = arguments,
						dispatch = function() {
							event.type = "debouncedresize";
							$event.dispatch.apply( context, args );
						};
					if ( resizeTimeout ) {
						clearTimeout( resizeTimeout );
					}
					execAsap ?
						dispatch() :
						resizeTimeout = setTimeout( dispatch, $special.threshold );
				},
				threshold: 250
			};
			var BLANK = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
			$.fn.imagesLoaded = function( callback ) {
				var $this = this,
					deferred = $.isFunction($.Deferred) ? $.Deferred() : 0,
					hasNotify = $.isFunction(deferred.notify),
					$images = $this.find('img').add( $this.filter('img') ),
					loaded = [],
					proper = [],
					broken = [];
				if ($.isPlainObject(callback)) {
					$.each(callback, function (key, value) {
						if (key === 'callback') {
							callback = value;
						} else if (deferred) {
							deferred[key](value);
						}
					});
				}
				function doneLoading() {
					var $proper = $(proper),
						$broken = $(broken);
					if ( deferred ) {
						if ( broken.length ) {
							deferred.reject( $images, $proper, $broken );
						} else {
							deferred.resolve( $images );
						}
					}
					if ( $.isFunction( callback ) ) {
						callback.call( $this, $images, $proper, $broken );
					}
				}
				function imgLoaded( img, isBroken ) {
					if ( img.src === BLANK || $.inArray( img, loaded ) !== -1 ) {
						return;
					}
					loaded.push( img );
					if ( isBroken ) {
						broken.push( img );
					} else {
						proper.push( img );
					}
					$.data( img, 'imagesLoaded', { isBroken: isBroken, src: img.src } );
					if ( hasNotify ) {
						deferred.notifyWith( $(img), [ isBroken, $images, $(proper), $(broken) ] );
					}
					if ( $images.length === loaded.length ){
						setTimeout( doneLoading );
						$images.unbind( '.imagesLoaded' );
					}
				}
				if ( !$images.length ) {
					doneLoading();
				} else {
					$images.bind( 'load.imagesLoaded error.imagesLoaded', function( event ){
						imgLoaded( event.target, event.type === 'error' );
					}).each( function( i, el ) {
						var src = el.src;
						var cached = $.data( el, 'imagesLoaded' );
						if ( cached && cached.src === src ) {
							imgLoaded( el, cached.isBroken );
							return;
						}
						if ( el.complete && el.naturalWidth !== undefined ) {
							imgLoaded( el, el.naturalWidth === 0 || el.naturalHeight === 0 );
							return;
						}
						if ( el.readyState || el.complete ) {
							el.src = BLANK;
							el.src = src;
						}
					});
				}
				return deferred ? deferred.promise( $this ) : $this;
			};
			var Grid = (function() {
				var $grid = $( '#og-grid' ),
					$items = $grid.children( 'li' ),
					current = -1,
					previewPos = -1,
					scrollExtra = 0,
					marginExpanded = 10,
					$window = $( window ), winsize,
					$body = $( 'html, body' ),
					transEndEventNames = {
						'WebkitTransition' : 'webkitTransitionEnd',
						'MozTransition' : 'transitionend',
						'OTransition' : 'oTransitionEnd',
						'msTransition' : 'MSTransitionEnd',
						'transition' : 'transitionend'
					},
					transEndEventName = transEndEventNames[ Modernizr.prefixed( 'transition' ) ],
					support = Modernizr.csstransitions,
					settings = {
						minHeight : 500,
						speed : 350,
						easing : 'ease'
					};
				function init( config ) {
					
					settings = $.extend( true, {}, settings, config );
					$grid.imagesLoaded( function() {
						saveItemInfo( true );
						getWinSize();
						initEvents();
					} );
				}
				function addItems( $newitems ) {
					$items = $items.add( $newitems );
					$newitems.each( function() {
						var $item = $( this );
						$item.data( {
							offsetTop : $item.offset().top,
							height : $item.height()
						} );
					} );
					initItemsEvents( $newitems );
				}
				function saveItemInfo( saveheight ) {
					$items.each( function() {
						var $item = $( this );
						$item.data( 'offsetTop', $item.offset().top );
						if( saveheight ) {
							$item.data( 'height', $item.height() );
						}
					} );
				}
				function initEvents() {
					
					initItemsEvents( $items );
					
					$window.on( 'debouncedresize', function() {
						
						scrollExtra = 0;
						previewPos = -1;
						saveItemInfo();
						getWinSize();
						var preview = $.data( this, 'preview' );
						if( typeof preview != 'undefined' ) {
							hidePreview();
						}
					} );
				}
				function initItemsEvents( $items ) {
					$items.on( 'click', 'span.og-close', function() {
						hidePreview();
						return false;
					} ).children( 'a' ).on( 'click', function(e) {
						var $item = $( this ).parent();
						current === $item.index() ? hidePreview() : showPreview( $item );
						return false;
					} );
				}
				function getWinSize() {
					winsize = { width : $window.width(), height : $window.height() };
				}
				function showPreview( $item ) {
					var preview = $.data( this, 'preview' ),
						position = $item.data( 'offsetTop' );
					scrollExtra = 0;
					if( typeof preview != 'undefined' ) {
						if( previewPos !== position ) {
							if( position > previewPos ) {
								scrollExtra = preview.height;
							}
							hidePreview();
						}
						else {
							preview.update( $item );
							return false;
						}
						
					}
					previewPos = position;
					preview = $.data( this, 'preview', new Preview( $item ) );
					preview.open();
				}
				function hidePreview() {
					current = -1;
					var preview = $.data( this, 'preview' );
					preview.close();
					$.removeData( this, 'preview' );
				}
				function Preview( $item ) {
					this.$item = $item;
					this.expandedIdx = this.$item.index();
					this.create();
					this.update();
				}
				Preview.prototype = {
					create : function() {
						this.$title = $( '<h3></h3>' );
						this.$description = $( '<p></p>' );
						this.$href = $( '<a href="#"></a>' );
						this.$details = $( '<div class="og-details"></div>' ).append( this.$title, this.$description, this.$href );
						this.$loading = $( '<div class="og-loading"></div>' );
						this.$fullimage = $( '<div class="og-fullimg"></div>' ).append( this.$loading );
						this.$closePreview = $( '<span class="og-close"></span>' );
						this.$previewInner = $( '<div class="og-expander-inner"></div>' ).append( this.$closePreview, this.$fullimage, this.$details );
						this.$previewEl = $( '<div class="og-expander"></div>' ).append( this.$previewInner );
						this.$item.append( this.getEl() );
						if( support ) {
							this.setTransition();
						}
					},
					update : function( $item ) {
						if( $item ) {
							this.$item = $item;
						}
						
						if( current !== -1 ) {
							var $currentItem = $items.eq( current );
							$currentItem.removeClass( 'og-expanded' );
							this.$item.addClass( 'og-expanded' );
							this.positionPreview();
						}
						current = this.$item.index();
						var $itemEl = this.$item.children( 'a' ),
							eldata = {
								href : $itemEl.attr( 'href' ),
								largesrc : $itemEl.data( 'largesrc' ),
								title : $itemEl.data( 'title' ),
								description : $itemEl.data( 'description' )
							};
						this.$title.html( eldata.title );
						this.$description.html( eldata.description );
						this.$href.attr( 'href', eldata.href );
						var self = this;
						
						if( typeof self.$largeImg != 'undefined' ) {
							self.$largeImg.remove();
						}
						if( self.$fullimage.is( ':visible' ) ) {
							this.$loading.show();
							$( '<img/>' ).load( function() {
								var $img = $( this );
								if( $img.attr( 'src' ) === self.$item.children('a').data( 'largesrc' ) ) {
									self.$loading.hide();
									self.$fullimage.find( 'img' ).remove();
									self.$largeImg = $img.fadeIn( 350 );
									self.$fullimage.append( self.$largeImg );
								}
							} ).attr( 'src', eldata.largesrc );	
						}
					},
					open : function() {
						setTimeout( $.proxy( function() {	
							this.setHeights();
							this.positionPreview();
						}, this ), 25 );
					},
					close : function() {
						var self = this,
							onEndFn = function() {
								if( support ) {
									$( this ).off( transEndEventName );
								}
								self.$item.removeClass( 'og-expanded' );
								self.$previewEl.remove();
							};
						setTimeout( $.proxy( function() {
							if( typeof this.$largeImg !== 'undefined' ) {
								this.$largeImg.fadeOut( 'fast' );
							}
							this.$previewEl.css( 'height', 0 );
							var $expandedItem = $items.eq( this.expandedIdx );
							$expandedItem.css( 'height', $expandedItem.data( 'height' ) ).on( transEndEventName, onEndFn );
							if( !support ) {
								onEndFn.call();
							}
						}, this ), 25 );
						
						return false;
					},
					calcHeight : function() {
						var heightPreview = winsize.height - this.$item.data( 'height' ) - marginExpanded,
							itemHeight = winsize.height;
						if( heightPreview < settings.minHeight ) {
							heightPreview = settings.minHeight;
							itemHeight = settings.minHeight + this.$item.data( 'height' ) + marginExpanded;
						}
						this.height = heightPreview;
						this.itemHeight = itemHeight;
					},
					setHeights : function() {
						var self = this,
							onEndFn = function() {
								if( support ) {
									self.$item.off( transEndEventName );
								}
								self.$item.addClass( 'og-expanded' );
							};
						this.calcHeight();
						this.$previewEl.css( 'height', this.height );
						this.$item.css( 'height', this.itemHeight ).on( transEndEventName, onEndFn );
						if( !support ) {
							onEndFn.call();
						}
					},
					positionPreview : function() {
						var position = this.$item.data( 'offsetTop' ),
							previewOffsetT = this.$previewEl.offset().top - scrollExtra,
							scrollVal = this.height + this.$item.data( 'height' ) + marginExpanded <= winsize.height ? position : this.height < winsize.height ? previewOffsetT - ( winsize.height - this.height ) : previewOffsetT;
						
						$body.animate( { scrollTop : scrollVal }, settings.speed );
					},
					setTransition  : function() {
						this.$previewEl.css( 'transition', 'height ' + settings.speed + 'ms ' + settings.easing );
						this.$item.css( 'transition', 'height ' + settings.speed + 'ms ' + settings.easing );
					},
					getEl : function() {
						return this.$previewEl;
					}
				}
				return { 
					init : init,
					addItems : addItems
				};
			})();
		</script>
		<script>
			$(function() {
				Grid.init();
			});
		</script>
</body>
</html>

