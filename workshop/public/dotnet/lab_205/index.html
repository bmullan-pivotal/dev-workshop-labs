<!DOCTYPE html>



<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="alternate" href="/index.xml" type="application/rss+xml" title="Raytheon Pivotal Workshops">
		<link rel="icon" href="/favicon.ico">
		<title>Lab205 - Raytheon Pivotal Workshops</title>
		<link rel="stylesheet" href="/css/highlight.js.min.css">
		<link rel="stylesheet" href="/css/bootstrap.min.css">
		<link rel="stylesheet" href="/css/bootstrap-theme.css">
		<link rel="stylesheet" href="/css/pui-v2.0.0/pivotal-ui.css">
		<link rel="stylesheet" href="/css/theme.css">
		<link rel="stylesheet" href="/css/component.css">

<link rel="stylesheet"  href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/3.1.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="/css/bootie-docs.css">
		<script src="http://raytheon.cfapps.io/js/modernizr.custom.js"></script>

		
		<style type="text/css">
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
		</style>
	</head>

<body role="document">
	
	
	<nav class="navbar navbar-inverse navbar-fixed-top  ">
		<div class="container-fluid">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<div class="nav navbar-brand">
						
							<img class="nav pivotal-logo" src="/Pivotal_Teal.png"/>
						
				</div>
				<a class="navbar-brand navbar-txt" href="/">Raytheon Pivotal Workshops </a>
			</div>
			<div id="navbar" class="navbar-collapse collapse">
				<ul class="nav navbar-nav">
			
				
				
					
					<li ><a class="navbar-txt" href="/lab_requirements">Lab_requirements</a></li>
				
					
					<li ><a class="navbar-txt" href="/billerica_day1">Billerica_day1</a></li>
				
					
					<li ><a class="navbar-txt" href="/billerica_day2">Billerica_day2</a></li>
				
					
					<li ><a class="navbar-txt" href="/billerica_day3">Billerica_day3</a></li>
				
					
					<li ><a class="navbar-txt" href="/cloud_tig">Cloud_tig</a></li>
				
			
			
				<li class="dropdown">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Resources<span class="caret"></span></a>
					<ul class="dropdown-menu" role="menu">
					
                        <li><a target="_blank" href="https://www.youtube.com/playlist?list=PLAdzTan_eSPQ1fuLSBhyB4eEZF7JQM0Mx">All SpringOne Conference Videos</a></li>
                     
                        <li><a target="_blank" href="http://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry-dev/introduction">Try PCF on your Local Workstation with PCF Dev</a></li>
                     
                        <li><a target="_blank" href="http://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry/introduction">Try PCF on the Public Cloud</a></li>
                     
                        <li><a target="_blank" href="/CorporateOverview.pdf">Pivotal Overview</a></li>
                     
                        <li><a target="_blank" href="https://network.pivotal.io/products/pcfdev">PCF Dev</a></li>
                     
                        <li><a target="_blank" href="https://docs.pivotal.io/pivotalcf">PCF Documentation</a></li>
                     
                        <li><a target="_blank" href="https://docs.pivotal.io/pivotalcf/cf-cli/getting-started.html">CF CLI Documentation</a></li>
                     
                        <li><a target="_blank" href="https://www.git-scm.com">Git</a></li>
                     
                        <li><a target="_blank" href="https://try.github.io/levels/1/challenges/1">Git Lessons</a></li>
                     
                        <li><a target="_blank" href="http://platform.spring.io/platform/">Spring Platform</a></li>
                     
                        <li><a target="_blank" href="https://spring.io/docs">Spring Docs</a></li>
                     
                        <li><a target="_blank" href="http://start.spring.io/">Spring Initializer</a></li>
                     
                        <li><a target="_blank" href="https://spring.io/blog/2015/10/19/springone2gx-2015-replay-spring-cloud-at-netflix">Spring Cloud at Netflix</a></li>
                     
                        <li><a target="_blank" href="https://spring.io/blog/2015/07/14/microservices-with-spring">Microservices with Spring</a></li>
                     
                        <li><a target="_blank" href="https://spring.io/guides#tutorials">Spring Guides</a></li>
                     
                        <li><a target="_blank" href="https://network.pivotal.io/">Pivotal Network</a></li>
                     
                        <li><a target="_blank" href="http://docs.pivotal.io">Pivotal Documentation</a></li>
                     
					</ul>
				</li>
			
			
				<li class="dropdown">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Books<span class="caret"></span></a>
					<ul class="dropdown-menu" role="menu">
					
                        <li><a target="_blank" href="/books/Beyond_the_12-Factor_App_Pivotal.pdf">Beyond the 12-Factor App</a></li>
                     
                        <li><a target="_blank" href="/books/Migrating_to_Cloud-Native_App_Architectures_Pivotal.pdf">Migrating to Cloud Native Application Architectures</a></li>
                     
                        <li><a target="_blank" href="/books/Cloud_Foundry_The_Cloud_Native_Platform_Pivotal.pdf">Cloud Foundry The Cloud Native Platform</a></li>
                     
                        <li><a target="_blank" href="http://www.amazon.com/Cloud-Native-Java-Designing-Resilient/dp/1449374646">Cloud Native Java: Designing Resilient Systems with Spring Boot, Spring Cloud, and Cloud Foundry</a></li>
                     
					</ul>
				</li>
			
				
                        
				</ul>
			</div>
		</div>
	</nav>

<div class="container" style="width:95%; padding:5">
	<div class="row">

	    		
		<div class="doc-sidebar" style="width:30%; margin-top:0; float:right; padding:10px;">
			<div class="sidebar-module">
				
		    	<div class="tag-box bg-dark-11" style="padding:10px; margin:20px;">
		    	<h4 class="type-brand-3">Books</h4>
		    	<ul class="list-unstyled">
		    	
		    	<li><a target="_blank" href="/books/Beyond_the_12-Factor_App_Pivotal.pdf">Beyond the 12-Factor App</a><p></p></li>	
		    	
		    	<li><a target="_blank" href="/books/Migrating_to_Cloud-Native_App_Architectures_Pivotal.pdf">Migrating to Cloud Native Application Architectures</a><p></p></li>	
		    	
		    	<li><a target="_blank" href="/books/Cloud_Foundry_The_Cloud_Native_Platform_Pivotal.pdf">Cloud Foundry The Cloud Native Platform</a><p></p></li>	
		    	
		    	<li><a target="_blank" href="http://www.amazon.com/Cloud-Native-Java-Designing-Resilient/dp/1449374646">Cloud Native Java: Designing Resilient Systems with Spring Boot, Spring Cloud, and Cloud Foundry</a><p></p></li>	
		    	
		    	</ul>
		  	</div>
                        <div class="tag-box bg-dark-11" style="padding:10px; margin:20px;">
                        <h4 class="type-brand-3">Resources</h4>
                        <ul class="list-unstyled">
                        
                            <li><a target="_blank" href="https://www.youtube.com/playlist?list=PLAdzTan_eSPQ1fuLSBhyB4eEZF7JQM0Mx">All SpringOne Conference Videos</a><p></p></li>
                        
                            <li><a target="_blank" href="http://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry-dev/introduction">Try PCF on your Local Workstation with PCF Dev</a><p></p></li>
                        
                            <li><a target="_blank" href="http://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry/introduction">Try PCF on the Public Cloud</a><p></p></li>
                        
                            <li><a target="_blank" href="/CorporateOverview.pdf">Pivotal Overview</a><p></p></li>
                        
                            <li><a target="_blank" href="https://network.pivotal.io/products/pcfdev">PCF Dev</a><p></p></li>
                        
                            <li><a target="_blank" href="https://docs.pivotal.io/pivotalcf">PCF Documentation</a><p></p></li>
                        
                            <li><a target="_blank" href="https://docs.pivotal.io/pivotalcf/cf-cli/getting-started.html">CF CLI Documentation</a><p></p></li>
                        
                            <li><a target="_blank" href="https://www.git-scm.com">Git</a><p></p></li>
                        
                            <li><a target="_blank" href="https://try.github.io/levels/1/challenges/1">Git Lessons</a><p></p></li>
                        
                            <li><a target="_blank" href="http://platform.spring.io/platform/">Spring Platform</a><p></p></li>
                        
                            <li><a target="_blank" href="https://spring.io/docs">Spring Docs</a><p></p></li>
                        
                            <li><a target="_blank" href="http://start.spring.io/">Spring Initializer</a><p></p></li>
                        
                            <li><a target="_blank" href="https://spring.io/blog/2015/10/19/springone2gx-2015-replay-spring-cloud-at-netflix">Spring Cloud at Netflix</a><p></p></li>
                        
                            <li><a target="_blank" href="https://spring.io/blog/2015/07/14/microservices-with-spring">Microservices with Spring</a><p></p></li>
                        
                            <li><a target="_blank" href="https://spring.io/guides#tutorials">Spring Guides</a><p></p></li>
                        
                            <li><a target="_blank" href="https://network.pivotal.io/">Pivotal Network</a><p></p></li>
                        
                            <li><a target="_blank" href="http://docs.pivotal.io">Pivotal Documentation</a><p></p></li>
                        
                        </ul>
                        </div>
			</div>
		</div>
		


		<div class="col-sm-8 doc-main" style="width:70%; float:left; padding:30px;">
			<main role="main">
				<article>
					<a id="title"></a>
					<div class="doc-entry-meta">
					</div>
					<section>
						<div class="sect1">
<h2 id="_lab_10_running_existing_legacy_iis_apps">Lab 10 - Running existing legacy IIS apps</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_code_goal_code"><code>Goal</code></h2>
<div class="sectionbody">
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>The goals for this lab are to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Get a legacy dotnet app and port it to Cloud Foundry</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Approximate time: 1 hour</p>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The completed code for this lab can be found at <code>$COURSE_HOME/dotnettx/lab05/</code>.
</td>
</tr>
</table>
</div>
<div class="quoteblock abstract">
<blockquote>
<div class="paragraph">
<p>The next series of labs will walk you through a typical challange of taking an existing application, getting it to run on a Cloud Foundry, and will teach you the skills necesary to modernize it in an iterative way. While working with old codebase is usually considered a chore by the developer doing, the technology usually moves ahead faster then the lifespan of a particular business applicaiton. It is therefore vital that the developers posses the skills necessary not only to deal with existing code bases when moving the paradigm towards running apps in the cloud, but also how to improve the quality of the codebase over time rather than a shotgun all-or-nothing approach.</p>
</div>
<div class="paragraph">
<p>In this lab we will be taking an existing legacy application and getting it to run on PCF.  The application we will be using is a Fortune Teller app, which will serve up random quotes at the press of a button. From an architectual point of view the app consists of a typical client server with ASP.NET WebForms front end talking to WCF backend. The WCF backend talks to a MySQL database which stores the quotes, and uses raw ADO.NET to interact with the database. The code base can be considered obsolete by todays coding standard, but is still incredibly common in many enterprises application portfolios.</p>
</div>
<div class="paragraph">
<p>Before starting the lab, please make sure that you have the necessary requirements for running the workshop</p>
</div>
</blockquote>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_open_visual_studio_solution">Open Visual Studio Solution</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start Visual Studio and open the solution/folder  <em>Workshop/FortuneTeller/FortuneTeller.sln</em></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Examine the project structure.</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p><em>FortunesForms</em> is our front end and is a ASP.NET WebForms application.</p>
</li>
<li>
<p><em>FortunesBackend</em> is our server side component</p>
</li>
<li>
<p><em>FortunesCommon</em> stores shared common code. Examine the structure of ICookieService and FortuneCookie</p>
</li>
</ol>
</div>
</li>
<li>
<p>Notice that the projects are targeting .NET Framework 4.5.2 and in their current structure require IIS in order to run</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_build_and_verify">Build and verify</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As we strive to optimize developer workflow it is <strong>essential</strong> to strive to maintain as close of parity between environments as possible. This way you minimize the number of factors that can affect the stability and behavior of code as it is promoted between environments. We going to ensure that we can run the app locallly before we try deploying it. We&#8217;re not going to focus on database just yet as this will be covered in the next lab, but we will ensure that our client and server can communicate with each other.</p>
</div>
<div class="paragraph">
<p>Lets configure our solution to launch both backend and UI when we start the debug session.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Right click on Solution &#8594; Properties. Change <em>Startup Project</em> to <em>Multiple startup projects</em> and set <em>FortunesForms</em> and <em>FortunesBackend</em> to <em>Start</em> action.</p>
</li>
<li>
<p>Go ahead and launch the application (F5).</p>
</li>
<li>
<p>Navigate to <code><a href="http://localhost:55962/" class="bare">http://localhost:55962/</a></code> and we should be greeted with the main screen of the application. If you try to click the <em>Show me my Fortune</em> button we are going to get an error, and this is to be expected as we have not connected the database yet.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_preparing_for_deployment_to_pivotal_cloud_foundry">Preparing for deployment to Pivotal Cloud Foundry</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since we will be doing multiple deployments to Cloud Foundry, lets make our job easier by creating a <code>manifest.yml</code> file. While manifest is not required to deploy to Cloud Foundry, it allows us to preconfigure a lot of settings that would otherwise have to be specified every time as arguments into <code>cf.exe</code> when we push.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Under FortunesBackend, create a new file called <code>manfist.yml</code>. (In Solution Explorer, right click on FortunesBackend project &#8594; add new item &#8594; General &#8594; Text File)</p>
</li>
<li>
<p>Paste the following as content</p>
<div class="listingblock">
<div class="title">manifest.yml</div>
<div class="content">
<pre>---
applications:
- name: FortunesBackend
  host: FortunesBackendSTUDENTID
  memory: 512M
  stack: windows2012R2
  health-check-type: http
  buildpack: hwc_buildpack</pre>
</div>
</div>
</li>
<li>
<p>Modify <code>host</code> replacing <code>STUDENTID</code> with your assigned number.</p>
</li>
<li>
<p>Notice the following:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>name</code>: We are going to name our apps FortunesBackend</p>
</li>
<li>
<p><code>host</code>: We are going to give it a hostname of FortunesBackend + your student id. Because everyone will be deploying the same app into the space, we want to make sure there are no URL collisions.</p>
</li>
<li>
<p><code>memory</code>: Limit it to 512M as the default is 1G. This is a small app, so lets only use what the app actually needs</p>
</li>
<li>
<p><code>stack</code>: This instructs cloud foundry on which operating system to deploy the code. In this case it&#8217;s IIS based app, so it has to go on windows. (You can check which stacks are available by issuing <code>cf stacks</code> command)</p>
</li>
<li>
<p><code>health-check-type</code>: Cloud foundry will monitor your app after it&#8217;s started to ensure it&#8217;s healthy and running. <code>http</code> health check will make cloud foundry periodically hit the app and ensure it returns HTTP 200 (Ok). Other possible values are <code>none</code>, <code>port</code> and <code>process</code>.</p>
</li>
<li>
<p><code>buildpack</code>: While cloud foundry can auto detect the buildpack, this usually takes extra time. We&#8217;re going to explicitly specify the <code>hwc_buildpack</code> which will introduce the required dependencies and launch the app as an IIS hosted app.</p>
</li>
</ol>
</div>
</li>
<li>
<p>In solution explorer, click on</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We&#8217;re going to use the standard .NET publish feature in order to compile the code and include only the files necessary to run the app. The default settings will use a preconfigured publish profile that will put our web application in a neat <em>publish</em> folder at the solution level. If you&#8217;re not familiar with publish profiles, expand solution and examine Properties &gt; PublishProfiles &gt; FolderProfile.pubxml.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Right click on <em>FortunesBackend</em> project and select <em>Publish</em>. Notice the target location uses our preconfigured publish profile.</p>
</li>
<li>
<p>Perform the same instructions as above but for <em>FortunesForms</em>. Don&#8217;t forget to adjust the <code>manifest.yml</code> accordingly. Here&#8217;s what it should look like:</p>
<div class="listingblock">
<div class="title">manifest.yml</div>
<div class="content">
<pre>applications:
- name: FortunesForms
  host: FortunesFormsSTUDENTID
  memory: 512M
  stack: windows2012R2
  health-check-type: http
  buildpack: hwc_buildpack</pre>
</div>
</div>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/lab-05-publish.png" alt="lab 05 publish">
</div>
</div>
<div class="paragraph">
<p>We should now have 2 apps packaged as deployment artifacts ready to be pushed to PCF inside <code>/publish/</code> folder.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_pushing_to_cloud_foundry">Pushing to Cloud Foundry</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We are going to publish both artifacts for <em>FortunesBackend</em> and <em>FortunesForms</em> as seperate apps into Pivotal Cloud Foundry.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Drop into command line and change directory to  <code>publish\FortunesBackend</code> folder.</p>
</li>
<li>
<p>Issue command <code>cf push</code>. Ensure that app pushed successfully</p>
<div class="listingblock">
<div class="content">
<pre>App FortunesBackend was started using this command `.cloudfoundry\hwc.exe`

Showing health and status for app FortunesBackend in org student-1 / space development as admin...
OK

requested state: started
instances: 1/1
usage: 512M x 1 instances
urls: FortunesBackend1.apps.pcf.space
last uploaded: Mon Aug 21 19:09:52 UTC 2017
stack: windows2012R2
buildpack: hwc_buildpack

     state     since                    cpu    memory           disk          details
#0   running   2017-08-21 03:10:15 PM   0.0%   224.4M of 512M   19.5M of 1G</pre>
</div>
</div>
</li>
<li>
<p>Verify that the app is accessible by browsing to the URL. The default page is empty, but we should be able to navigate to the <code>/FortuneServiceWCF.svc</code> endpoint to ensure that the app is properly started.</p>
</li>
<li>
<p>Change directory  <code>publish\FortunesForms</code> folder</p>
<div class="listingblock">
<div class="content">
<pre>&gt; cd ..\FortunesForms</pre>
</div>
</div>
</li>
<li>
<p>Adjust the Front End config file to point to the backend URL. Edit <code>\publish\FortunesForms\web.config</code> in text editor and change the path to the backend URL (see output of <code>cf push</code> command from step above).</p>
<div class="listingblock">
<div class="title">Replace</div>
<div class="content">
<pre>&lt;endpoint address="http://localhost:56279/FortuneServiceWCF.svc" binding="basicHttpBinding" bindingConfiguration="BasicHttpBinding_ICookieService" contract="FortunesCommon.ICookieService" name="FortuneServiceWcf" /&gt;</pre>
</div>
</div>
<div class="listingblock">
<div class="title">with</div>
<div class="content">
<pre>&lt;endpoint address="http://REPLACE_ME_WITH_BACKENDURL/FortuneServiceWCF.svc" binding="basicHttpBinding" bindingConfiguration="BasicHttpBinding_ICookieService" contract="FortunesCommon.ICookieService" name="FortuneServiceWcf" /&gt;</pre>
</div>
</div>
</li>
<li>
<p>Push <code>FortunesForms</code> app using</p>
<div class="listingblock">
<div class="content">
<pre>&gt; cf push</pre>
</div>
</div>
</li>
<li>
<p>Verify that we can access the app by going to our FortuneForms url. If you forgot the URL, you can always look it up with <code>cf app FortunesForms</code>. If we try to retrieve fortune by clicking the button on the UI, we should get the error that we can&#8217;t communicate with MySQL (next step), but it does mean we can talk to backend successfully.</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/lab-05-nosqlconnection.png" alt="lab 05 nosqlconnection">
</div>
</div>
</div>
</div>

					</section>
				</article>
			</main>
		</div> 
	</div> 
</div>

		




<hr />
<div class="container">
	<div class="row">
		<div class="col-sm-8">
			<p class="doc-footer-em"><a href="#">Back to TOP</a></p>
		</div>
	</div>

</div> 
          
<footer class="doc-footer">
        <span>Last Updated on  2016-03-23 19:58:14 -0400 EDT  </span>
	
	<p>Copyright (c) 2015, Pivotal; All rights reserved.</p>
</footer>



<script src="/js/jquery-1.11.2.min.js"></script>
<script src="/js/bootstrap.min.js"></script>

<script src="/js/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script src="/js/ie10-viewport-bug-workaround.js"></script>
		<script>
			var $event = $.event,
			$special,
			resizeTimeout;
			$special = $event.special.debouncedresize = {
				setup: function() {
					$( this ).on( "resize", $special.handler );
				},
				teardown: function() {
					$( this ).off( "resize", $special.handler );
				},
				handler: function( event, execAsap ) {
					var context = this,
						args = arguments,
						dispatch = function() {
							event.type = "debouncedresize";
							$event.dispatch.apply( context, args );
						};
					if ( resizeTimeout ) {
						clearTimeout( resizeTimeout );
					}
					execAsap ?
						dispatch() :
						resizeTimeout = setTimeout( dispatch, $special.threshold );
				},
				threshold: 250
			};
			var BLANK = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
			$.fn.imagesLoaded = function( callback ) {
				var $this = this,
					deferred = $.isFunction($.Deferred) ? $.Deferred() : 0,
					hasNotify = $.isFunction(deferred.notify),
					$images = $this.find('img').add( $this.filter('img') ),
					loaded = [],
					proper = [],
					broken = [];
				if ($.isPlainObject(callback)) {
					$.each(callback, function (key, value) {
						if (key === 'callback') {
							callback = value;
						} else if (deferred) {
							deferred[key](value);
						}
					});
				}
				function doneLoading() {
					var $proper = $(proper),
						$broken = $(broken);
					if ( deferred ) {
						if ( broken.length ) {
							deferred.reject( $images, $proper, $broken );
						} else {
							deferred.resolve( $images );
						}
					}
					if ( $.isFunction( callback ) ) {
						callback.call( $this, $images, $proper, $broken );
					}
				}
				function imgLoaded( img, isBroken ) {
					if ( img.src === BLANK || $.inArray( img, loaded ) !== -1 ) {
						return;
					}
					loaded.push( img );
					if ( isBroken ) {
						broken.push( img );
					} else {
						proper.push( img );
					}
					$.data( img, 'imagesLoaded', { isBroken: isBroken, src: img.src } );
					if ( hasNotify ) {
						deferred.notifyWith( $(img), [ isBroken, $images, $(proper), $(broken) ] );
					}
					if ( $images.length === loaded.length ){
						setTimeout( doneLoading );
						$images.unbind( '.imagesLoaded' );
					}
				}
				if ( !$images.length ) {
					doneLoading();
				} else {
					$images.bind( 'load.imagesLoaded error.imagesLoaded', function( event ){
						imgLoaded( event.target, event.type === 'error' );
					}).each( function( i, el ) {
						var src = el.src;
						var cached = $.data( el, 'imagesLoaded' );
						if ( cached && cached.src === src ) {
							imgLoaded( el, cached.isBroken );
							return;
						}
						if ( el.complete && el.naturalWidth !== undefined ) {
							imgLoaded( el, el.naturalWidth === 0 || el.naturalHeight === 0 );
							return;
						}
						if ( el.readyState || el.complete ) {
							el.src = BLANK;
							el.src = src;
						}
					});
				}
				return deferred ? deferred.promise( $this ) : $this;
			};
			var Grid = (function() {
				var $grid = $( '#og-grid' ),
					$items = $grid.children( 'li' ),
					current = -1,
					previewPos = -1,
					scrollExtra = 0,
					marginExpanded = 10,
					$window = $( window ), winsize,
					$body = $( 'html, body' ),
					transEndEventNames = {
						'WebkitTransition' : 'webkitTransitionEnd',
						'MozTransition' : 'transitionend',
						'OTransition' : 'oTransitionEnd',
						'msTransition' : 'MSTransitionEnd',
						'transition' : 'transitionend'
					},
					transEndEventName = transEndEventNames[ Modernizr.prefixed( 'transition' ) ],
					support = Modernizr.csstransitions,
					settings = {
						minHeight : 500,
						speed : 350,
						easing : 'ease'
					};
				function init( config ) {
					
					settings = $.extend( true, {}, settings, config );
					$grid.imagesLoaded( function() {
						saveItemInfo( true );
						getWinSize();
						initEvents();
					} );
				}
				function addItems( $newitems ) {
					$items = $items.add( $newitems );
					$newitems.each( function() {
						var $item = $( this );
						$item.data( {
							offsetTop : $item.offset().top,
							height : $item.height()
						} );
					} );
					initItemsEvents( $newitems );
				}
				function saveItemInfo( saveheight ) {
					$items.each( function() {
						var $item = $( this );
						$item.data( 'offsetTop', $item.offset().top );
						if( saveheight ) {
							$item.data( 'height', $item.height() );
						}
					} );
				}
				function initEvents() {
					
					initItemsEvents( $items );
					
					$window.on( 'debouncedresize', function() {
						
						scrollExtra = 0;
						previewPos = -1;
						saveItemInfo();
						getWinSize();
						var preview = $.data( this, 'preview' );
						if( typeof preview != 'undefined' ) {
							hidePreview();
						}
					} );
				}
				function initItemsEvents( $items ) {
					$items.on( 'click', 'span.og-close', function() {
						hidePreview();
						return false;
					} ).children( 'a' ).on( 'click', function(e) {
						var $item = $( this ).parent();
						current === $item.index() ? hidePreview() : showPreview( $item );
						return false;
					} );
				}
				function getWinSize() {
					winsize = { width : $window.width(), height : $window.height() };
				}
				function showPreview( $item ) {
					var preview = $.data( this, 'preview' ),
						position = $item.data( 'offsetTop' );
					scrollExtra = 0;
					if( typeof preview != 'undefined' ) {
						if( previewPos !== position ) {
							if( position > previewPos ) {
								scrollExtra = preview.height;
							}
							hidePreview();
						}
						else {
							preview.update( $item );
							return false;
						}
						
					}
					previewPos = position;
					preview = $.data( this, 'preview', new Preview( $item ) );
					preview.open();
				}
				function hidePreview() {
					current = -1;
					var preview = $.data( this, 'preview' );
					preview.close();
					$.removeData( this, 'preview' );
				}
				function Preview( $item ) {
					this.$item = $item;
					this.expandedIdx = this.$item.index();
					this.create();
					this.update();
				}
				Preview.prototype = {
					create : function() {
						this.$title = $( '<h3></h3>' );
						this.$description = $( '<p></p>' );
						this.$href = $( '<a href="#"></a>' );
						this.$details = $( '<div class="og-details"></div>' ).append( this.$title, this.$description, this.$href );
						this.$loading = $( '<div class="og-loading"></div>' );
						this.$fullimage = $( '<div class="og-fullimg"></div>' ).append( this.$loading );
						this.$closePreview = $( '<span class="og-close"></span>' );
						this.$previewInner = $( '<div class="og-expander-inner"></div>' ).append( this.$closePreview, this.$fullimage, this.$details );
						this.$previewEl = $( '<div class="og-expander"></div>' ).append( this.$previewInner );
						this.$item.append( this.getEl() );
						if( support ) {
							this.setTransition();
						}
					},
					update : function( $item ) {
						if( $item ) {
							this.$item = $item;
						}
						
						if( current !== -1 ) {
							var $currentItem = $items.eq( current );
							$currentItem.removeClass( 'og-expanded' );
							this.$item.addClass( 'og-expanded' );
							this.positionPreview();
						}
						current = this.$item.index();
						var $itemEl = this.$item.children( 'a' ),
							eldata = {
								href : $itemEl.attr( 'href' ),
								largesrc : $itemEl.data( 'largesrc' ),
								title : $itemEl.data( 'title' ),
								description : $itemEl.data( 'description' )
							};
						this.$title.html( eldata.title );
						this.$description.html( eldata.description );
						this.$href.attr( 'href', eldata.href );
						var self = this;
						
						if( typeof self.$largeImg != 'undefined' ) {
							self.$largeImg.remove();
						}
						if( self.$fullimage.is( ':visible' ) ) {
							this.$loading.show();
							$( '<img/>' ).load( function() {
								var $img = $( this );
								if( $img.attr( 'src' ) === self.$item.children('a').data( 'largesrc' ) ) {
									self.$loading.hide();
									self.$fullimage.find( 'img' ).remove();
									self.$largeImg = $img.fadeIn( 350 );
									self.$fullimage.append( self.$largeImg );
								}
							} ).attr( 'src', eldata.largesrc );	
						}
					},
					open : function() {
						setTimeout( $.proxy( function() {	
							this.setHeights();
							this.positionPreview();
						}, this ), 25 );
					},
					close : function() {
						var self = this,
							onEndFn = function() {
								if( support ) {
									$( this ).off( transEndEventName );
								}
								self.$item.removeClass( 'og-expanded' );
								self.$previewEl.remove();
							};
						setTimeout( $.proxy( function() {
							if( typeof this.$largeImg !== 'undefined' ) {
								this.$largeImg.fadeOut( 'fast' );
							}
							this.$previewEl.css( 'height', 0 );
							var $expandedItem = $items.eq( this.expandedIdx );
							$expandedItem.css( 'height', $expandedItem.data( 'height' ) ).on( transEndEventName, onEndFn );
							if( !support ) {
								onEndFn.call();
							}
						}, this ), 25 );
						
						return false;
					},
					calcHeight : function() {
						var heightPreview = winsize.height - this.$item.data( 'height' ) - marginExpanded,
							itemHeight = winsize.height;
						if( heightPreview < settings.minHeight ) {
							heightPreview = settings.minHeight;
							itemHeight = settings.minHeight + this.$item.data( 'height' ) + marginExpanded;
						}
						this.height = heightPreview;
						this.itemHeight = itemHeight;
					},
					setHeights : function() {
						var self = this,
							onEndFn = function() {
								if( support ) {
									self.$item.off( transEndEventName );
								}
								self.$item.addClass( 'og-expanded' );
							};
						this.calcHeight();
						this.$previewEl.css( 'height', this.height );
						this.$item.css( 'height', this.itemHeight ).on( transEndEventName, onEndFn );
						if( !support ) {
							onEndFn.call();
						}
					},
					positionPreview : function() {
						var position = this.$item.data( 'offsetTop' ),
							previewOffsetT = this.$previewEl.offset().top - scrollExtra,
							scrollVal = this.height + this.$item.data( 'height' ) + marginExpanded <= winsize.height ? position : this.height < winsize.height ? previewOffsetT - ( winsize.height - this.height ) : previewOffsetT;
						
						$body.animate( { scrollTop : scrollVal }, settings.speed );
					},
					setTransition  : function() {
						this.$previewEl.css( 'transition', 'height ' + settings.speed + 'ms ' + settings.easing );
						this.$item.css( 'transition', 'height ' + settings.speed + 'ms ' + settings.easing );
					},
					getEl : function() {
						return this.$previewEl;
					}
				}
				return { 
					init : init,
					addItems : addItems
				};
			})();
		</script>
		<script>
			$(function() {
				Grid.init();
			});
		</script>
</body>
</html>

