<!DOCTYPE html>



<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="alternate" href="/index.xml" type="application/rss+xml" title="Raytheon Pivotal Workshops">
		<link rel="icon" href="/favicon.ico">
		<title>Lab206 - Raytheon Pivotal Workshops</title>
		<link rel="stylesheet" href="/css/highlight.js.min.css">
		<link rel="stylesheet" href="/css/bootstrap.min.css">
		<link rel="stylesheet" href="/css/bootstrap-theme.css">
		<link rel="stylesheet" href="/css/pui-v2.0.0/pivotal-ui.css">
		<link rel="stylesheet" href="/css/theme.css">
		<link rel="stylesheet" href="/css/component.css">

<link rel="stylesheet"  href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/3.1.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="/css/bootie-docs.css">
		<script src="http://raytheon.cfapps.io/js/modernizr.custom.js"></script>

		
		<style type="text/css">
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
		</style>
	</head>

<body role="document">
	
	
	<nav class="navbar navbar-inverse navbar-fixed-top  ">
		<div class="container-fluid">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<div class="nav navbar-brand">
						
							<img class="nav pivotal-logo" src="/Pivotal_Teal.png"/>
						
				</div>
				<a class="navbar-brand navbar-txt" href="/">Raytheon Pivotal Workshops </a>
			</div>
			<div id="navbar" class="navbar-collapse collapse">
				<ul class="nav navbar-nav">
			
				
				
					
					<li ><a class="navbar-txt" href="/lab_requirements">Lab_requirements</a></li>
				
					
					<li ><a class="navbar-txt" href="/billerica_day1">Billerica_day1</a></li>
				
					
					<li ><a class="navbar-txt" href="/billerica_day2">Billerica_day2</a></li>
				
					
					<li ><a class="navbar-txt" href="/billerica_day3">Billerica_day3</a></li>
				
					
					<li ><a class="navbar-txt" href="/cloud_tig">Cloud_tig</a></li>
				
			
			
				<li class="dropdown">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Resources<span class="caret"></span></a>
					<ul class="dropdown-menu" role="menu">
					
                        <li><a target="_blank" href="https://www.youtube.com/playlist?list=PLAdzTan_eSPQ1fuLSBhyB4eEZF7JQM0Mx">All SpringOne Conference Videos</a></li>
                     
                        <li><a target="_blank" href="http://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry-dev/introduction">Try PCF on your Local Workstation with PCF Dev</a></li>
                     
                        <li><a target="_blank" href="http://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry/introduction">Try PCF on the Public Cloud</a></li>
                     
                        <li><a target="_blank" href="/CorporateOverview.pdf">Pivotal Overview</a></li>
                     
                        <li><a target="_blank" href="https://network.pivotal.io/products/pcfdev">PCF Dev</a></li>
                     
                        <li><a target="_blank" href="https://docs.pivotal.io/pivotalcf">PCF Documentation</a></li>
                     
                        <li><a target="_blank" href="https://docs.pivotal.io/pivotalcf/cf-cli/getting-started.html">CF CLI Documentation</a></li>
                     
                        <li><a target="_blank" href="https://www.git-scm.com">Git</a></li>
                     
                        <li><a target="_blank" href="https://try.github.io/levels/1/challenges/1">Git Lessons</a></li>
                     
                        <li><a target="_blank" href="http://platform.spring.io/platform/">Spring Platform</a></li>
                     
                        <li><a target="_blank" href="https://spring.io/docs">Spring Docs</a></li>
                     
                        <li><a target="_blank" href="http://start.spring.io/">Spring Initializer</a></li>
                     
                        <li><a target="_blank" href="https://spring.io/blog/2015/10/19/springone2gx-2015-replay-spring-cloud-at-netflix">Spring Cloud at Netflix</a></li>
                     
                        <li><a target="_blank" href="https://spring.io/blog/2015/07/14/microservices-with-spring">Microservices with Spring</a></li>
                     
                        <li><a target="_blank" href="https://spring.io/guides#tutorials">Spring Guides</a></li>
                     
                        <li><a target="_blank" href="https://network.pivotal.io/">Pivotal Network</a></li>
                     
                        <li><a target="_blank" href="http://docs.pivotal.io">Pivotal Documentation</a></li>
                     
					</ul>
				</li>
			
			
				<li class="dropdown">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Books<span class="caret"></span></a>
					<ul class="dropdown-menu" role="menu">
					
                        <li><a target="_blank" href="/books/Beyond_the_12-Factor_App_Pivotal.pdf">Beyond the 12-Factor App</a></li>
                     
                        <li><a target="_blank" href="/books/Migrating_to_Cloud-Native_App_Architectures_Pivotal.pdf">Migrating to Cloud Native Application Architectures</a></li>
                     
                        <li><a target="_blank" href="/books/Cloud_Foundry_The_Cloud_Native_Platform_Pivotal.pdf">Cloud Foundry The Cloud Native Platform</a></li>
                     
                        <li><a target="_blank" href="http://www.amazon.com/Cloud-Native-Java-Designing-Resilient/dp/1449374646">Cloud Native Java: Designing Resilient Systems with Spring Boot, Spring Cloud, and Cloud Foundry</a></li>
                     
					</ul>
				</li>
			
				
                        
				</ul>
			</div>
		</div>
	</nav>

<div class="container" style="width:95%; padding:5">
	<div class="row">

	    		
		<div class="doc-sidebar" style="width:30%; margin-top:0; float:right; padding:10px;">
			<div class="sidebar-module">
				
		    	<div class="tag-box bg-dark-11" style="padding:10px; margin:20px;">
		    	<h4 class="type-brand-3">Books</h4>
		    	<ul class="list-unstyled">
		    	
		    	<li><a target="_blank" href="/books/Beyond_the_12-Factor_App_Pivotal.pdf">Beyond the 12-Factor App</a><p></p></li>	
		    	
		    	<li><a target="_blank" href="/books/Migrating_to_Cloud-Native_App_Architectures_Pivotal.pdf">Migrating to Cloud Native Application Architectures</a><p></p></li>	
		    	
		    	<li><a target="_blank" href="/books/Cloud_Foundry_The_Cloud_Native_Platform_Pivotal.pdf">Cloud Foundry The Cloud Native Platform</a><p></p></li>	
		    	
		    	<li><a target="_blank" href="http://www.amazon.com/Cloud-Native-Java-Designing-Resilient/dp/1449374646">Cloud Native Java: Designing Resilient Systems with Spring Boot, Spring Cloud, and Cloud Foundry</a><p></p></li>	
		    	
		    	</ul>
		  	</div>
                        <div class="tag-box bg-dark-11" style="padding:10px; margin:20px;">
                        <h4 class="type-brand-3">Resources</h4>
                        <ul class="list-unstyled">
                        
                            <li><a target="_blank" href="https://www.youtube.com/playlist?list=PLAdzTan_eSPQ1fuLSBhyB4eEZF7JQM0Mx">All SpringOne Conference Videos</a><p></p></li>
                        
                            <li><a target="_blank" href="http://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry-dev/introduction">Try PCF on your Local Workstation with PCF Dev</a><p></p></li>
                        
                            <li><a target="_blank" href="http://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry/introduction">Try PCF on the Public Cloud</a><p></p></li>
                        
                            <li><a target="_blank" href="/CorporateOverview.pdf">Pivotal Overview</a><p></p></li>
                        
                            <li><a target="_blank" href="https://network.pivotal.io/products/pcfdev">PCF Dev</a><p></p></li>
                        
                            <li><a target="_blank" href="https://docs.pivotal.io/pivotalcf">PCF Documentation</a><p></p></li>
                        
                            <li><a target="_blank" href="https://docs.pivotal.io/pivotalcf/cf-cli/getting-started.html">CF CLI Documentation</a><p></p></li>
                        
                            <li><a target="_blank" href="https://www.git-scm.com">Git</a><p></p></li>
                        
                            <li><a target="_blank" href="https://try.github.io/levels/1/challenges/1">Git Lessons</a><p></p></li>
                        
                            <li><a target="_blank" href="http://platform.spring.io/platform/">Spring Platform</a><p></p></li>
                        
                            <li><a target="_blank" href="https://spring.io/docs">Spring Docs</a><p></p></li>
                        
                            <li><a target="_blank" href="http://start.spring.io/">Spring Initializer</a><p></p></li>
                        
                            <li><a target="_blank" href="https://spring.io/blog/2015/10/19/springone2gx-2015-replay-spring-cloud-at-netflix">Spring Cloud at Netflix</a><p></p></li>
                        
                            <li><a target="_blank" href="https://spring.io/blog/2015/07/14/microservices-with-spring">Microservices with Spring</a><p></p></li>
                        
                            <li><a target="_blank" href="https://spring.io/guides#tutorials">Spring Guides</a><p></p></li>
                        
                            <li><a target="_blank" href="https://network.pivotal.io/">Pivotal Network</a><p></p></li>
                        
                            <li><a target="_blank" href="http://docs.pivotal.io">Pivotal Documentation</a><p></p></li>
                        
                        </ul>
                        </div>
			</div>
		</div>
		


		<div class="col-sm-8 doc-main" style="width:70%; float:left; padding:30px;">
			<main role="main">
				<article>
					<a id="title"></a>
					<div class="doc-entry-meta">
					</div>
					<section>
						<div class="sect1">
<h2 id="_lab_13_removing_dependence_on_file_configuration">Lab 13 - Removing dependence on file configuration</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_code_goal_code"><code>Goal</code></h2>
<div class="sectionbody">
<div class="openblock">
<div class="content">
<div class="paragraph">
<p>The goals for this lab are to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Remove dependence on file configuration</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Approximate time: 15 mins</p>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The completed code for this lab can be found at <code>$COURSE_HOME/dotnettx/lab06/</code>.
</td>
</tr>
</table>
</div>
<div class="quoteblock abstract">
<blockquote>
As you saw, we had to tweak the web.config after we published in order to make environment specific config adjustments - in this case the URL of the backend. For the longest time .NET have consolidated the configuration information for application inside <code>web.config</code> file (or <code>app.config</code> for non IIS hosted apps). While this sounds flexible enough in theory, in practice managing the configuration changes in web.config creates a number of challanges.
</blockquote>
</div>
<div class="quoteblock abstract">
<blockquote>
When we build our code we generate a deployment artifact - something that will run on an a host server. <strong>Deployment artifacts are supposed to be immutable - they do not change between environments</strong>. Unfortunately web.config violates this concept, as it requires environment specific information to be stored as part of our artifact. Multiple methods exist that address this via config file transform or introduce different copies of config file based on environments, but they still require us to produce different copies of our build artifact.
</blockquote>
</div>
<div class="quoteblock abstract">
<blockquote>
 .NET Core introduces a new configuration framework to simplify config management. We can now define multiple sources of our config via providers and give them priority. Same values declared in multiple providers will be resolved based on provider presedence. This means we can bundle some default settings via <code>appsettings.json</code>, and overwrite them by including either an <em>additional</em> file such as appsettings.prod.json, <strong>or</strong> overwrite them via environmental variables, <strong>or</strong> leverage external service to store our configuration such as <strong>Spring Config Server</strong>. We will explore Spring Config Server in later demos.
</blockquote>
</div>
<div class="paragraph">
<p>When running apps on PCF, we can cleanly declare dependencies our apps have on external systems via service bindings. While there are many specific services in the marketplace, we can also use a special generic one called <code>User Provided Service Instance</code>. This service lets us define an arbitrary piece of information as a service and bind it to our applications, be it a connection string to an external database or a URL of a well known service or app. All service bindings attached to the app will be injected when the app starts using <code>VCAP_SERVICES</code> environmental variable in JSON format.</p>
</div>
<div class="paragraph">
<p>In this exercise we are going to refactor our app to loosen dependency on config file by leveraging <em>User Provided Service Instance</em> to store the URL of our backend. This will allow our codebase to be deployed into any org/space where this service has been configured without tweaking with our artifacts before deployment, greatly simplifying the process.</p>
</div>
<div class="paragraph">
<p>We will be using Steeltoe library in order to help parse our the config changes from <code>VCAP_SERVICES</code> environmental variable when running on PCF. Steeltoe works in conjuction with ASP.NET Core configuration and Dependency Injection frameworks. Because ASP.NET Core is modular and compatible with .NET Framework, we can leverage portions of it to our legacy codebase that deal with these 2 specific tasks. Because ASP.NET core dependency injection does not support WebForms, we will be using Autofac dependency injection container to act as the glue between WebForms and ASP.NET Core DI.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add <em>NuGet</em> references to  <em>FortunesForms</em> for <code>Steeltoe.Extensions.Configuration.CloudFoundry</code>,</p>
<div class="listingblock">
<div class="title">Package Manager Console</div>
<div class="content">
<pre>&gt; Install-Package Steeltoe.Extensions.Configuration.CloudFoundry -Project FortunesForms
&gt; Install-Package Microsoft.Extensions.DependencyInjection -Project FortunesForms
&gt; Install-Package Autofac.Web -Project FortunesForms
&gt; Install-Package Autofac.Extensions.DependencyInjection -Project FortunesForms</pre>
</div>
</div>
</li>
<li>
<p>Modify <code>web.config</code> to enable Autofac to provide dependency injection for WebForms</p>
<div class="listingblock">
<div class="title">Add the following inside <code>configuration &gt; system.webServer</code> node</div>
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;modules&gt;
  &lt;add
    name="ContainerDisposal"
    type="Autofac.Integration.Web.ContainerDisposalModule, Autofac.Integration.Web"
    preCondition="managedHandler"/&gt;
  &lt;add
    name="PropertyInjection"
    type="Autofac.Integration.Web.Forms.PropertyInjectionModule, Autofac.Integration.Web"
    preCondition="managedHandler"/&gt;
&lt;/modules&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Modify <code>Global.asax.cs</code> to look like the following:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c#" data-lang="c#">using System;
using System.Web;
using Autofac;
using Autofac.Extensions.DependencyInjection;
using Autofac.Integration.Web;
using FortunesForms.Services;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using Steeltoe.Extensions.Configuration;

namespace FortunesForms
{
    public class Global : HttpApplication, IContainerProviderAccessor
    {
        // Provider that holds the application container.
        static IContainerProvider _containerProvider;

        // Instance property that will be used by Autofac HttpModules
        // to resolve and inject dependencies.
        public IContainerProvider ContainerProvider =&gt; _containerProvider;

        protected void Application_Start(object sender, EventArgs e)
        {
            // create configuration with two providers.
            // registration order matters - Cloud Foundry is higher priority
            var config = new ConfigurationBuilder()
                .AddJsonFile("appsettings.json")
                .AddCloudFoundry()
                .Build();
            // initialize ASP.NET Core DI service catalog
            var services = new ServiceCollection();
            // register cloud foundry config provider into the catalog via extension method
            // this will allow us to resolve IOptionsSnapshot&lt;CloudFoundryServicesOptions&gt;
            // to access our User Provider Service
            services.AddCloudFoundry(config);
            // register our cookie client into the container
            services.AddTransient&lt;WcfCookieClient&gt;();

            // intialize autofac container
            var builder = new ContainerBuilder();
            // import registrations from ASP.NET Core DI into Autofac
            builder.Populate(services);
            _containerProvider = new ContainerProvider(builder.Build());
        }
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p>Add new file <code>appsettings.json</code> to <code>FortunesForms</code> project</p>
</li>
<li>
<p>Paste the following into <code>appsettings.json</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "vcap": {
    "services": {
      "user-provided": [
        {
          "credentials": {
            "url": "http://localhost:56279/FortuneServiceWCF.svc"
          }
        }
      ]
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will ensure that we have a default URL when running locally even if we don&#8217;t have VCAP_SERVICES environmental variable set</p>
</div>
</li>
<li>
<p>Modify Cookies.aspx.cs to look like the following:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c#" data-lang="c#">using FortunesForms.Services;
using System;
using System.Web.UI;

namespace FortunesForms
{
    public partial class Cookies : Page
    {
        // will be populated by DI (Autofac)
        public WcfCookieClient CookieService { get; set; }
        protected void Page_Load(object sender, EventArgs e)
        {
            this.lblError.Visible = false;
        }

        protected async void btnGetCookie_OnClick(object sender, EventArgs e)
        {
            try
            {
                var cookie = await CookieService.GetCookieAsync();
                this.lblCookie.Text = cookie.Cookie;
            }
            catch (Exception exception)
            {
                Console.WriteLine(exception);
                this.lblError.Text = $"Error has occured: {exception.Message}";
                this.lblError.Visible = true;
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will ensure that our service is coming from dependency injection</p>
</div>
</li>
<li>
<p>Modify <code>WcfCookieClient</code> class to use URI coming from configuration as following:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-c#" data-lang="c#">using System;
using System.Linq;
using System.ServiceModel;
using System.Threading.Tasks;
using FortunesCommon;
using Microsoft.Extensions.Options;
using Steeltoe.Extensions.Configuration.CloudFoundry;

namespace FortunesForms.Services
{
    public class WcfCookieClient
    {
        private readonly IOptionsSnapshot&lt;CloudFoundryServicesOptions&gt; _cfServices;

        public WcfCookieClient(IOptionsSnapshot&lt;CloudFoundryServicesOptions&gt; cfServices)
        {
            _cfServices = cfServices;
        }

        public async Task&lt;FortuneCookie&gt; GetCookieAsync()
        {
            var url = _cfServices.Value.Services
                .Where(x =&gt; x.Name.Equals("FortunesBackend", StringComparison.InvariantCultureIgnoreCase) &amp;&amp; x.Credentials.ContainsKey("url"))
                .Select(x =&gt; x.Credentials["url"].Value)
                .First();
            var channelFactory = new ChannelFactory&lt;ICookieService&gt;("FortuneServiceWcf", new EndpointAddress(url));
            return await channelFactory.CreateChannel().GetRandomCookieAsync();
        }

    }
}</code></pre>
</div>
</div>
</li>
<li>
<p>Create a <em>User Provided Service Instance</em> by issuing the following command</p>
<div class="listingblock">
<div class="content">
<pre>&gt; cf cups FortunesBackend -p url</pre>
</div>
</div>
</li>
<li>
<p>When prompted, enter the full url of our backend service (grab the backend url if you forget it via <code>cf app FortunesBackend</code>)</p>
<div class="listingblock">
<div class="content">
<pre>url &gt; http://FortunesBackend1.apps.pcf.space/FortuneServiceWCF.svc</pre>
</div>
</div>
</li>
<li>
<p>Lets publish and push our app as we did at the begining of the demo. <strong>TODO: ADD STEPS</strong></p>
</li>
</ol>
</div>
</div>
</div>

					</section>
				</article>
			</main>
		</div> 
	</div> 
</div>

		




<hr />
<div class="container">
	<div class="row">
		<div class="col-sm-8">
			<p class="doc-footer-em"><a href="#">Back to TOP</a></p>
		</div>
	</div>

</div> 
          
<footer class="doc-footer">
        <span>Last Updated on  2016-03-23 19:58:14 -0400 EDT  </span>
	
	<p>Copyright (c) 2015, Pivotal; All rights reserved.</p>
</footer>



<script src="/js/jquery-1.11.2.min.js"></script>
<script src="/js/bootstrap.min.js"></script>

<script src="/js/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script src="/js/ie10-viewport-bug-workaround.js"></script>
		<script>
			var $event = $.event,
			$special,
			resizeTimeout;
			$special = $event.special.debouncedresize = {
				setup: function() {
					$( this ).on( "resize", $special.handler );
				},
				teardown: function() {
					$( this ).off( "resize", $special.handler );
				},
				handler: function( event, execAsap ) {
					var context = this,
						args = arguments,
						dispatch = function() {
							event.type = "debouncedresize";
							$event.dispatch.apply( context, args );
						};
					if ( resizeTimeout ) {
						clearTimeout( resizeTimeout );
					}
					execAsap ?
						dispatch() :
						resizeTimeout = setTimeout( dispatch, $special.threshold );
				},
				threshold: 250
			};
			var BLANK = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
			$.fn.imagesLoaded = function( callback ) {
				var $this = this,
					deferred = $.isFunction($.Deferred) ? $.Deferred() : 0,
					hasNotify = $.isFunction(deferred.notify),
					$images = $this.find('img').add( $this.filter('img') ),
					loaded = [],
					proper = [],
					broken = [];
				if ($.isPlainObject(callback)) {
					$.each(callback, function (key, value) {
						if (key === 'callback') {
							callback = value;
						} else if (deferred) {
							deferred[key](value);
						}
					});
				}
				function doneLoading() {
					var $proper = $(proper),
						$broken = $(broken);
					if ( deferred ) {
						if ( broken.length ) {
							deferred.reject( $images, $proper, $broken );
						} else {
							deferred.resolve( $images );
						}
					}
					if ( $.isFunction( callback ) ) {
						callback.call( $this, $images, $proper, $broken );
					}
				}
				function imgLoaded( img, isBroken ) {
					if ( img.src === BLANK || $.inArray( img, loaded ) !== -1 ) {
						return;
					}
					loaded.push( img );
					if ( isBroken ) {
						broken.push( img );
					} else {
						proper.push( img );
					}
					$.data( img, 'imagesLoaded', { isBroken: isBroken, src: img.src } );
					if ( hasNotify ) {
						deferred.notifyWith( $(img), [ isBroken, $images, $(proper), $(broken) ] );
					}
					if ( $images.length === loaded.length ){
						setTimeout( doneLoading );
						$images.unbind( '.imagesLoaded' );
					}
				}
				if ( !$images.length ) {
					doneLoading();
				} else {
					$images.bind( 'load.imagesLoaded error.imagesLoaded', function( event ){
						imgLoaded( event.target, event.type === 'error' );
					}).each( function( i, el ) {
						var src = el.src;
						var cached = $.data( el, 'imagesLoaded' );
						if ( cached && cached.src === src ) {
							imgLoaded( el, cached.isBroken );
							return;
						}
						if ( el.complete && el.naturalWidth !== undefined ) {
							imgLoaded( el, el.naturalWidth === 0 || el.naturalHeight === 0 );
							return;
						}
						if ( el.readyState || el.complete ) {
							el.src = BLANK;
							el.src = src;
						}
					});
				}
				return deferred ? deferred.promise( $this ) : $this;
			};
			var Grid = (function() {
				var $grid = $( '#og-grid' ),
					$items = $grid.children( 'li' ),
					current = -1,
					previewPos = -1,
					scrollExtra = 0,
					marginExpanded = 10,
					$window = $( window ), winsize,
					$body = $( 'html, body' ),
					transEndEventNames = {
						'WebkitTransition' : 'webkitTransitionEnd',
						'MozTransition' : 'transitionend',
						'OTransition' : 'oTransitionEnd',
						'msTransition' : 'MSTransitionEnd',
						'transition' : 'transitionend'
					},
					transEndEventName = transEndEventNames[ Modernizr.prefixed( 'transition' ) ],
					support = Modernizr.csstransitions,
					settings = {
						minHeight : 500,
						speed : 350,
						easing : 'ease'
					};
				function init( config ) {
					
					settings = $.extend( true, {}, settings, config );
					$grid.imagesLoaded( function() {
						saveItemInfo( true );
						getWinSize();
						initEvents();
					} );
				}
				function addItems( $newitems ) {
					$items = $items.add( $newitems );
					$newitems.each( function() {
						var $item = $( this );
						$item.data( {
							offsetTop : $item.offset().top,
							height : $item.height()
						} );
					} );
					initItemsEvents( $newitems );
				}
				function saveItemInfo( saveheight ) {
					$items.each( function() {
						var $item = $( this );
						$item.data( 'offsetTop', $item.offset().top );
						if( saveheight ) {
							$item.data( 'height', $item.height() );
						}
					} );
				}
				function initEvents() {
					
					initItemsEvents( $items );
					
					$window.on( 'debouncedresize', function() {
						
						scrollExtra = 0;
						previewPos = -1;
						saveItemInfo();
						getWinSize();
						var preview = $.data( this, 'preview' );
						if( typeof preview != 'undefined' ) {
							hidePreview();
						}
					} );
				}
				function initItemsEvents( $items ) {
					$items.on( 'click', 'span.og-close', function() {
						hidePreview();
						return false;
					} ).children( 'a' ).on( 'click', function(e) {
						var $item = $( this ).parent();
						current === $item.index() ? hidePreview() : showPreview( $item );
						return false;
					} );
				}
				function getWinSize() {
					winsize = { width : $window.width(), height : $window.height() };
				}
				function showPreview( $item ) {
					var preview = $.data( this, 'preview' ),
						position = $item.data( 'offsetTop' );
					scrollExtra = 0;
					if( typeof preview != 'undefined' ) {
						if( previewPos !== position ) {
							if( position > previewPos ) {
								scrollExtra = preview.height;
							}
							hidePreview();
						}
						else {
							preview.update( $item );
							return false;
						}
						
					}
					previewPos = position;
					preview = $.data( this, 'preview', new Preview( $item ) );
					preview.open();
				}
				function hidePreview() {
					current = -1;
					var preview = $.data( this, 'preview' );
					preview.close();
					$.removeData( this, 'preview' );
				}
				function Preview( $item ) {
					this.$item = $item;
					this.expandedIdx = this.$item.index();
					this.create();
					this.update();
				}
				Preview.prototype = {
					create : function() {
						this.$title = $( '<h3></h3>' );
						this.$description = $( '<p></p>' );
						this.$href = $( '<a href="#"></a>' );
						this.$details = $( '<div class="og-details"></div>' ).append( this.$title, this.$description, this.$href );
						this.$loading = $( '<div class="og-loading"></div>' );
						this.$fullimage = $( '<div class="og-fullimg"></div>' ).append( this.$loading );
						this.$closePreview = $( '<span class="og-close"></span>' );
						this.$previewInner = $( '<div class="og-expander-inner"></div>' ).append( this.$closePreview, this.$fullimage, this.$details );
						this.$previewEl = $( '<div class="og-expander"></div>' ).append( this.$previewInner );
						this.$item.append( this.getEl() );
						if( support ) {
							this.setTransition();
						}
					},
					update : function( $item ) {
						if( $item ) {
							this.$item = $item;
						}
						
						if( current !== -1 ) {
							var $currentItem = $items.eq( current );
							$currentItem.removeClass( 'og-expanded' );
							this.$item.addClass( 'og-expanded' );
							this.positionPreview();
						}
						current = this.$item.index();
						var $itemEl = this.$item.children( 'a' ),
							eldata = {
								href : $itemEl.attr( 'href' ),
								largesrc : $itemEl.data( 'largesrc' ),
								title : $itemEl.data( 'title' ),
								description : $itemEl.data( 'description' )
							};
						this.$title.html( eldata.title );
						this.$description.html( eldata.description );
						this.$href.attr( 'href', eldata.href );
						var self = this;
						
						if( typeof self.$largeImg != 'undefined' ) {
							self.$largeImg.remove();
						}
						if( self.$fullimage.is( ':visible' ) ) {
							this.$loading.show();
							$( '<img/>' ).load( function() {
								var $img = $( this );
								if( $img.attr( 'src' ) === self.$item.children('a').data( 'largesrc' ) ) {
									self.$loading.hide();
									self.$fullimage.find( 'img' ).remove();
									self.$largeImg = $img.fadeIn( 350 );
									self.$fullimage.append( self.$largeImg );
								}
							} ).attr( 'src', eldata.largesrc );	
						}
					},
					open : function() {
						setTimeout( $.proxy( function() {	
							this.setHeights();
							this.positionPreview();
						}, this ), 25 );
					},
					close : function() {
						var self = this,
							onEndFn = function() {
								if( support ) {
									$( this ).off( transEndEventName );
								}
								self.$item.removeClass( 'og-expanded' );
								self.$previewEl.remove();
							};
						setTimeout( $.proxy( function() {
							if( typeof this.$largeImg !== 'undefined' ) {
								this.$largeImg.fadeOut( 'fast' );
							}
							this.$previewEl.css( 'height', 0 );
							var $expandedItem = $items.eq( this.expandedIdx );
							$expandedItem.css( 'height', $expandedItem.data( 'height' ) ).on( transEndEventName, onEndFn );
							if( !support ) {
								onEndFn.call();
							}
						}, this ), 25 );
						
						return false;
					},
					calcHeight : function() {
						var heightPreview = winsize.height - this.$item.data( 'height' ) - marginExpanded,
							itemHeight = winsize.height;
						if( heightPreview < settings.minHeight ) {
							heightPreview = settings.minHeight;
							itemHeight = settings.minHeight + this.$item.data( 'height' ) + marginExpanded;
						}
						this.height = heightPreview;
						this.itemHeight = itemHeight;
					},
					setHeights : function() {
						var self = this,
							onEndFn = function() {
								if( support ) {
									self.$item.off( transEndEventName );
								}
								self.$item.addClass( 'og-expanded' );
							};
						this.calcHeight();
						this.$previewEl.css( 'height', this.height );
						this.$item.css( 'height', this.itemHeight ).on( transEndEventName, onEndFn );
						if( !support ) {
							onEndFn.call();
						}
					},
					positionPreview : function() {
						var position = this.$item.data( 'offsetTop' ),
							previewOffsetT = this.$previewEl.offset().top - scrollExtra,
							scrollVal = this.height + this.$item.data( 'height' ) + marginExpanded <= winsize.height ? position : this.height < winsize.height ? previewOffsetT - ( winsize.height - this.height ) : previewOffsetT;
						
						$body.animate( { scrollTop : scrollVal }, settings.speed );
					},
					setTransition  : function() {
						this.$previewEl.css( 'transition', 'height ' + settings.speed + 'ms ' + settings.easing );
						this.$item.css( 'transition', 'height ' + settings.speed + 'ms ' + settings.easing );
					},
					getEl : function() {
						return this.$previewEl;
					}
				}
				return { 
					init : init,
					addItems : addItems
				};
			})();
		</script>
		<script>
			$(function() {
				Grid.init();
			});
		</script>
</body>
</html>

