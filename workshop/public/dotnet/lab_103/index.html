<!DOCTYPE html>



<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="alternate" href="/index.xml" type="application/rss+xml" title="Raytheon Pivotal Workshops">
		<link rel="icon" href="/favicon.ico">
		<title>Lab105 - Raytheon Pivotal Workshops</title>
		<link rel="stylesheet" href="/css/highlight.js.min.css">
		<link rel="stylesheet" href="/css/bootstrap.min.css">
		<link rel="stylesheet" href="/css/bootstrap-theme.css">
		<link rel="stylesheet" href="/css/pui-v2.0.0/pivotal-ui.css">
		<link rel="stylesheet" href="/css/theme.css">
		<link rel="stylesheet" href="/css/component.css">

<link rel="stylesheet"  href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/3.1.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="/css/bootie-docs.css">
		<script src="http://raytheon.cfapps.io/js/modernizr.custom.js"></script>

		
		<style type="text/css">
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
		</style>
	</head>

<body role="document">
	
	
	<nav class="navbar navbar-inverse navbar-fixed-top  ">
		<div class="container-fluid">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<div class="nav navbar-brand">
						
							<img class="nav pivotal-logo" src="/Pivotal_Teal.png"/>
						
				</div>
				<a class="navbar-brand navbar-txt" href="/">Raytheon Pivotal Workshops </a>
			</div>
			<div id="navbar" class="navbar-collapse collapse">
				<ul class="nav navbar-nav">
			
				
				
					
					<li ><a class="navbar-txt" href="/lab_requirements">Lab_requirements</a></li>
				
					
					<li ><a class="navbar-txt" href="/billerica_day1">Billerica_day1</a></li>
				
					
					<li ><a class="navbar-txt" href="/billerica_day2">Billerica_day2</a></li>
				
					
					<li ><a class="navbar-txt" href="/billerica_day3">Billerica_day3</a></li>
				
					
					<li ><a class="navbar-txt" href="/cloud_tig">Cloud_tig</a></li>
				
			
			
				<li class="dropdown">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Resources<span class="caret"></span></a>
					<ul class="dropdown-menu" role="menu">
					
                        <li><a target="_blank" href="https://www.youtube.com/playlist?list=PLAdzTan_eSPQ1fuLSBhyB4eEZF7JQM0Mx">All SpringOne Conference Videos</a></li>
                     
                        <li><a target="_blank" href="http://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry-dev/introduction">Try PCF on your Local Workstation with PCF Dev</a></li>
                     
                        <li><a target="_blank" href="http://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry/introduction">Try PCF on the Public Cloud</a></li>
                     
                        <li><a target="_blank" href="/CorporateOverview.pdf">Pivotal Overview</a></li>
                     
                        <li><a target="_blank" href="https://network.pivotal.io/products/pcfdev">PCF Dev</a></li>
                     
                        <li><a target="_blank" href="https://docs.pivotal.io/pivotalcf">PCF Documentation</a></li>
                     
                        <li><a target="_blank" href="https://docs.pivotal.io/pivotalcf/cf-cli/getting-started.html">CF CLI Documentation</a></li>
                     
                        <li><a target="_blank" href="https://www.git-scm.com">Git</a></li>
                     
                        <li><a target="_blank" href="https://try.github.io/levels/1/challenges/1">Git Lessons</a></li>
                     
                        <li><a target="_blank" href="http://platform.spring.io/platform/">Spring Platform</a></li>
                     
                        <li><a target="_blank" href="https://spring.io/docs">Spring Docs</a></li>
                     
                        <li><a target="_blank" href="http://start.spring.io/">Spring Initializer</a></li>
                     
                        <li><a target="_blank" href="https://spring.io/blog/2015/10/19/springone2gx-2015-replay-spring-cloud-at-netflix">Spring Cloud at Netflix</a></li>
                     
                        <li><a target="_blank" href="https://spring.io/blog/2015/07/14/microservices-with-spring">Microservices with Spring</a></li>
                     
                        <li><a target="_blank" href="https://spring.io/guides#tutorials">Spring Guides</a></li>
                     
                        <li><a target="_blank" href="https://network.pivotal.io/">Pivotal Network</a></li>
                     
                        <li><a target="_blank" href="http://docs.pivotal.io">Pivotal Documentation</a></li>
                     
					</ul>
				</li>
			
			
				<li class="dropdown">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Books<span class="caret"></span></a>
					<ul class="dropdown-menu" role="menu">
					
                        <li><a target="_blank" href="/books/Beyond_the_12-Factor_App_Pivotal.pdf">Beyond the 12-Factor App</a></li>
                     
                        <li><a target="_blank" href="/books/Migrating_to_Cloud-Native_App_Architectures_Pivotal.pdf">Migrating to Cloud Native Application Architectures</a></li>
                     
                        <li><a target="_blank" href="/books/Cloud_Foundry_The_Cloud_Native_Platform_Pivotal.pdf">Cloud Foundry The Cloud Native Platform</a></li>
                     
                        <li><a target="_blank" href="http://www.amazon.com/Cloud-Native-Java-Designing-Resilient/dp/1449374646">Cloud Native Java: Designing Resilient Systems with Spring Boot, Spring Cloud, and Cloud Foundry</a></li>
                     
					</ul>
				</li>
			
				
                        
				</ul>
			</div>
		</div>
	</nav>

<div class="container" style="width:95%; padding:5">
	<div class="row">

	    		
		<div class="doc-sidebar" style="width:30%; margin-top:0; float:right; padding:10px;">
			<div class="sidebar-module">
				
		    	<div class="tag-box bg-dark-11" style="padding:10px; margin:20px;">
		    	<h4 class="type-brand-3">Books</h4>
		    	<ul class="list-unstyled">
		    	
		    	<li><a target="_blank" href="/books/Beyond_the_12-Factor_App_Pivotal.pdf">Beyond the 12-Factor App</a><p></p></li>	
		    	
		    	<li><a target="_blank" href="/books/Migrating_to_Cloud-Native_App_Architectures_Pivotal.pdf">Migrating to Cloud Native Application Architectures</a><p></p></li>	
		    	
		    	<li><a target="_blank" href="/books/Cloud_Foundry_The_Cloud_Native_Platform_Pivotal.pdf">Cloud Foundry The Cloud Native Platform</a><p></p></li>	
		    	
		    	<li><a target="_blank" href="http://www.amazon.com/Cloud-Native-Java-Designing-Resilient/dp/1449374646">Cloud Native Java: Designing Resilient Systems with Spring Boot, Spring Cloud, and Cloud Foundry</a><p></p></li>	
		    	
		    	</ul>
		  	</div>
                        <div class="tag-box bg-dark-11" style="padding:10px; margin:20px;">
                        <h4 class="type-brand-3">Resources</h4>
                        <ul class="list-unstyled">
                        
                            <li><a target="_blank" href="https://www.youtube.com/playlist?list=PLAdzTan_eSPQ1fuLSBhyB4eEZF7JQM0Mx">All SpringOne Conference Videos</a><p></p></li>
                        
                            <li><a target="_blank" href="http://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry-dev/introduction">Try PCF on your Local Workstation with PCF Dev</a><p></p></li>
                        
                            <li><a target="_blank" href="http://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry/introduction">Try PCF on the Public Cloud</a><p></p></li>
                        
                            <li><a target="_blank" href="/CorporateOverview.pdf">Pivotal Overview</a><p></p></li>
                        
                            <li><a target="_blank" href="https://network.pivotal.io/products/pcfdev">PCF Dev</a><p></p></li>
                        
                            <li><a target="_blank" href="https://docs.pivotal.io/pivotalcf">PCF Documentation</a><p></p></li>
                        
                            <li><a target="_blank" href="https://docs.pivotal.io/pivotalcf/cf-cli/getting-started.html">CF CLI Documentation</a><p></p></li>
                        
                            <li><a target="_blank" href="https://www.git-scm.com">Git</a><p></p></li>
                        
                            <li><a target="_blank" href="https://try.github.io/levels/1/challenges/1">Git Lessons</a><p></p></li>
                        
                            <li><a target="_blank" href="http://platform.spring.io/platform/">Spring Platform</a><p></p></li>
                        
                            <li><a target="_blank" href="https://spring.io/docs">Spring Docs</a><p></p></li>
                        
                            <li><a target="_blank" href="http://start.spring.io/">Spring Initializer</a><p></p></li>
                        
                            <li><a target="_blank" href="https://spring.io/blog/2015/10/19/springone2gx-2015-replay-spring-cloud-at-netflix">Spring Cloud at Netflix</a><p></p></li>
                        
                            <li><a target="_blank" href="https://spring.io/blog/2015/07/14/microservices-with-spring">Microservices with Spring</a><p></p></li>
                        
                            <li><a target="_blank" href="https://spring.io/guides#tutorials">Spring Guides</a><p></p></li>
                        
                            <li><a target="_blank" href="https://network.pivotal.io/">Pivotal Network</a><p></p></li>
                        
                            <li><a target="_blank" href="http://docs.pivotal.io">Pivotal Documentation</a><p></p></li>
                        
                        </ul>
                        </div>
			</div>
		</div>
		


		<div class="col-sm-8 doc-main" style="width:70%; float:left; padding:30px;">
			<main role="main">
				<article>
					<a id="title"></a>
					<div class="doc-entry-meta">
					</div>
					<section>
						<div class="sect1">
<h2 id="_lab_5_scaling_and_operating_applications">Lab 5 - Scaling and Operating Applications</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_code_goal_code"><code>Goal</code></h2>
<div class="sectionbody">
<div class="openblock">
<div class="content">
<div class="dlist">
<dl>
<dt class="hdlist1">In this lab</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>we&#8217;ll scaling the application.</p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Approximate time: 10 minutes</p>
</div>
</div>
</div>
<div class="quoteblock abstract">
<blockquote>
<div class="paragraph">
<p>Pivotal Cloudfoundry makes the work of performing actions, such as scaling, doing a zero-downtime deploy, and managing application health very easy.
In the next two labs we&#8217;ll explore Pivotal Cloud Foundry operations.</p>
</div>
</blockquote>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_scale_the_application_up">Scale the Application Up</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Now let&#8217;s increase the number of running application instances to 3.  :</p>
<div class="listingblock">
<div class="content">
<pre>&gt; cf scale env -i 3
Scaling app env in org instructor / space development as admin...
OK</pre>
</div>
</div>
<div class="paragraph">
<p>In reporting <code>OK</code>, the CLI is letting you know that the additional requested instances have been started, but they are not yet necessarily running.</p>
</div>
</li>
<li>
<p>We can determine how many instances are actually running like this:</p>
<div class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre>&gt; cf app env
Showing health and status for app env in org instructor / space development as admin...
OK

requested state: started
instances: 3/3
usage: 512M x 3 instances
urls: env-grumous-imperativeness.cfapps.haas-76.pez.pivotal.io
last uploaded: Mon Oct 17 00:13:08 UTC 2016

     state      since                    cpu    memory           disk         details
#0   running    2016-10-16 08:37:52 PM   0.2%   113.4M of 512M   3.8M of 1G
#1   starting   2016-10-16 08:53:26 PM   0.2%   110.2M of 512M   3.8M of 1G
#2   starting   2016-10-16 08:53:26 PM   0.2%   111.6M of 512M   3.8M of 1G
&gt;</pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This application instance has completed the startup process and is actually able to accept requests.</p>
</li>
<li>
<p>This application instance is still starting and will not have any requests routed to it.</p>
</li>
</ol>
</div>
</div>
</div>
</li>
<li>
<p>Eventually all instances will converge to a running state:</p>
<div class="listingblock">
<div class="content">
<pre>&gt; cf app env
Showing health and status for app env in org instructor / space development as admin...
OK

requested state: started
instances: 3/3
usage: 512M x 3 instances
urls: env-grumous-imperativeness.cfapps.haas-76.pez.pivotal.io
last uploaded: Mon Oct 17 00:13:08 UTC 2016

     state     since                    cpu    memory           disk         details
#0   running   2016-10-16 08:37:52 PM   0.2%   113.4M of 512M   3.8M of 1G
#1   running   2016-10-16 08:52:16 PM   0.0%   110.1M of 512M   3.8M of 1G
#2   running   2016-10-16 08:52:17 PM   0.0%   111.5M of 512M   3.8M of 1G</pre>
</div>
</div>
</li>
<li>
<p>Revisit the application route in the browser and select the CloudFoundry Config menu item.
Refresh several times.
You should observe the instance index changing as you do so:</p>
<div class="imageblock">
<div class="content">
<img src="/images/lab-scale-up.png" alt="lab scale up">
</div>
</div>
<div class="paragraph">
<p><br>
<br>
The aforementioned <a href="https://docs.pivotal.io/pivotalcf/1-7/concepts/architecture/router.html">(Go)Router</a> is applying a random routing algorithm to all of the application instances assigned to this route.
As an instance reaches the <code>running</code> state, its <a href="https://docs.pivotal.io/pivotalcf/1-8/concepts/diego/diego-architecture.html#architecture">Diego</a> Cell registers that instance in the routing table assigned to its route by sending a message to Cloud Foundry&#8217;s message bus.
All (Go)Router instances are subscribed to this channel and register the routes independently.
This makes for very dynamic and rapid reconfiguration!</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_scale_the_application_down">Scale the Application Down</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>We can scale the application instances back down as easily as we scaled them up, using the same command structure:</p>
<div class="listingblock">
<div class="content">
<pre>&gt; cf scale env -i 1
Scaling app env in org instructor / space development as admin...
OK</pre>
</div>
</div>
</li>
<li>
<p>Check the application status again:</p>
<div class="listingblock">
<div class="content">
<pre>&gt; cf app env
Showing health and status for app env in org instructor / space development as admin...
OK

requested state: started
instances: 1/1
usage: 512M x 1 instances
urls: env-grumous-imperativeness.cfapps.haas-76.pez.pivotal.io
last uploaded: Mon Oct 17 00:13:08 UTC 2016


     state     since                    cpu    memory           disk         details
#0   running   2016-10-16 08:37:52 PM   0.0%   113.8M of 512M   3.8M of 1G</pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, we&#8217;re back down to only one instance running, and it is in fact the original index 0 that we started with.</p>
</div>
</li>
<li>
<p>Confirm that by again revisiting the route in the browser and checking the instance index:</p>
<div class="imageblock">
<div class="content">
<img src="/images/lab-scale-down.png" alt="lab scale down">
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_http_routing">HTTP Routing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are two ways to discover what routes, or HTTP URLs, are ampped to an application
The first is available via the CLI. Just type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&gt; cf app env
Showing health and status for app env in org instructor / space development as admin...
OK

requested state: started
instances: 1/1
usage: 512M x 1 instances
urls: env-grumous-imperativeness.cfapps.haas-76.pez.pivotal.io
last uploaded: Mon Oct 17 00:13:08 UTC 2016


     state     since                    cpu    memory           disk         details
#0   running   2016-10-16 08:37:52 PM   0.2%   116.9M of 512M   3.8M of 1G</pre>
</div>
</div>
<div class="paragraph">
<p>and you&#8217;ll see the list of routes in the section that says <em>urls</em>.</p>
</div>
<div class="paragraph">
<p>The second way is via the Apps Manager UI.  Click on the <em>env</em> application to view application details.  Select the <em>Routes</em> tab to view a list of mapped routes:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/lab-routes.png" alt="lab routes">
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>We can easily add an additional route by clicking on <em>+ Map a Route</em> and supplying the new hostname:</p>
<div class="imageblock">
<div class="content">
<img src="/images/lab-add-route.png" alt="lab add route">
</div>
</div>
</li>
<li>
<p>Navigate to the new URL in your browser window.  You should see that same application displayed!</p>
</li>
<li>
<p>We can just as easily remove a route by clicking on <em>Unmap</em> on the route you wish to remove.</p>
<div class="imageblock">
<div class="content">
<img src="/images/lab-unmap-route.png" alt="lab unmap route">
</div>
</div>
<div class="paragraph">
<p>If you navigate to that URL you&#8217;ll receive a HTTP 404 response</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/lab-no-route.png" alt="lab no route">
</div>
</div>
</li>
<li>
<p>This is how blue-green deployments are accomplished. Check the <a href="https://docs.pivotal.io/pivotalcf/1-7/devguide/deploy-apps/blue-green.html">documentation</a> for detailed instructions.</p>
<div class="imageblock">
<div class="content">
<img src="/images/blue-green.png" alt="blue green">
</div>
</div>
</li>
</ol>
</div>
</div>
</div>

					</section>
				</article>
			</main>
		</div> 
	</div> 
</div>

		




<hr />
<div class="container">
	<div class="row">
		<div class="col-sm-8">
			<p class="doc-footer-em"><a href="#">Back to TOP</a></p>
		</div>
	</div>

</div> 
          
<footer class="doc-footer">
        <span>Last Updated on  2016-03-23 19:58:14 -0400 EDT  </span>
	
	<p>Copyright (c) 2015, Pivotal; All rights reserved.</p>
</footer>



<script src="/js/jquery-1.11.2.min.js"></script>
<script src="/js/bootstrap.min.js"></script>

<script src="/js/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script src="/js/ie10-viewport-bug-workaround.js"></script>
		<script>
			var $event = $.event,
			$special,
			resizeTimeout;
			$special = $event.special.debouncedresize = {
				setup: function() {
					$( this ).on( "resize", $special.handler );
				},
				teardown: function() {
					$( this ).off( "resize", $special.handler );
				},
				handler: function( event, execAsap ) {
					var context = this,
						args = arguments,
						dispatch = function() {
							event.type = "debouncedresize";
							$event.dispatch.apply( context, args );
						};
					if ( resizeTimeout ) {
						clearTimeout( resizeTimeout );
					}
					execAsap ?
						dispatch() :
						resizeTimeout = setTimeout( dispatch, $special.threshold );
				},
				threshold: 250
			};
			var BLANK = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
			$.fn.imagesLoaded = function( callback ) {
				var $this = this,
					deferred = $.isFunction($.Deferred) ? $.Deferred() : 0,
					hasNotify = $.isFunction(deferred.notify),
					$images = $this.find('img').add( $this.filter('img') ),
					loaded = [],
					proper = [],
					broken = [];
				if ($.isPlainObject(callback)) {
					$.each(callback, function (key, value) {
						if (key === 'callback') {
							callback = value;
						} else if (deferred) {
							deferred[key](value);
						}
					});
				}
				function doneLoading() {
					var $proper = $(proper),
						$broken = $(broken);
					if ( deferred ) {
						if ( broken.length ) {
							deferred.reject( $images, $proper, $broken );
						} else {
							deferred.resolve( $images );
						}
					}
					if ( $.isFunction( callback ) ) {
						callback.call( $this, $images, $proper, $broken );
					}
				}
				function imgLoaded( img, isBroken ) {
					if ( img.src === BLANK || $.inArray( img, loaded ) !== -1 ) {
						return;
					}
					loaded.push( img );
					if ( isBroken ) {
						broken.push( img );
					} else {
						proper.push( img );
					}
					$.data( img, 'imagesLoaded', { isBroken: isBroken, src: img.src } );
					if ( hasNotify ) {
						deferred.notifyWith( $(img), [ isBroken, $images, $(proper), $(broken) ] );
					}
					if ( $images.length === loaded.length ){
						setTimeout( doneLoading );
						$images.unbind( '.imagesLoaded' );
					}
				}
				if ( !$images.length ) {
					doneLoading();
				} else {
					$images.bind( 'load.imagesLoaded error.imagesLoaded', function( event ){
						imgLoaded( event.target, event.type === 'error' );
					}).each( function( i, el ) {
						var src = el.src;
						var cached = $.data( el, 'imagesLoaded' );
						if ( cached && cached.src === src ) {
							imgLoaded( el, cached.isBroken );
							return;
						}
						if ( el.complete && el.naturalWidth !== undefined ) {
							imgLoaded( el, el.naturalWidth === 0 || el.naturalHeight === 0 );
							return;
						}
						if ( el.readyState || el.complete ) {
							el.src = BLANK;
							el.src = src;
						}
					});
				}
				return deferred ? deferred.promise( $this ) : $this;
			};
			var Grid = (function() {
				var $grid = $( '#og-grid' ),
					$items = $grid.children( 'li' ),
					current = -1,
					previewPos = -1,
					scrollExtra = 0,
					marginExpanded = 10,
					$window = $( window ), winsize,
					$body = $( 'html, body' ),
					transEndEventNames = {
						'WebkitTransition' : 'webkitTransitionEnd',
						'MozTransition' : 'transitionend',
						'OTransition' : 'oTransitionEnd',
						'msTransition' : 'MSTransitionEnd',
						'transition' : 'transitionend'
					},
					transEndEventName = transEndEventNames[ Modernizr.prefixed( 'transition' ) ],
					support = Modernizr.csstransitions,
					settings = {
						minHeight : 500,
						speed : 350,
						easing : 'ease'
					};
				function init( config ) {
					
					settings = $.extend( true, {}, settings, config );
					$grid.imagesLoaded( function() {
						saveItemInfo( true );
						getWinSize();
						initEvents();
					} );
				}
				function addItems( $newitems ) {
					$items = $items.add( $newitems );
					$newitems.each( function() {
						var $item = $( this );
						$item.data( {
							offsetTop : $item.offset().top,
							height : $item.height()
						} );
					} );
					initItemsEvents( $newitems );
				}
				function saveItemInfo( saveheight ) {
					$items.each( function() {
						var $item = $( this );
						$item.data( 'offsetTop', $item.offset().top );
						if( saveheight ) {
							$item.data( 'height', $item.height() );
						}
					} );
				}
				function initEvents() {
					
					initItemsEvents( $items );
					
					$window.on( 'debouncedresize', function() {
						
						scrollExtra = 0;
						previewPos = -1;
						saveItemInfo();
						getWinSize();
						var preview = $.data( this, 'preview' );
						if( typeof preview != 'undefined' ) {
							hidePreview();
						}
					} );
				}
				function initItemsEvents( $items ) {
					$items.on( 'click', 'span.og-close', function() {
						hidePreview();
						return false;
					} ).children( 'a' ).on( 'click', function(e) {
						var $item = $( this ).parent();
						current === $item.index() ? hidePreview() : showPreview( $item );
						return false;
					} );
				}
				function getWinSize() {
					winsize = { width : $window.width(), height : $window.height() };
				}
				function showPreview( $item ) {
					var preview = $.data( this, 'preview' ),
						position = $item.data( 'offsetTop' );
					scrollExtra = 0;
					if( typeof preview != 'undefined' ) {
						if( previewPos !== position ) {
							if( position > previewPos ) {
								scrollExtra = preview.height;
							}
							hidePreview();
						}
						else {
							preview.update( $item );
							return false;
						}
						
					}
					previewPos = position;
					preview = $.data( this, 'preview', new Preview( $item ) );
					preview.open();
				}
				function hidePreview() {
					current = -1;
					var preview = $.data( this, 'preview' );
					preview.close();
					$.removeData( this, 'preview' );
				}
				function Preview( $item ) {
					this.$item = $item;
					this.expandedIdx = this.$item.index();
					this.create();
					this.update();
				}
				Preview.prototype = {
					create : function() {
						this.$title = $( '<h3></h3>' );
						this.$description = $( '<p></p>' );
						this.$href = $( '<a href="#"></a>' );
						this.$details = $( '<div class="og-details"></div>' ).append( this.$title, this.$description, this.$href );
						this.$loading = $( '<div class="og-loading"></div>' );
						this.$fullimage = $( '<div class="og-fullimg"></div>' ).append( this.$loading );
						this.$closePreview = $( '<span class="og-close"></span>' );
						this.$previewInner = $( '<div class="og-expander-inner"></div>' ).append( this.$closePreview, this.$fullimage, this.$details );
						this.$previewEl = $( '<div class="og-expander"></div>' ).append( this.$previewInner );
						this.$item.append( this.getEl() );
						if( support ) {
							this.setTransition();
						}
					},
					update : function( $item ) {
						if( $item ) {
							this.$item = $item;
						}
						
						if( current !== -1 ) {
							var $currentItem = $items.eq( current );
							$currentItem.removeClass( 'og-expanded' );
							this.$item.addClass( 'og-expanded' );
							this.positionPreview();
						}
						current = this.$item.index();
						var $itemEl = this.$item.children( 'a' ),
							eldata = {
								href : $itemEl.attr( 'href' ),
								largesrc : $itemEl.data( 'largesrc' ),
								title : $itemEl.data( 'title' ),
								description : $itemEl.data( 'description' )
							};
						this.$title.html( eldata.title );
						this.$description.html( eldata.description );
						this.$href.attr( 'href', eldata.href );
						var self = this;
						
						if( typeof self.$largeImg != 'undefined' ) {
							self.$largeImg.remove();
						}
						if( self.$fullimage.is( ':visible' ) ) {
							this.$loading.show();
							$( '<img/>' ).load( function() {
								var $img = $( this );
								if( $img.attr( 'src' ) === self.$item.children('a').data( 'largesrc' ) ) {
									self.$loading.hide();
									self.$fullimage.find( 'img' ).remove();
									self.$largeImg = $img.fadeIn( 350 );
									self.$fullimage.append( self.$largeImg );
								}
							} ).attr( 'src', eldata.largesrc );	
						}
					},
					open : function() {
						setTimeout( $.proxy( function() {	
							this.setHeights();
							this.positionPreview();
						}, this ), 25 );
					},
					close : function() {
						var self = this,
							onEndFn = function() {
								if( support ) {
									$( this ).off( transEndEventName );
								}
								self.$item.removeClass( 'og-expanded' );
								self.$previewEl.remove();
							};
						setTimeout( $.proxy( function() {
							if( typeof this.$largeImg !== 'undefined' ) {
								this.$largeImg.fadeOut( 'fast' );
							}
							this.$previewEl.css( 'height', 0 );
							var $expandedItem = $items.eq( this.expandedIdx );
							$expandedItem.css( 'height', $expandedItem.data( 'height' ) ).on( transEndEventName, onEndFn );
							if( !support ) {
								onEndFn.call();
							}
						}, this ), 25 );
						
						return false;
					},
					calcHeight : function() {
						var heightPreview = winsize.height - this.$item.data( 'height' ) - marginExpanded,
							itemHeight = winsize.height;
						if( heightPreview < settings.minHeight ) {
							heightPreview = settings.minHeight;
							itemHeight = settings.minHeight + this.$item.data( 'height' ) + marginExpanded;
						}
						this.height = heightPreview;
						this.itemHeight = itemHeight;
					},
					setHeights : function() {
						var self = this,
							onEndFn = function() {
								if( support ) {
									self.$item.off( transEndEventName );
								}
								self.$item.addClass( 'og-expanded' );
							};
						this.calcHeight();
						this.$previewEl.css( 'height', this.height );
						this.$item.css( 'height', this.itemHeight ).on( transEndEventName, onEndFn );
						if( !support ) {
							onEndFn.call();
						}
					},
					positionPreview : function() {
						var position = this.$item.data( 'offsetTop' ),
							previewOffsetT = this.$previewEl.offset().top - scrollExtra,
							scrollVal = this.height + this.$item.data( 'height' ) + marginExpanded <= winsize.height ? position : this.height < winsize.height ? previewOffsetT - ( winsize.height - this.height ) : previewOffsetT;
						
						$body.animate( { scrollTop : scrollVal }, settings.speed );
					},
					setTransition  : function() {
						this.$previewEl.css( 'transition', 'height ' + settings.speed + 'ms ' + settings.easing );
						this.$item.css( 'transition', 'height ' + settings.speed + 'ms ' + settings.easing );
					},
					getEl : function() {
						return this.$previewEl;
					}
				}
				return { 
					init : init,
					addItems : addItems
				};
			})();
		</script>
		<script>
			$(function() {
				Grid.init();
			});
		</script>
</body>
</html>

