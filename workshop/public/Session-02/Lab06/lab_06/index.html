<!DOCTYPE html>



<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="alternate" href="/index.xml" type="application/rss+xml" title="Raytheon Pivotal Workshops">
		<link rel="icon" href="/favicon.ico">
		<title> - Raytheon Pivotal Workshops</title>
		<link rel="stylesheet" href="/css/highlight.js.min.css">
		<link rel="stylesheet" href="/css/bootstrap.min.css">
		<link rel="stylesheet" href="/css/bootstrap-theme.css">
		<link rel="stylesheet" href="/css/pui-v2.0.0/pivotal-ui.css">
		<link rel="stylesheet" href="/css/theme.css">
		<link rel="stylesheet" href="/css/component.css">

<link rel="stylesheet"  href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/3.1.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="/css/bootie-docs.css">
		<script src="http://raytheon.cfapps.io/js/modernizr.custom.js"></script>

		
		<style type="text/css">
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
		</style>
	</head>

<body role="document">
	
	
	<nav class="navbar navbar-inverse navbar-fixed-top  ">
		<div class="container-fluid">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<div class="nav navbar-brand">
						
							<img class="nav pivotal-logo" src="/Pivotal_Teal.png"/>
						
				</div>
				<a class="navbar-brand navbar-txt" href="/">Raytheon Pivotal Workshops </a>
			</div>
			<div id="navbar" class="navbar-collapse collapse">
				<ul class="nav navbar-nav">
			
				
				
					
					<li ><a class="navbar-txt" href="/lab_requirements">Lab_requirements</a></li>
				
					
					<li ><a class="navbar-txt" href="/billerica_day1">Billerica_day1</a></li>
				
					
					<li ><a class="navbar-txt" href="/billerica_day2">Billerica_day2</a></li>
				
					
					<li ><a class="navbar-txt" href="/billerica_day3">Billerica_day3</a></li>
				
					
					<li ><a class="navbar-txt" href="/cloud_tig">Cloud_tig</a></li>
				
			
			
				<li class="dropdown">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Resources<span class="caret"></span></a>
					<ul class="dropdown-menu" role="menu">
					
                        <li><a target="_blank" href="https://www.youtube.com/playlist?list=PLAdzTan_eSPQ1fuLSBhyB4eEZF7JQM0Mx">All SpringOne Conference Videos</a></li>
                     
                        <li><a target="_blank" href="http://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry-dev/introduction">Try PCF on your Local Workstation with PCF Dev</a></li>
                     
                        <li><a target="_blank" href="http://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry/introduction">Try PCF on the Public Cloud</a></li>
                     
                        <li><a target="_blank" href="/CorporateOverview.pdf">Pivotal Overview</a></li>
                     
                        <li><a target="_blank" href="https://network.pivotal.io/products/pcfdev">PCF Dev</a></li>
                     
                        <li><a target="_blank" href="https://docs.pivotal.io/pivotalcf">PCF Documentation</a></li>
                     
                        <li><a target="_blank" href="https://docs.pivotal.io/pivotalcf/cf-cli/getting-started.html">CF CLI Documentation</a></li>
                     
                        <li><a target="_blank" href="https://www.git-scm.com">Git</a></li>
                     
                        <li><a target="_blank" href="https://try.github.io/levels/1/challenges/1">Git Lessons</a></li>
                     
                        <li><a target="_blank" href="http://platform.spring.io/platform/">Spring Platform</a></li>
                     
                        <li><a target="_blank" href="https://spring.io/docs">Spring Docs</a></li>
                     
                        <li><a target="_blank" href="http://start.spring.io/">Spring Initializer</a></li>
                     
                        <li><a target="_blank" href="https://spring.io/blog/2015/10/19/springone2gx-2015-replay-spring-cloud-at-netflix">Spring Cloud at Netflix</a></li>
                     
                        <li><a target="_blank" href="https://spring.io/blog/2015/07/14/microservices-with-spring">Microservices with Spring</a></li>
                     
                        <li><a target="_blank" href="https://spring.io/guides#tutorials">Spring Guides</a></li>
                     
                        <li><a target="_blank" href="https://network.pivotal.io/">Pivotal Network</a></li>
                     
                        <li><a target="_blank" href="http://docs.pivotal.io">Pivotal Documentation</a></li>
                     
					</ul>
				</li>
			
			
				<li class="dropdown">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Books<span class="caret"></span></a>
					<ul class="dropdown-menu" role="menu">
					
                        <li><a target="_blank" href="/books/Beyond_the_12-Factor_App_Pivotal.pdf">Beyond the 12-Factor App</a></li>
                     
                        <li><a target="_blank" href="/books/Migrating_to_Cloud-Native_App_Architectures_Pivotal.pdf">Migrating to Cloud Native Application Architectures</a></li>
                     
                        <li><a target="_blank" href="/books/Cloud_Foundry_The_Cloud_Native_Platform_Pivotal.pdf">Cloud Foundry The Cloud Native Platform</a></li>
                     
                        <li><a target="_blank" href="http://www.amazon.com/Cloud-Native-Java-Designing-Resilient/dp/1449374646">Cloud Native Java: Designing Resilient Systems with Spring Boot, Spring Cloud, and Cloud Foundry</a></li>
                     
					</ul>
				</li>
			
				
                        
				</ul>
			</div>
		</div>
	</nav>

<div class="container" style="width:95%; padding:5">
	<div class="row">

	    		
		<div class="doc-sidebar" style="width:30%; margin-top:0; float:right; padding:10px;">
			<div class="sidebar-module">
				
		    	<div class="tag-box bg-dark-11" style="padding:10px; margin:20px;">
		    	<h4 class="type-brand-3">Books</h4>
		    	<ul class="list-unstyled">
		    	
		    	<li><a target="_blank" href="/books/Beyond_the_12-Factor_App_Pivotal.pdf">Beyond the 12-Factor App</a><p></p></li>	
		    	
		    	<li><a target="_blank" href="/books/Migrating_to_Cloud-Native_App_Architectures_Pivotal.pdf">Migrating to Cloud Native Application Architectures</a><p></p></li>	
		    	
		    	<li><a target="_blank" href="/books/Cloud_Foundry_The_Cloud_Native_Platform_Pivotal.pdf">Cloud Foundry The Cloud Native Platform</a><p></p></li>	
		    	
		    	<li><a target="_blank" href="http://www.amazon.com/Cloud-Native-Java-Designing-Resilient/dp/1449374646">Cloud Native Java: Designing Resilient Systems with Spring Boot, Spring Cloud, and Cloud Foundry</a><p></p></li>	
		    	
		    	</ul>
		  	</div>
                        <div class="tag-box bg-dark-11" style="padding:10px; margin:20px;">
                        <h4 class="type-brand-3">Resources</h4>
                        <ul class="list-unstyled">
                        
                            <li><a target="_blank" href="https://www.youtube.com/playlist?list=PLAdzTan_eSPQ1fuLSBhyB4eEZF7JQM0Mx">All SpringOne Conference Videos</a><p></p></li>
                        
                            <li><a target="_blank" href="http://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry-dev/introduction">Try PCF on your Local Workstation with PCF Dev</a><p></p></li>
                        
                            <li><a target="_blank" href="http://pivotal.io/platform/pcf-tutorials/getting-started-with-pivotal-cloud-foundry/introduction">Try PCF on the Public Cloud</a><p></p></li>
                        
                            <li><a target="_blank" href="/CorporateOverview.pdf">Pivotal Overview</a><p></p></li>
                        
                            <li><a target="_blank" href="https://network.pivotal.io/products/pcfdev">PCF Dev</a><p></p></li>
                        
                            <li><a target="_blank" href="https://docs.pivotal.io/pivotalcf">PCF Documentation</a><p></p></li>
                        
                            <li><a target="_blank" href="https://docs.pivotal.io/pivotalcf/cf-cli/getting-started.html">CF CLI Documentation</a><p></p></li>
                        
                            <li><a target="_blank" href="https://www.git-scm.com">Git</a><p></p></li>
                        
                            <li><a target="_blank" href="https://try.github.io/levels/1/challenges/1">Git Lessons</a><p></p></li>
                        
                            <li><a target="_blank" href="http://platform.spring.io/platform/">Spring Platform</a><p></p></li>
                        
                            <li><a target="_blank" href="https://spring.io/docs">Spring Docs</a><p></p></li>
                        
                            <li><a target="_blank" href="http://start.spring.io/">Spring Initializer</a><p></p></li>
                        
                            <li><a target="_blank" href="https://spring.io/blog/2015/10/19/springone2gx-2015-replay-spring-cloud-at-netflix">Spring Cloud at Netflix</a><p></p></li>
                        
                            <li><a target="_blank" href="https://spring.io/blog/2015/07/14/microservices-with-spring">Microservices with Spring</a><p></p></li>
                        
                            <li><a target="_blank" href="https://spring.io/guides#tutorials">Spring Guides</a><p></p></li>
                        
                            <li><a target="_blank" href="https://network.pivotal.io/">Pivotal Network</a><p></p></li>
                        
                            <li><a target="_blank" href="http://docs.pivotal.io">Pivotal Documentation</a><p></p></li>
                        
                        </ul>
                        </div>
			</div>
		</div>
		


		
<div class="col-sm-14 doc-sidebar">
	<div class="sidebar-module">
		<div class="sidebar-toc">
			<h4>Table of Contents</h4>
			
		</div>
	</div>
</div>


		<div class="col-sm-8 doc-main" style="width:70%; float:left; padding:30px;">
			<main role="main">
				<article>
					<a id="title"></a>
					<div class="doc-entry-meta">
					</div>
					<section>
						<div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
<div class="paragraph">
<p>Starting with this lab we will begin the process of creating a fully functional Fortune Teller application which uses several of the Steeltoe components.
You have two paths you can follow when doing the rest of the labs for the workshop:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>For each lab, open up and work with finished code. With this path you won&#8217;t be writing any new code, instead, you will just be reviewing and running already completed lab code.</p>
</li>
<li>
<p>Open the <em>FortuneTeller.sln</em> solution as your starting point. You will then stick with this solution throughout the workshop, and you will be writing new code and debugging what you write.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If you start with #2 above, you will find the app in its current state is not very useful:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The <code>Fortune Teller Service</code> only serves up a single Fortune.</p>
</li>
<li>
<p>The <code>Fortune Teller UI</code> doesn&#8217;t know how to communicate with the <code>Fortune Teller Service</code> so it always returns the same <code>Hello world</code> Fortune.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The goals for Lab 6 are to understand ASP.NET Core programming and to use our skills to hook up two areas of the code:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In <code>Fortune Teller Service</code>:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Hook up the <code>IFortuneRepository</code> to the <code>FortuneController</code></p>
</li>
<li>
<p>Add the <code>IFortuneRepository</code> and the <code>FortuneContext</code> to the ASP.NET Core service container.</p>
</li>
<li>
<p>Initialize the <code>FortuneContext</code> with some Fortunes.</p>
</li>
</ol>
</div>
</li>
<li>
<p>In <code>Fortune Teller UI</code>:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Hook up the <code>IFortuneService</code> to the <code>FortuneController</code></p>
</li>
<li>
<p>Add the <code>IFortuneService</code> to the ASP.NET Core service container.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>For some background information on ASP.NET Core programming, have a look at this <a href="https://docs.microsoft.com/en-us/aspnet/core/">documentation</a>.</p>
</div>
</blockquote>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_open_visual_studio_solution">Open Visual Studio Solution</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start Visual Studio and open the solution/folder you wish to start from:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><em>Workshop/Session-02/Lab06.sln</em> if you want to start with finished code.</p>
</li>
<li>
<p><em>Workshop/FortuneTeller/FortuneTeller.sln</em> if you want to be writing code from scratch.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_understand_fortune_teller_service_project">Understand Fortune-Teller-Service project</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Expand the <code>Fortune-Teller-Service</code> project</p>
</li>
<li>
<p>Open and examine <code>Program.cs</code>, as everything starts in here.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Examine the usage of <code>WebHostBuilder</code>, <code>UseKestrel</code>, <code>UseUrls</code>, <code>UseStartup&lt;Startup&gt;</code>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Open and examine <code>Startup.cs</code> as this is where the app is configured.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Examine the <code>Startup</code> constructor, where the apps configuration is read and created.</p>
</li>
<li>
<p>Examine the <code>ConfigureService()</code> method, where the services are added to the  ASP.NET Core service container.</p>
</li>
<li>
<p>Examine the <code>Configure()</code> method, where  ASP.NET Core middleware is added to the request processing pipeline.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Open the <code>Models</code> folder which holds the code for the <code>IFortuneRepository</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Examine <code>IFortuneRepository</code></p>
</li>
<li>
<p>Examine <code>FortuneRepository</code>, the implementation class and notice it uses a <code>FortuneContext</code></p>
</li>
<li>
<p>Examine <code>FortuneContext</code>, notice it is a <code>DbContext</code> based on <code>EntityFrameworkCore</code></p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Notice it has a <code>DbSet</code> of <code>FortuneEntity</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Examine <code>SampleData</code> and notice <code>InitializeFortunesAsync</code> method which adds sample data to the <code>FortuneContext</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Open the <code>Controllers</code> folder which holds the MVC Controller code</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Open the <code>FortunesController</code>, the implementation class for the REST API exposed by this microservice</p>
</li>
<li>
<p>Notice it implments the <code>IFortuneService</code> which provides the two REST endpoints</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>AllFortunesAsync() &#8594;  GET: api/fortunes/all</p>
</li>
<li>
<p>RandomFortuneAsync() &#8594; GET api/fortunes/random</p>
</li>
</ol>
</div>
</li>
<li>
<p>Notice the controller methods return <code>Fortunes</code>, not <code>FortuneEntitys</code>.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_understand_fortune_teller_ui_project">Understand Fortune-Teller-UI project</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Expand the <code>Fortune-Teller-UI</code> project</p>
</li>
<li>
<p>Open and examine <code>Program.cs</code>, as everything starts in here.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Examine the usage of <code>WebHostBuilder</code>, <code>UseKestrel</code>, <code>UseUrls</code>, <code>UseStartup&lt;Startup&gt;</code>.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Open and examine <code>Startup.cs</code> as this is where the app is configured.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Examine the <code>Startup</code> constructor, where the apps configuration is read and created.</p>
</li>
<li>
<p>Examine the <code>ConfigureService()</code> method, where the services are added to the ASP.NET Core service container.</p>
</li>
<li>
<p>Examine the <code>Configure()</code> method, where  ASP.NET Core middleware is added to the request processing pipeline.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Open the <code>Common/Services</code> folder which holds the code for the <code>IFortuneService</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Examine <code>IFortuneService</code></p>
</li>
<li>
<p>Examine <code>FortuneServiceClient</code>, the implementation and notice it returns <code>Fortunes</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Open the <code>Controllers</code> folder which holds the MVC Controller code</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Open the <code>FortunesController</code>, the implementation for the UI</p>
</li>
<li>
<p>Notice the <code>RandomFortune</code> action, it returns a <code>Fortune</code> to the View</p>
</li>
<li>
<p>Notice that <code>RandomFortune</code> puts tht last Fortune it received in Session.</p>
</li>
<li>
<p>Notice that <code>Index</code> pulls the last retrieved Fortune from Session and returns it to the View.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Open the <code>Views/Fortunes</code> folder which holds the Views for the FortuneController</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Open <code>RandomFortune</code>, the View used by the <code>RandomFortune</code> action</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Notice how it uses the <code>Fortune</code> returned from the action</p>
</li>
</ol>
</div>
</li>
<li>
<p>Open <code>Index</code>, the View used by the <code>Index</code> action</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Notice how it uses the <code>Fortune</code> returned from the action</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_modify_fortune_teller_service">Modify Fortune Teller Service</h3>
<div class="paragraph">
<p>We will be using ASP.NET Core <code>Dependency Injection</code> for much of the next set of exercises. For some background information on it, have a look at this <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/dependency-injection">documentation</a></p>
</div>
<div class="paragraph">
<p>Also, later on we make use of <code>Entity Framework Core</code>. For some background information on it, have a look at this <a href="https://docs.microsoft.com/en-us/ef/core/">documentation</a>.</p>
</div>
<div class="sect3">
<h4 id="_step_01_modify_fortunecontroller_to_use_the_ifortunerepository">Step 01 - Modify FortuneController to use the IFortuneRepository</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To get the <code>IFortuneRepository</code> into the controller we need to modify the constructor of the <code>FortuneController</code>:</p>
<div class="listingblock">
<div class="content">
<pre>private IFortuneRepository _fortunes;
public FortunesController(ILogger&lt;FortunesController&gt; logger, IFortuneRepository fortunes)
{
   _logger = logger;
   _fortunes = fortunes;
}</pre>
</div>
</div>
</li>
<li>
<p>Then to get <code>FortuneController</code> to use the <code>IFortuneRepository</code> we have to modify both contoller actions.
Something like below should work, but feel free to write your own code:</p>
<div class="listingblock">
<div class="content">
<pre>// GET: api/fortunes/all
[HttpGet("all")]
public async Task&lt;List&lt;Fortune&gt;&gt; AllFortunesAsync()
{
     _logger?.LogDebug("AllFortunesAsync");

    var entities = await _fortunes.GetAllAsync();
    var result = new List&lt;Fortune&gt;();
    foreach(var entity in entities)
    {
        result.Add(new Fortune() { Id = entity.Id, Text = entity.Text });
    }
    return result;
}
// GET api/fortunes/random
[HttpGet("random")]
public async Task&lt;Fortune&gt; RandomFortuneAsync()
{
    _logger?.LogDebug("RandomFortuneAsync");

    var entity = await _fortunes.RandomFortuneAsync();
    return new Fortune() { Id = entity.Id, Text = entity.Text };
}</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_step_02_add_ifortunerepository_and_fortunecontext_to_service_container">Step 02 - Add IFortuneRepository and FortuneContext to Service Container</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To get the <code>IFortuneRepository</code> into the service container we need to modify the <code>Startup</code> class method <code>ConfigureServices</code> and add <code>IFortuneRepository</code> to the service container collection.
We will add it as a Singleton and when its created, it will come from its implementation class <code>FortuneRepository</code>.</p>
<div class="listingblock">
<div class="content">
<pre>public void ConfigureServices(IServiceCollection services)
{
    .....

    services.AddSingleton&lt;IFortuneRepository, FortuneRepository&gt;();

    // Add framework services.
    services.AddMvc();
}</pre>
</div>
</div>
<div class="paragraph">
<p><br>
Notice that the <code>FortuneRepository</code> takes a <code>FortuneContext</code> as a argument to its constructor.
So we also need to add a <code>FortuneContext</code> to the container.
But <code>FortuneContext</code> is built on the EntityFrameworkCore library, so we also need to add that to the container as well.
We do that with the <code>AddEntityFramework()</code> method below.
Once both are added to the container (i.e. <code>AddEntityFramework()</code> &amp; <code>AddDbContext&lt;FortuneContext&gt;()</code>), then we also need to configure the <code>FortuneContext</code> to use some backend database for its storage.
At this point in the workshop, we will just configure it to use an in-memory database.
Clearly, if this context was being updated, this in-memory database would be a bad choice as it would prohibit us from scaling this micro-service horizontally.
So in an upcoming Lab on scaling, we will show you how to use Steeltoe connectors to connect the <code>DbContext</code> to a real backend database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>public void ConfigureServices(IServiceCollection services)
{
    .....
    services.AddEntityFramework()
            .AddDbContext&lt;FortuneContext&gt;(options =&gt; options.UseInMemoryDatabase());

    services.AddSingleton&lt;IFortuneRepository, FortuneRepository&gt;();

    // Add framework services.
    services.AddMvc();
}</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_step_03_initialize_fortunecontext_with_some_fortunes">Step 03 - Initialize FortuneContext with some Fortunes</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To add some Fortunes to the <code>FortuneContext</code> we have already written the code to do that for you. You can make use of the static method <code>SampleData.InitializeFortunesAsync()</code> to do this.
The question is, where do you add this? Have a look at the method and notice that the code asks the container for an instance of the <code>FortuneContext</code> in order to initialize it with samples.
As a result, the container needs to be built before we call this method and also before we start handling any requests.
So the best place to add this call is in the <code>Configure</code> method in the <code>Startup</code> class.</p>
<div class="listingblock">
<div class="content">
<pre>public void Configure(IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory)
{
    loggerFactory.AddConsole(Configuration.GetSection("Logging"));

    app.UseMvc();

    SampleData.InitializeFortunesAsync(app.ApplicationServices).Wait();
}</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_step_04_run_locally">Step 04 - Run Locally</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Using the skills you picked up from Lab05, run the app from VS2017 and/or from the command line.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>CTRL-F5 or F5 in Visual Studio 2017</p>
</li>
<li>
<p><code>dotnet run --server.urls <a href="http://*:5000" class="bare">http://*:5000</a></code></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_step_05_push_to_cloud_foundry">Step 05 - Push to Cloud Foundry</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Using the skills you picked up from Lab05, publish and push the app to a Linux cell on Cloud Foundry.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If you are using the finished lab code on Windows:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>cd Workshop/Session-02/Lab06/Fortune-Teller-Service</code></p>
</li>
<li>
<p><code>dotnet restore</code></p>
</li>
<li>
<p><code>dotnet build </code></p>
</li>
<li>
<p><code>dotnet publish -o %CD%\publish -f netcoreapp1.1 -r ubuntu.14.04-x64</code></p>
</li>
<li>
<p><code>cf push -f manifest.yml -p .\publish</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If you are using the finished lab code on Mac/Linux:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>cd Workshop/Session-02/Lab06/Fortune-Teller-Service</code></p>
</li>
<li>
<p><code>dotnet restore</code></p>
</li>
<li>
<p><code>dotnet build </code></p>
</li>
<li>
<p><code>dotnet publish -f netcoreapp1.1 -r ubuntu.14.04-x64 -o $PWD/publish</code></p>
</li>
<li>
<p><code>cf push -f manifest.yml -p publish</code></p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_modify_fortune_teller_ui">Modify Fortune Teller UI</h3>
<div class="sect3">
<h4 id="_step_01_modify_fortunecontroller_to_use_the_ifortuneservice">Step 01 - Modify FortuneController to use the IFortuneService</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To get the <code>IFortuneService</code> into the controller we need to modify a constructor in the <code>FortuneController</code>:</p>
<div class="listingblock">
<div class="content">
<pre>private IFortuneService _fortunes;
public FortunesController(ILogger&lt;FortunesController&gt;  logger, IFortuneService fortunes)
{
    _logger = logger;
    _fortunes = fortunes;
}</pre>
</div>
</div>
</li>
<li>
<p>Then to get <code>FortuneController</code> to use the <code>IFortuneService</code> we have to modify the contoller action:</p>
<div class="listingblock">
<div class="content">
<pre>public async Task&lt;IActionResult&gt; RandomFortune()
{
    _logger?.LogDebug("RandomFortune");

    var fortune = await _fortunes.RandomFortuneAsync();
    return View(fortune);
}</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_step_02_add_ifortuneservice_to_service_container">Step 02 - Add IFortuneService to Service Container</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To get the <code>IFortuneService</code> into the service container we need to modify the <code>Startup</code> class method <code>ConfigureServices</code> and add <code>IFortuneService</code> to the service container collection.
We will add it as a Singleton and when its created it will be created using its implementation class <code>FortuneServiceClient</code>.</p>
<div class="listingblock">
<div class="content">
<pre>public void ConfigureServices(IServiceCollection services)
{
    .....
    services.AddSingleton&lt;IFortuneService, FortuneServiceClient&gt;();
    ....
}</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_step_03_run_locally">Step 03 - Run Locally</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Using the skills you learned from Lab05, run the app from VS2017 and/or from the command line.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>CTRL-F5 or F5 in Visual Studio 2017</p>
</li>
<li>
<p><code>dotnet run --server.urls <a href="http://*:5555" class="bare">http://*:5555</a></code></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_step_04_push_to_cloud_foundry">Step 04 Push to Cloud Foundry</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Using the skills you learned from Lab05, publish and push the app to a Linux cell on Cloud Foundry.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If you are using the finished lab code on Windows:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>cd Workshop/Session-02/Lab06/Fortune-Teller-UI</code></p>
</li>
<li>
<p><code>dotnet restore</code></p>
</li>
<li>
<p><code>dotnet build </code></p>
</li>
<li>
<p><code>dotnet publish -o %CD%\publish -f netcoreapp1.1 -r ubuntu.14.04-x64</code></p>
</li>
<li>
<p><code>cf push -f manifest.yml -p .\publish</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If you are using the finished lab code on Mac/Linux:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>cd Workshop/Session-02/Lab06/Fortune-Teller-UI</code></p>
</li>
<li>
<p><code>dotnet restore</code></p>
</li>
<li>
<p><code>dotnet build </code></p>
</li>
<li>
<p><code>dotnet publish -f netcoreapp1.1 -r ubuntu.14.04-x64 -o $PWD/publish</code></p>
</li>
<li>
<p><code>cf push -f manifest.yml -p publish</code></p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>

					</section>
				</article>
			</main>
		</div> 
	</div> 
</div>

		




<hr />
<div class="container">
	<div class="row">
		<div class="col-sm-8">
			<p class="doc-footer-em"><a href="#">Back to TOP</a></p>
		</div>
	</div>

</div> 
          
<footer class="doc-footer">
        <span>Last Updated on  0001-01-01 00:00:00 &#43;0000 UTC  </span>
	
	<p>Copyright (c) 2015, Pivotal; All rights reserved.</p>
</footer>



<script src="/js/jquery-1.11.2.min.js"></script>
<script src="/js/bootstrap.min.js"></script>

<script src="/js/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script src="/js/ie10-viewport-bug-workaround.js"></script>
		<script>
			var $event = $.event,
			$special,
			resizeTimeout;
			$special = $event.special.debouncedresize = {
				setup: function() {
					$( this ).on( "resize", $special.handler );
				},
				teardown: function() {
					$( this ).off( "resize", $special.handler );
				},
				handler: function( event, execAsap ) {
					var context = this,
						args = arguments,
						dispatch = function() {
							event.type = "debouncedresize";
							$event.dispatch.apply( context, args );
						};
					if ( resizeTimeout ) {
						clearTimeout( resizeTimeout );
					}
					execAsap ?
						dispatch() :
						resizeTimeout = setTimeout( dispatch, $special.threshold );
				},
				threshold: 250
			};
			var BLANK = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
			$.fn.imagesLoaded = function( callback ) {
				var $this = this,
					deferred = $.isFunction($.Deferred) ? $.Deferred() : 0,
					hasNotify = $.isFunction(deferred.notify),
					$images = $this.find('img').add( $this.filter('img') ),
					loaded = [],
					proper = [],
					broken = [];
				if ($.isPlainObject(callback)) {
					$.each(callback, function (key, value) {
						if (key === 'callback') {
							callback = value;
						} else if (deferred) {
							deferred[key](value);
						}
					});
				}
				function doneLoading() {
					var $proper = $(proper),
						$broken = $(broken);
					if ( deferred ) {
						if ( broken.length ) {
							deferred.reject( $images, $proper, $broken );
						} else {
							deferred.resolve( $images );
						}
					}
					if ( $.isFunction( callback ) ) {
						callback.call( $this, $images, $proper, $broken );
					}
				}
				function imgLoaded( img, isBroken ) {
					if ( img.src === BLANK || $.inArray( img, loaded ) !== -1 ) {
						return;
					}
					loaded.push( img );
					if ( isBroken ) {
						broken.push( img );
					} else {
						proper.push( img );
					}
					$.data( img, 'imagesLoaded', { isBroken: isBroken, src: img.src } );
					if ( hasNotify ) {
						deferred.notifyWith( $(img), [ isBroken, $images, $(proper), $(broken) ] );
					}
					if ( $images.length === loaded.length ){
						setTimeout( doneLoading );
						$images.unbind( '.imagesLoaded' );
					}
				}
				if ( !$images.length ) {
					doneLoading();
				} else {
					$images.bind( 'load.imagesLoaded error.imagesLoaded', function( event ){
						imgLoaded( event.target, event.type === 'error' );
					}).each( function( i, el ) {
						var src = el.src;
						var cached = $.data( el, 'imagesLoaded' );
						if ( cached && cached.src === src ) {
							imgLoaded( el, cached.isBroken );
							return;
						}
						if ( el.complete && el.naturalWidth !== undefined ) {
							imgLoaded( el, el.naturalWidth === 0 || el.naturalHeight === 0 );
							return;
						}
						if ( el.readyState || el.complete ) {
							el.src = BLANK;
							el.src = src;
						}
					});
				}
				return deferred ? deferred.promise( $this ) : $this;
			};
			var Grid = (function() {
				var $grid = $( '#og-grid' ),
					$items = $grid.children( 'li' ),
					current = -1,
					previewPos = -1,
					scrollExtra = 0,
					marginExpanded = 10,
					$window = $( window ), winsize,
					$body = $( 'html, body' ),
					transEndEventNames = {
						'WebkitTransition' : 'webkitTransitionEnd',
						'MozTransition' : 'transitionend',
						'OTransition' : 'oTransitionEnd',
						'msTransition' : 'MSTransitionEnd',
						'transition' : 'transitionend'
					},
					transEndEventName = transEndEventNames[ Modernizr.prefixed( 'transition' ) ],
					support = Modernizr.csstransitions,
					settings = {
						minHeight : 500,
						speed : 350,
						easing : 'ease'
					};
				function init( config ) {
					
					settings = $.extend( true, {}, settings, config );
					$grid.imagesLoaded( function() {
						saveItemInfo( true );
						getWinSize();
						initEvents();
					} );
				}
				function addItems( $newitems ) {
					$items = $items.add( $newitems );
					$newitems.each( function() {
						var $item = $( this );
						$item.data( {
							offsetTop : $item.offset().top,
							height : $item.height()
						} );
					} );
					initItemsEvents( $newitems );
				}
				function saveItemInfo( saveheight ) {
					$items.each( function() {
						var $item = $( this );
						$item.data( 'offsetTop', $item.offset().top );
						if( saveheight ) {
							$item.data( 'height', $item.height() );
						}
					} );
				}
				function initEvents() {
					
					initItemsEvents( $items );
					
					$window.on( 'debouncedresize', function() {
						
						scrollExtra = 0;
						previewPos = -1;
						saveItemInfo();
						getWinSize();
						var preview = $.data( this, 'preview' );
						if( typeof preview != 'undefined' ) {
							hidePreview();
						}
					} );
				}
				function initItemsEvents( $items ) {
					$items.on( 'click', 'span.og-close', function() {
						hidePreview();
						return false;
					} ).children( 'a' ).on( 'click', function(e) {
						var $item = $( this ).parent();
						current === $item.index() ? hidePreview() : showPreview( $item );
						return false;
					} );
				}
				function getWinSize() {
					winsize = { width : $window.width(), height : $window.height() };
				}
				function showPreview( $item ) {
					var preview = $.data( this, 'preview' ),
						position = $item.data( 'offsetTop' );
					scrollExtra = 0;
					if( typeof preview != 'undefined' ) {
						if( previewPos !== position ) {
							if( position > previewPos ) {
								scrollExtra = preview.height;
							}
							hidePreview();
						}
						else {
							preview.update( $item );
							return false;
						}
						
					}
					previewPos = position;
					preview = $.data( this, 'preview', new Preview( $item ) );
					preview.open();
				}
				function hidePreview() {
					current = -1;
					var preview = $.data( this, 'preview' );
					preview.close();
					$.removeData( this, 'preview' );
				}
				function Preview( $item ) {
					this.$item = $item;
					this.expandedIdx = this.$item.index();
					this.create();
					this.update();
				}
				Preview.prototype = {
					create : function() {
						this.$title = $( '<h3></h3>' );
						this.$description = $( '<p></p>' );
						this.$href = $( '<a href="#"></a>' );
						this.$details = $( '<div class="og-details"></div>' ).append( this.$title, this.$description, this.$href );
						this.$loading = $( '<div class="og-loading"></div>' );
						this.$fullimage = $( '<div class="og-fullimg"></div>' ).append( this.$loading );
						this.$closePreview = $( '<span class="og-close"></span>' );
						this.$previewInner = $( '<div class="og-expander-inner"></div>' ).append( this.$closePreview, this.$fullimage, this.$details );
						this.$previewEl = $( '<div class="og-expander"></div>' ).append( this.$previewInner );
						this.$item.append( this.getEl() );
						if( support ) {
							this.setTransition();
						}
					},
					update : function( $item ) {
						if( $item ) {
							this.$item = $item;
						}
						
						if( current !== -1 ) {
							var $currentItem = $items.eq( current );
							$currentItem.removeClass( 'og-expanded' );
							this.$item.addClass( 'og-expanded' );
							this.positionPreview();
						}
						current = this.$item.index();
						var $itemEl = this.$item.children( 'a' ),
							eldata = {
								href : $itemEl.attr( 'href' ),
								largesrc : $itemEl.data( 'largesrc' ),
								title : $itemEl.data( 'title' ),
								description : $itemEl.data( 'description' )
							};
						this.$title.html( eldata.title );
						this.$description.html( eldata.description );
						this.$href.attr( 'href', eldata.href );
						var self = this;
						
						if( typeof self.$largeImg != 'undefined' ) {
							self.$largeImg.remove();
						}
						if( self.$fullimage.is( ':visible' ) ) {
							this.$loading.show();
							$( '<img/>' ).load( function() {
								var $img = $( this );
								if( $img.attr( 'src' ) === self.$item.children('a').data( 'largesrc' ) ) {
									self.$loading.hide();
									self.$fullimage.find( 'img' ).remove();
									self.$largeImg = $img.fadeIn( 350 );
									self.$fullimage.append( self.$largeImg );
								}
							} ).attr( 'src', eldata.largesrc );	
						}
					},
					open : function() {
						setTimeout( $.proxy( function() {	
							this.setHeights();
							this.positionPreview();
						}, this ), 25 );
					},
					close : function() {
						var self = this,
							onEndFn = function() {
								if( support ) {
									$( this ).off( transEndEventName );
								}
								self.$item.removeClass( 'og-expanded' );
								self.$previewEl.remove();
							};
						setTimeout( $.proxy( function() {
							if( typeof this.$largeImg !== 'undefined' ) {
								this.$largeImg.fadeOut( 'fast' );
							}
							this.$previewEl.css( 'height', 0 );
							var $expandedItem = $items.eq( this.expandedIdx );
							$expandedItem.css( 'height', $expandedItem.data( 'height' ) ).on( transEndEventName, onEndFn );
							if( !support ) {
								onEndFn.call();
							}
						}, this ), 25 );
						
						return false;
					},
					calcHeight : function() {
						var heightPreview = winsize.height - this.$item.data( 'height' ) - marginExpanded,
							itemHeight = winsize.height;
						if( heightPreview < settings.minHeight ) {
							heightPreview = settings.minHeight;
							itemHeight = settings.minHeight + this.$item.data( 'height' ) + marginExpanded;
						}
						this.height = heightPreview;
						this.itemHeight = itemHeight;
					},
					setHeights : function() {
						var self = this,
							onEndFn = function() {
								if( support ) {
									self.$item.off( transEndEventName );
								}
								self.$item.addClass( 'og-expanded' );
							};
						this.calcHeight();
						this.$previewEl.css( 'height', this.height );
						this.$item.css( 'height', this.itemHeight ).on( transEndEventName, onEndFn );
						if( !support ) {
							onEndFn.call();
						}
					},
					positionPreview : function() {
						var position = this.$item.data( 'offsetTop' ),
							previewOffsetT = this.$previewEl.offset().top - scrollExtra,
							scrollVal = this.height + this.$item.data( 'height' ) + marginExpanded <= winsize.height ? position : this.height < winsize.height ? previewOffsetT - ( winsize.height - this.height ) : previewOffsetT;
						
						$body.animate( { scrollTop : scrollVal }, settings.speed );
					},
					setTransition  : function() {
						this.$previewEl.css( 'transition', 'height ' + settings.speed + 'ms ' + settings.easing );
						this.$item.css( 'transition', 'height ' + settings.speed + 'ms ' + settings.easing );
					},
					getEl : function() {
						return this.$previewEl;
					}
				}
				return { 
					init : init,
					addItems : addItems
				};
			})();
		</script>
		<script>
			$(function() {
				Grid.init();
			});
		</script>
</body>
</html>

